module.exports=glob;var fs=require("fs");var rp=require("fs.realpath");var minimatch=require("minimatch");var Minimatch=minimatch.Minimatch;var inherits=require("inherits");var EE=require("events").EventEmitter;var path=require("path");var assert=require("assert");var isAbsolute=require("path-is-absolute");var globSync=require("./sync.js");var common=require("./common.js");var alphasort=common.alphasort;var alphasorti=common.alphasorti;var setopts=common.setopts;var ownProp=common.ownProp;var inflight=require("inflight");var util=require("util");var childrenIgnored=common.childrenIgnored;var isIgnored=common.isIgnored;var once=require("once");function glob(c,b,a){if(typeof b==="function"){a=b,b={}}if(!b){b={}}if(b.sync){if(a){throw new TypeError("callback provided to sync glob")}return globSync(c,b)}return new Glob(c,b,a)}glob.sync=globSync;var GlobSync=glob.GlobSync=globSync.GlobSync;glob.glob=glob;function extend(a,d){if(d===null||typeof d!=="object"){return a}var c=Object.keys(d);var b=c.length;while(b--){a[c[b]]=d[c[b]]}return a}glob.hasMagic=function(d,e){var b=extend({},e);b.noprocess=true;var c=new Glob(d,b);var f=c.minimatch.set;if(!d){return false}if(f.length>1){return true}for(var a=0;a<f[0].length;a++){if(typeof f[0][a]!=="string"){return true}}return false};glob.Glob=Glob;inherits(Glob,EE);function Glob(g,d,a){if(typeof d==="function"){a=d;d=null}if(d&&d.sync){if(a){throw new TypeError("callback provided to sync glob")}return new GlobSync(g,d)}if(!(this instanceof Glob)){return new Glob(g,d,a)}setopts(this,g,d);this._didRealPath=false;var h=this.minimatch.set.length;this.matches=new Array(h);if(typeof a==="function"){a=once(a);this.on("error",a);this.on("end",function(i){a(null,i)})}var c=this;var h=this.minimatch.set.length;this._processing=0;this.matches=new Array(h);this._emitQueue=[];this._processQueue=[];this.paused=false;if(this.noprocess){return this}if(h===0){return b()}var f=true;for(var e=0;e<h;e++){this._process(this.minimatch.set[e],e,false,b)}f=false;function b(){--c._processing;if(c._processing<=0){if(f){process.nextTick(function(){c._finish()})}else{c._finish()}}}}Glob.prototype._finish=function(){assert(this instanceof Glob);if(this.aborted){return}if(this.realpath&&!this._didRealpath){return this._realpath()}common.finish(this);this.emit("end",this.found)};Glob.prototype._realpath=function(){if(this._didRealpath){return}this._didRealpath=true;var d=this.matches.length;if(d===0){return this._finish()}var a=this;for(var b=0;b<this.matches.length;b++){this._realpathSet(b,c)}function c(){if(--d===0){a._finish()}}};Glob.prototype._realpathSet=function(c,a){var d=this.matches[c];if(!d){return a()}var e=Object.keys(d);var b=this;var g=e.length;if(g===0){return a()}var f=this.matches[c]=Object.create(null);e.forEach(function(j,h){j=b._makeAbs(j);rp.realpath(j,b.realpathCache,function(k,i){if(!k){f[i]=true}else{if(k.syscall==="stat"){f[j]=true}else{b.emit("error",k)}}if(--g===0){b.matches[c]=f;a()}})})};Glob.prototype._mark=function(a){return common.mark(this,a)};Glob.prototype._makeAbs=function(a){return common.makeAbs(this,a)};Glob.prototype.abort=function(){this.aborted=true;this.emit("abort")};Glob.prototype.pause=function(){if(!this.paused){this.paused=true;this.emit("pause")}};Glob.prototype.resume=function(){if(this.paused){this.emit("resume");this.paused=false;if(this._emitQueue.length){var b=this._emitQueue.slice(0);this._emitQueue.length=0;for(var c=0;c<b.length;c++){var f=b[c];this._emitMatch(f[0],f[1])}}if(this._processQueue.length){var a=this._processQueue.slice(0);this._processQueue.length=0;for(var c=0;c<a.length;c++){var d=a[c];this._processing--;this._process(d[0],d[1],d[2],d[3])}}}};Glob.prototype._process=function(h,g,i,d){assert(this instanceof Glob);assert(typeof d==="function");if(this.aborted){return}this._processing++;if(this.paused){this._processQueue.push([h,g,i,d]);return}var c=0;while(typeof h[c]==="string"){c++}var f;switch(c){case h.length:this._processSimple(h.join("/"),g,d);return;case 0:f=null;break;default:f=h.slice(0,c).join("/");break}var e=h.slice(c);var a;if(f===null){a="."}else{if(isAbsolute(f)||isAbsolute(h.join("/"))){if(!f||!isAbsolute(f)){f="/"+f}a=f}else{a=f}}var j=this._makeAbs(a);if(childrenIgnored(this,a)){return d()}var b=e[0]===minimatch.GLOBSTAR;if(b){this._processGlobStar(f,a,j,e,g,i,d)}else{this._processReaddir(f,a,j,e,g,i,d)}};Glob.prototype._processReaddir=function(g,f,b,h,e,d,a){var c=this;this._readdir(b,d,function(j,i){return c._processReaddir2(g,f,b,h,e,d,i,a)})};Glob.prototype._processReaddir2=function(o,p,j,k,f,b,h,l){if(!h){return l()}var s=k[0];var d=!!this.minimatch.negate;var g=s._glob;var a=this.dot||g.charAt(0)===".";var c=[];for(var q=0;q<h.length;q++){var t=h[q];if(t.charAt(0)!=="."||a){var n;if(d&&!o){n=!t.match(s)}else{n=t.match(s)}if(n){c.push(t)}}}var r=c.length;if(r===0){return l()}if(k.length===1&&!this.mark&&!this.stat){if(!this.matches[f]){this.matches[f]=Object.create(null)}for(var q=0;q<r;q++){var t=c[q];if(o){if(o!=="/"){t=o+"/"+t}else{t=o+t}}if(t.charAt(0)==="/"&&!this.nomount){t=path.join(this.root,t)}this._emitMatch(f,t)}return l()}k.shift();for(var q=0;q<r;q++){var t=c[q];var u;if(o){if(o!=="/"){t=o+"/"+t}else{t=o+t}}this._process([t].concat(k),f,b,l)}l()};Glob.prototype._emitMatch=function(d,f){if(this.aborted){return}if(isIgnored(this,f)){return}if(this.paused){this._emitQueue.push([d,f]);return}var a=isAbsolute(f)?f:this._makeAbs(f);if(this.mark){f=this._mark(f)}if(this.absolute){f=a}if(this.matches[d][f]){return}if(this.nodir){var g=this.cache[a];if(g==="DIR"||Array.isArray(g)){return}}this.matches[d][f]=true;var b=this.statCache[a];if(b){this.emit("stat",f,b)}this.emit("match",f)};Glob.prototype._readdirInGlobStar=function(b,a){if(this.aborted){return}if(this.follow){return this._readdir(b,false,a)}var c="lstat\0"+b;var e=this;var d=inflight(c,f);if(d){fs.lstat(b,d)}function f(i,g){if(i&&i.code==="ENOENT"){return a()}var h=g&&g.isSymbolicLink();e.symlinks[b]=h;if(!h&&g&&!g.isDirectory()){e.cache[b]="FILE";a()}else{e._readdir(b,false,a)}}};Glob.prototype._readdir=function(b,e,a){if(this.aborted){return}a=inflight("readdir\0"+b+"\0"+e,a);if(!a){return}if(e&&!ownProp(this.symlinks,b)){return this._readdirInGlobStar(b,a)}if(ownProp(this.cache,b)){var f=this.cache[b];if(!f||f==="FILE"){return a()}if(Array.isArray(f)){return a(null,f)}}var d=this;fs.readdir(b,readdirCb(this,b,a))};function readdirCb(c,b,a){return function(e,d){if(e){c._readdirError(b,e,a)}else{c._readdirEntries(b,d,a)}}}Glob.prototype._readdirEntries=function(c,b,a){if(this.aborted){return}if(!this.mark&&!this.stat){for(var d=0;d<b.length;d++){var f=b[d];if(c==="/"){f=c+f}else{f=c+"/"+f}this.cache[f]=true}}this.cache[c]=b;return a(null,b)};Glob.prototype._readdirError=function(d,e,b){if(this.aborted){return}switch(e.code){case"ENOTSUP":case"ENOTDIR":var a=this._makeAbs(d);this.cache[a]="FILE";if(a===this.cwdAbs){var c=new Error(e.code+" invalid cwd "+this.cwd);c.path=this.cwd;c.code=e.code;this.emit("error",c);this.abort()}break;case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[this._makeAbs(d)]=false;break;default:this.cache[this._makeAbs(d)]=false;if(this.strict){this.emit("error",e);this.abort()}if(!this.silent){console.error("glob error",e)}break}return b()};Glob.prototype._processGlobStar=function(g,f,b,h,e,d,a){var c=this;this._readdir(b,d,function(j,i){c._processGlobStar2(g,f,b,h,e,d,i,a)})};Glob.prototype._processGlobStar2=function(l,b,s,k,n,r,h,f){if(!h){return f()}var d=k.slice(1);var p=l?[l]:[];var j=p.concat(d);this._process(j,n,false,f);var a=this.symlinks[s];var m=h.length;if(a&&r){return f()}for(var g=0;g<m;g++){var o=h[g];if(o.charAt(0)==="."&&!this.dot){continue}var c=p.concat(h[g],d);this._process(c,n,true,f);var q=p.concat(h[g],k);this._process(q,n,true,f)}f()};Glob.prototype._processSimple=function(d,c,a){var b=this;this._stat(d,function(f,e){b._processSimple2(d,c,f,e,a)})};Glob.prototype._processSimple2=function(e,c,f,d,a){if(!this.matches[c]){this.matches[c]=Object.create(null)}if(!d){return a()}if(e&&isAbsolute(e)&&!this.nomount){var b=/[\/\\]$/.test(e);if(e.charAt(0)==="/"){e=path.join(this.root,e)}else{e=path.resolve(this.root,e);if(b){e+="/"}}}if(process.platform==="win32"){e=e.replace(/\\/g,"/")}this._emitMatch(c,e);a()};Glob.prototype._stat=function(g,b){var m=this._makeAbs(g);var l=g.slice(-1)==="/";if(g.length>this.maxLength){return b()}if(!this.stat&&ownProp(this.cache,m)){var h=this.cache[m];if(Array.isArray(h)){h="DIR"}if(!l||h==="DIR"){return b(null,h)}if(l&&h==="FILE"){return b()}}var j;var e=this.statCache[m];if(e!==undefined){if(e===false){return b(null,e)}else{var i=e.isDirectory()?"DIR":"FILE";if(l&&i==="FILE"){return b()}else{return b(null,i,e)}}}var k=this;var d=inflight("stat\0"+m,a);if(d){fs.lstat(m,d)}function a(f,c){if(c&&c.isSymbolicLink()){return fs.stat(m,function(o,n){if(o){k._stat2(g,m,null,c,b)}else{k._stat2(g,m,o,n,b)}})}else{k._stat2(g,m,f,c,b)}}};Glob.prototype._stat2=function(e,b,i,d,a){if(i&&(i.code==="ENOENT"||i.code==="ENOTDIR")){this.statCache[b]=false;return a()}var h=e.slice(-1)==="/";this.statCache[b]=d;if(b.slice(-1)==="/"&&d&&!d.isDirectory()){return a(null,false,d)}var g=true;if(d){g=d.isDirectory()?"DIR":"FILE"}this.cache[b]=this.cache[b]||g;if(h&&g==="FILE"){return a()}return a(null,g,d)};