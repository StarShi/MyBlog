var fs=require("fs"),WritableStream=require("stream").Writable||require("readable-stream").Writable,inherits=require("util").inherits;var parseParams=require("./utils").parseParams;function Busboy(a){if(!(this instanceof Busboy)){return new Busboy(a)}if(a.highWaterMark!==undefined){WritableStream.call(this,{highWaterMark:a.highWaterMark})}else{WritableStream.call(this)}this._done=false;this._parser=undefined;this._finished=false;this.opts=a;if(a.headers&&typeof a.headers["content-type"]==="string"){this.parseHeaders(a.headers)}else{throw new Error("Missing Content-Type")}}inherits(Busboy,WritableStream);Busboy.prototype.emit=function(a){if(a==="finish"){if(!this._done){this._parser&&this._parser.end();return}else{if(this._finished){return}}this._finished=true}WritableStream.prototype.emit.apply(this,arguments)};Busboy.prototype.parseHeaders=function(f){this._parser=undefined;if(f["content-type"]){var c=parseParams(f["content-type"]),a,e;for(var d=0;d<TYPES.length;++d){e=TYPES[d];if(typeof e.detect==="function"){a=e.detect(c)}else{a=e.detect.test(c[0])}if(a){break}}if(a){var b={limits:this.opts.limits,headers:f,parsedConType:c,highWaterMark:undefined,fileHwm:undefined,defCharset:undefined,preservePath:false};if(this.opts.highWaterMark){b.highWaterMark=this.opts.highWaterMark}if(this.opts.fileHwm){b.fileHwm=this.opts.fileHwm}b.defCharset=this.opts.defCharset;b.preservePath=this.opts.preservePath;this._parser=e(this,b);return}}throw new Error("Unsupported content type: "+f["content-type"])};Busboy.prototype._write=function(b,c,a){if(!this._parser){return a(new Error("Not ready to parse. Missing Content-Type?"))}this._parser.write(b,a)};var TYPES=[require("./types/multipart"),require("./types/urlencoded")];module.exports=Busboy;