var ReadableStream=require("stream").Readable||require("readable-stream"),inherits=require("util").inherits;var Dicer=require("dicer");var parseParams=require("../utils").parseParams,decodeText=require("../utils").decodeText,basename=require("../utils").basename;var RE_BOUNDARY=/^boundary$/i,RE_FIELD=/^form-data$/i,RE_CHARSET=/^charset$/i,RE_FILENAME=/^filename$/i,RE_NAME=/^name$/i;Multipart.detect=/^multipart\/form-data/i;function Multipart(o,g){if(!(this instanceof Multipart)){return new Multipart(o,g)}var v,w,q=this,x,l=g.limits,r=g.parsedConType||[],t=g.defCharset||"utf8",n=g.preservePath,d=(typeof g.fileHwm==="number"?{highWaterMark:g.fileHwm}:{});for(v=0,w=r.length;v<w;++v){if(Array.isArray(r[v])&&RE_BOUNDARY.test(r[v][0])){x=r[v][1];break}}function e(){if(j===0&&h&&!o._done){h=false;process.nextTick(function(){o._done=true;o.emit("finish")})}}if(typeof x!=="string"){throw new Error("Multipart: Boundary not found")}var f=(l&&typeof l.fieldSize==="number"?l.fieldSize:1*1024*1024),s=(l&&typeof l.fileSize==="number"?l.fileSize:Infinity),k=(l&&typeof l.files==="number"?l.files:Infinity),y=(l&&typeof l.fields==="number"?l.fields:Infinity),b=(l&&typeof l.parts==="number"?l.parts:Infinity);var u=0,a=0,j=0,z,c,h=false;this._needDrain=false;this._pause=false;this._cb=undefined;this._nparts=0;this._boy=o;var p={boundary:x,maxHeaderPairs:(l&&l.headerPairs)};if(d.highWaterMark){p.partHwm=d.highWaterMark}if(g.highWaterMark){p.highWaterMark=g.highWaterMark}this.parser=new Dicer(p);this.parser.on("drain",function(){q._needDrain=false;if(q._cb&&!q._pause){var i=q._cb;q._cb=undefined;i()}}).on("part",function m(i){if(++q._nparts>b){q.parser.removeListener("part",m);q.parser.on("part",skipPart);o.hitPartsLimit=true;o.emit("partsLimit");return skipPart(i)}if(c){var A=c;A.emit("end");A.removeAllListeners("end")}i.on("header",function(J){var N,K,M,G,D,C,I=0;if(J["content-type"]){M=parseParams(J["content-type"][0]);if(M[0]){N=M[0].toLowerCase();for(v=0,w=M.length;v<w;++v){if(RE_CHARSET.test(M[v][0])){G=M[v][1].toLowerCase();break}}}}if(N===undefined){N="text/plain"}if(G===undefined){G=t}if(J["content-disposition"]){M=parseParams(J["content-disposition"][0]);if(!RE_FIELD.test(M[0])){return skipPart(i)}for(v=0,w=M.length;v<w;++v){if(RE_NAME.test(M[v][0])){K=decodeText(M[v][1],"binary","utf8")}else{if(RE_FILENAME.test(M[v][0])){C=decodeText(M[v][1],"binary","utf8");if(!n){C=basename(C)}}}}}else{return skipPart(i)}if(J["content-transfer-encoding"]){D=J["content-transfer-encoding"][0].toLowerCase()}else{D="7bit"}var F,B;if(N==="application/octet-stream"||C!==undefined){if(u===k){if(!o.hitFilesLimit){o.hitFilesLimit=true;o.emit("filesLimit")}return skipPart(i)}++u;if(!o._events.file){q.parser._ignore();return}++j;var E=new FileStream(d);z=E;E.on("end",function(){--j;e();if(q._cb&&!q._needDrain){var O=q._cb;q._cb=undefined;O()}});E._read=function(P){if(!q._pause){return}q._pause=false;if(q._cb&&!q._needDrain){var O=q._cb;q._cb=undefined;O()}};o.emit("file",K,E,C,D,N);F=function(O){if((I+=O.length)>s){var P=(s-(I-O.length));if(P>0){E.push(O.slice(0,P))}E.emit("limit");E.truncated=true;i.removeAllListeners("data")}else{if(!E.push(O)){q._pause=true}}};B=function(){z=undefined;E.push(null)}}else{if(a===y){if(!o.hitFieldsLimit){o.hitFieldsLimit=true;o.emit("fieldsLimit")}return skipPart(i)}++a;++j;var H="",L=false;c=i;F=function(O){if((I+=O.length)>f){var P=(f-(I-O.length));H+=O.toString("binary",0,P);L=true;i.removeAllListeners("data")}else{H+=O.toString("binary")}};B=function(){c=undefined;if(H.length){H=decodeText(H,"binary",G)}o.emit("field",K,H,false,L,D,N);--j;e()}}i._readableState.sync=false;i.on("data",F);i.on("end",B)}).on("error",function(B){if(z){z.emit("error",B)}})}).on("error",function(i){o.emit("error",i)}).on("finish",function(){h=true;e()})}Multipart.prototype.write=function(b,a){var c;if((c=this.parser.write(b))&&!this._pause){a()}else{this._needDrain=!c;this._cb=a}};Multipart.prototype.end=function(){var a=this;if(this._nparts===0&&!a._boy._done){process.nextTick(function(){a._boy._done=true;a._boy.emit("finish")})}else{if(this.parser.writable){this.parser.end()}}};function skipPart(a){a.resume()}function FileStream(a){if(!(this instanceof FileStream)){return new FileStream(a)}ReadableStream.call(this,a);this.truncated=false}inherits(FileStream,ReadableStream);FileStream.prototype._read=function(a){};module.exports=Multipart;