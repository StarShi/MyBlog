var Decoder=require("../utils").Decoder,decodeText=require("../utils").decodeText;var RE_CHARSET=/^charset$/i;UrlEncoded.detect=/^application\/x-www-form-urlencoded/i;function UrlEncoded(e,b){if(!(this instanceof UrlEncoded)){return new UrlEncoded(e,b)}var c=b.limits,g=b.headers,f=b.parsedConType;this.boy=e;this.fieldSizeLimit=(c&&typeof c.fieldSize==="number"?c.fieldSize:1*1024*1024);this.fieldNameSizeLimit=(c&&typeof c.fieldNameSize==="number"?c.fieldNameSize:100);this.fieldsLimit=(c&&typeof c.fields==="number"?c.fields:Infinity);var h;for(var d=0,a=f.length;d<a;++d){if(Array.isArray(f[d])&&RE_CHARSET.test(f[d][0])){h=f[d][1].toLowerCase();break}}if(h===undefined){h=b.defCharset||"utf8"}this.decoder=new Decoder();this.charset=h;this._fields=0;this._state="key";this._checkingBytes=true;this._bytesKey=0;this._bytesVal=0;this._key="";this._val="";this._keyTrunc=false;this._valTrunc=false;this._hitlimit=false}UrlEncoded.prototype.write=function(c,b){if(this._fields===this.fieldsLimit){if(!this.boy.hitFieldsLimit){this.boy.hitFieldsLimit=true;this.boy.emit("fieldsLimit")}return b()}var h,e,d,a=0,f=c.length;while(a<f){if(this._state==="key"){h=e=undefined;for(d=a;d<f;++d){if(!this._checkingBytes){++a}if(c[d]===61){h=d;break}else{if(c[d]===38){e=d;break}}if(this._checkingBytes&&this._bytesKey===this.fieldNameSizeLimit){this._hitLimit=true;break}else{if(this._checkingBytes){++this._bytesKey}}}if(h!==undefined){if(h>a){this._key+=this.decoder.write(c.toString("binary",a,h))}this._state="val";this._hitLimit=false;this._checkingBytes=true;this._val="";this._bytesVal=0;this._valTrunc=false;this.decoder.reset();a=h+1}else{if(e!==undefined){++this._fields;var j,g=this._keyTrunc;if(e>a){j=(this._key+=this.decoder.write(c.toString("binary",a,e)))}else{j=this._key}this._hitLimit=false;this._checkingBytes=true;this._key="";this._bytesKey=0;this._keyTrunc=false;this.decoder.reset();if(j.length){this.boy.emit("field",decodeText(j,"binary",this.charset),"",g,false)}a=e+1;if(this._fields===this.fieldsLimit){return b()}}else{if(this._hitLimit){if(d>a){this._key+=this.decoder.write(c.toString("binary",a,d))}a=d;if((this._bytesKey=this._key.length)===this.fieldNameSizeLimit){this._checkingBytes=false;this._keyTrunc=true}}else{if(a<f){this._key+=this.decoder.write(c.toString("binary",a))}a=f}}}}else{e=undefined;for(d=a;d<f;++d){if(!this._checkingBytes){++a}if(c[d]===38){e=d;break}if(this._checkingBytes&&this._bytesVal===this.fieldSizeLimit){this._hitLimit=true;break}else{if(this._checkingBytes){++this._bytesVal}}}if(e!==undefined){++this._fields;if(e>a){this._val+=this.decoder.write(c.toString("binary",a,e))}this.boy.emit("field",decodeText(this._key,"binary",this.charset),decodeText(this._val,"binary",this.charset),this._keyTrunc,this._valTrunc);this._state="key";this._hitLimit=false;this._checkingBytes=true;this._key="";this._bytesKey=0;this._keyTrunc=false;this.decoder.reset();a=e+1;if(this._fields===this.fieldsLimit){return b()}}else{if(this._hitLimit){if(d>a){this._val+=this.decoder.write(c.toString("binary",a,d))}a=d;if((this._val===""&&this.fieldSizeLimit===0)||(this._bytesVal=this._val.length)===this.fieldSizeLimit){this._checkingBytes=false;this._valTrunc=true}}else{if(a<f){this._val+=this.decoder.write(c.toString("binary",a))}a=f}}}}b()};UrlEncoded.prototype.end=function(){if(this.boy._done){return}if(this._state==="key"&&this._key.length>0){this.boy.emit("field",decodeText(this._key,"binary",this.charset),"",this._keyTrunc,false)}else{if(this._state==="val"){this.boy.emit("field",decodeText(this._key,"binary",this.charset),decodeText(this._val,"binary",this.charset),this._keyTrunc,this._valTrunc)}}this.boy._done=true;this.boy.emit("finish")};module.exports=UrlEncoded;