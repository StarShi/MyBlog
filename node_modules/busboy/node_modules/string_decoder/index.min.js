var Buffer=require("buffer").Buffer;var isBufferEncoding=Buffer.isEncoding||function(a){switch(a&&a.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return true;default:return false}};function assertEncoding(a){if(a&&!isBufferEncoding(a)){throw new Error("Unknown encoding: "+a)}}var StringDecoder=exports.StringDecoder=function(a){this.encoding=(a||"utf8").toLowerCase().replace(/[-_]/,"");assertEncoding(a);switch(this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2;this.detectIncompleteChar=utf16DetectIncompleteChar;break;case"base64":this.surrogateSize=3;this.detectIncompleteChar=base64DetectIncompleteChar;break;default:this.write=passThroughWrite;return}this.charBuffer=new Buffer(6);this.charReceived=0;this.charLength=0};StringDecoder.prototype.write=function(c){var e="";while(this.charLength){var f=(c.length>=this.charLength-this.charReceived)?this.charLength-this.charReceived:c.length;c.copy(this.charBuffer,this.charReceived,0,f);this.charReceived+=f;if(this.charReceived<this.charLength){return""}c=c.slice(f,c.length);e=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var b=e.charCodeAt(e.length-1);if(b>=55296&&b<=56319){this.charLength+=this.surrogateSize;e="";continue}this.charReceived=this.charLength=0;if(c.length===0){return e}break}this.detectIncompleteChar(c);var a=c.length;if(this.charLength){c.copy(this.charBuffer,0,c.length-this.charReceived,a);a-=this.charReceived}e+=c.toString(this.encoding,0,a);var a=e.length-1;var b=e.charCodeAt(a);if(b>=55296&&b<=56319){var d=this.surrogateSize;this.charLength+=d;this.charReceived+=d;this.charBuffer.copy(this.charBuffer,d,0,d);c.copy(this.charBuffer,0,0,d);return e.substring(0,a)}return e};StringDecoder.prototype.detectIncompleteChar=function(a){var b=(a.length>=3)?3:a.length;for(;b>0;b--){var d=a[a.length-b];if(b==1&&d>>5==6){this.charLength=2;break}if(b<=2&&d>>4==14){this.charLength=3;break}if(b<=3&&d>>3==30){this.charLength=4;break}}this.charReceived=b};StringDecoder.prototype.end=function(a){var d="";if(a&&a.length){d=this.write(a)}if(this.charReceived){var e=this.charReceived;var c=this.charBuffer;var b=this.encoding;d+=c.slice(0,e).toString(b)}return d};function passThroughWrite(a){return a.toString(this.encoding)}function utf16DetectIncompleteChar(a){this.charReceived=a.length%2;this.charLength=this.charReceived?2:0}function base64DetectIncompleteChar(a){this.charReceived=a.length%3;this.charLength=this.charReceived?3:0};