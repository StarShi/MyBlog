module.exports=Writable;var Buffer=require("buffer").Buffer;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var Stream=require("stream");util.inherits(Writable,Stream);function WriteReq(b,c,a){this.chunk=b;this.encoding=c;this.callback=a}function WritableState(b,e){var a=require("./_stream_duplex");b=b||{};var d=b.highWaterMark;var f=b.objectMode?16:16*1024;this.highWaterMark=(d||d===0)?d:f;this.objectMode=!!b.objectMode;if(e instanceof a){this.objectMode=this.objectMode||!!b.writableObjectMode}this.highWaterMark=~~this.highWaterMark;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;var c=b.decodeStrings===false;this.decodeStrings=!c;this.defaultEncoding=b.defaultEncoding||"utf8";this.length=0;this.writing=false;this.corked=0;this.sync=true;this.bufferProcessing=false;this.onwrite=function(g){onwrite(e,g)};this.writecb=null;this.writelen=0;this.buffer=[];this.pendingcb=0;this.prefinished=false;this.errorEmitted=false}function Writable(b){var a=require("./_stream_duplex");if(!(this instanceof Writable)&&!(this instanceof a)){return new Writable(b)}this._writableState=new WritableState(b,this);this.writable=true;Stream.call(this)}Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))};function writeAfterEnd(c,b,a){var d=new Error("write after end");c.emit("error",d);process.nextTick(function(){a(d)})}function validChunk(e,d,b,a){var c=true;if(!util.isBuffer(b)&&!util.isString(b)&&!util.isNullOrUndefined(b)&&!d.objectMode){var f=new TypeError("Invalid non-string/buffer chunk");e.emit("error",f);process.nextTick(function(){a(f)});c=false}return c}Writable.prototype.write=function(c,d,a){var e=this._writableState;var b=false;if(util.isFunction(d)){a=d;d=null}if(util.isBuffer(c)){d="buffer"}else{if(!d){d=e.defaultEncoding}}if(!util.isFunction(a)){a=function(){}}if(e.ended){writeAfterEnd(this,e,a)}else{if(validChunk(this,e,c,a)){e.pendingcb++;b=writeOrBuffer(this,e,c,d,a)}}return b};Writable.prototype.cork=function(){var a=this._writableState;a.corked++};Writable.prototype.uncork=function(){var a=this._writableState;if(a.corked){a.corked--;if(!a.writing&&!a.corked&&!a.finished&&!a.bufferProcessing&&a.buffer.length){clearBuffer(this,a)}}};function decodeChunk(c,a,b){if(!c.objectMode&&c.decodeStrings!==false&&util.isString(a)){a=new Buffer(a,b)}return a}function writeOrBuffer(g,f,d,e,b){d=decodeChunk(f,d,e);if(util.isBuffer(d)){e="buffer"}var a=f.objectMode?1:d.length;f.length+=a;var c=f.length<f.highWaterMark;if(!c){f.needDrain=true}if(f.writing||f.corked){f.buffer.push(new WriteReq(d,e,b))}else{doWrite(g,f,false,a,d,e,b)}return c}function doWrite(g,f,d,b,c,e,a){f.writelen=b;f.writecb=a;f.writing=true;f.sync=true;if(d){g._writev(c,f.onwrite)}else{g._write(c,e,f.onwrite)}f.sync=false}function onwriteError(d,c,b,e,a){if(b){process.nextTick(function(){c.pendingcb--;a(e)})}else{c.pendingcb--;a(e)}d._writableState.errorEmitted=true;d.emit("error",e)}function onwriteStateUpdate(a){a.writing=false;a.writecb=null;a.length-=a.writelen;a.writelen=0}function onwrite(d,f){var c=d._writableState;var b=c.sync;var a=c.writecb;onwriteStateUpdate(c);if(f){onwriteError(d,c,b,f,a)}else{var e=needFinish(d,c);if(!e&&!c.corked&&!c.bufferProcessing&&c.buffer.length){clearBuffer(d,c)}if(b){process.nextTick(function(){afterWrite(d,c,e,a)})}else{afterWrite(d,c,e,a)}}}function afterWrite(c,b,d,a){if(!d){onwriteDrain(c,b)}b.pendingcb--;a();finishMaybe(c,b)}function onwriteDrain(b,a){if(a.length===0&&a.needDrain){a.needDrain=false;b.emit("drain")}}function clearBuffer(j,a){a.bufferProcessing=true;if(j._writev&&a.buffer.length>1){var e=[];for(var g=0;g<a.buffer.length;g++){e.push(a.buffer[g].callback)}a.pendingcb++;doWrite(j,a,true,a.length,a.buffer,"",function(k){for(var c=0;c<e.length;c++){a.pendingcb--;e[c](k)}});a.buffer=[]}else{for(var g=0;g<a.buffer.length;g++){var i=a.buffer[g];var h=i.chunk;var b=i.encoding;var d=i.callback;var f=a.objectMode?1:h.length;doWrite(j,a,false,f,h,b,d);if(a.writing){g++;break}}if(g<a.buffer.length){a.buffer=a.buffer.slice(g)}else{a.buffer.length=0}}a.bufferProcessing=false}Writable.prototype._write=function(b,c,a){a(new Error("not implemented"))};Writable.prototype._writev=null;Writable.prototype.end=function(b,c,a){var d=this._writableState;if(util.isFunction(b)){a=b;b=null;c=null}else{if(util.isFunction(c)){a=c;c=null}}if(!util.isNullOrUndefined(b)){this.write(b,c)}if(d.corked){d.corked=1;this.uncork()}if(!d.ending&&!d.finished){endWritable(this,d,a)}};function needFinish(b,a){return(a.ending&&a.length===0&&!a.finished&&!a.writing)}function prefinish(b,a){if(!a.prefinished){a.prefinished=true;b.emit("prefinish")}}function finishMaybe(c,b){var a=needFinish(c,b);if(a){if(b.pendingcb===0){prefinish(c,b);b.finished=true;c.emit("finish")}else{prefinish(c,b)}}return a}function endWritable(c,b,a){b.ending=true;finishMaybe(c,b);if(a){if(b.finished){process.nextTick(a)}else{c.once("finish",a)}}b.ended=true};