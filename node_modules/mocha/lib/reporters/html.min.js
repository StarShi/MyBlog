"use strict";var Base=require("./base");var utils=require("../utils");var Progress=require("../browser/progress");var escapeRe=require("escape-string-regexp");var escape=utils.escape;var Date=global.Date;var setTimeout=global.setTimeout;var setInterval=global.setInterval;var clearTimeout=global.clearTimeout;var clearInterval=global.clearInterval;exports=module.exports=HTML;var statsTemplate='<ul id="mocha-stats"><li class="progress"><canvas width="40" height="40"></canvas></li><li class="passes"><a href="javascript:void(0);">passes:</a> <em>0</em></li><li class="failures"><a href="javascript:void(0);">failures:</a> <em>0</em></li><li class="duration">duration: <em>0</em>s</li></ul>';var playIcon="&#x2023;";function HTML(i){Base.call(this,i);var j=this;var s=this.stats;var r=fragment(statsTemplate);var k=r.getElementsByTagName("li");var d=k[1].getElementsByTagName("em")[0];var q=k[1].getElementsByTagName("a")[0];var b=k[2].getElementsByTagName("em")[0];var l=k[2].getElementsByTagName("a")[0];var a=k[3].getElementsByTagName("em")[0];var c=r.getElementsByTagName("canvas")[0];var o=fragment('<ul id="mocha-report"></ul>');var g=[o];var e;var m;var n=document.getElementById("mocha");if(c.getContext){var h=window.devicePixelRatio||1;c.style.width=c.width;c.style.height=c.height;c.width*=h;c.height*=h;m=c.getContext("2d");m.scale(h,h);e=new Progress()}if(!n){return error("#mocha div missing, add it to your document")}on(q,"click",function(t){t.preventDefault();unhide();var u=(/pass/).test(o.className)?"":" pass";o.className=o.className.replace(/fail|pass/g,"")+u;if(o.className.trim()){hideSuitesWithout("test pass")}});on(l,"click",function(t){t.preventDefault();unhide();var u=(/fail/).test(o.className)?"":" fail";o.className=o.className.replace(/fail|pass/g,"")+u;if(o.className.trim()){hideSuitesWithout("test fail")}});n.appendChild(r);n.appendChild(o);if(e){e.size(40)}i.on("suite",function(v){if(v.root){return}var t=j.suiteURL(v);var u=fragment('<li class="suite"><h1><a href="%s">%s</a></h1></li>',t,escape(v.title));g[0].appendChild(u);g.unshift(document.createElement("ul"));u.appendChild(g[0])});i.on("suite end",function(t){if(t.root){p();return}g.shift()});i.on("pass",function(w){var u=j.testURL(w);var t='<li class="test pass %e"><h2>%e<span class="duration">%ems</span> <a href="%s" class="replay">'+playIcon+"</a></h2></li>";var v=fragment(t,w.speed,w.title,w.duration,u);j.addCodeToggle(v,w.body);f(v);p()});i.on("fail",function(x){var t=fragment('<li class="test fail"><h2>%e <a href="%e" class="replay">'+playIcon+"</a></h2></li>",x.title,j.testURL(x));var w;var u=x.err.toString();if(u==="[object Error]"){u=x.err.message}if(x.err.stack){var v=x.err.stack.indexOf(x.err.message);if(v===-1){w=x.err.stack}else{w=x.err.stack.substr(x.err.message.length+v)}}else{if(x.err.sourceURL&&x.err.line!==undefined){w="\n("+x.err.sourceURL+":"+x.err.line+")"}}w=w||"";if(x.err.htmlMessage&&w){t.appendChild(fragment('<div class="html-error">%s\n<pre class="error">%e</pre></div>',x.err.htmlMessage,w))}else{if(x.err.htmlMessage){t.appendChild(fragment('<div class="html-error">%s</div>',x.err.htmlMessage))}else{t.appendChild(fragment('<pre class="error">%e%e</pre>',u,w))}}j.addCodeToggle(t,x.body);f(t);p()});i.on("pending",function(u){var t=fragment('<li class="test pass pending"><h2>%e</h2></li>',u.title);f(t);p()});function f(t){if(g[0]){g[0].appendChild(t)}}function p(){var u=s.tests/i.total*100|0;if(e){e.update(u).draw(m)}var t=new Date()-s.start;text(d,s.passes);text(b,s.failures);text(a,(t/1000).toFixed(2))}}function makeUrl(b){var a=window.location.search;if(a){a=a.replace(/[?&]grep=[^&\s]*/g,"").replace(/^&/,"?")}return window.location.pathname+(a?a+"&":"?")+"grep="+encodeURIComponent(escapeRe(b))}HTML.prototype.suiteURL=function(a){return makeUrl(a.fullTitle())};HTML.prototype.testURL=function(a){return makeUrl(a.fullTitle())};HTML.prototype.addCodeToggle=function(b,c){var a=b.getElementsByTagName("h2")[0];on(a,"click",function(){d.style.display=d.style.display==="none"?"block":"none"});var d=fragment("<pre><code>%e</code></pre>",utils.clean(c));b.appendChild(d);d.style.display="none"};function error(a){document.body.appendChild(fragment('<div id="mocha-error">%s</div>',a))}function fragment(c){var a=arguments;var d=document.createElement("div");var b=1;d.innerHTML=c.replace(/%([se])/g,function(e,f){switch(f){case"s":return String(a[b++]);case"e":return escape(a[b++])}});return d.firstChild}function hideSuitesWithout(d){var c=document.getElementsByClassName("suite");for(var b=0;b<c.length;b++){var a=c[b].getElementsByClassName(d);if(!a.length){c[b].className+=" hidden"}}}function unhide(){var b=document.getElementsByClassName("suite hidden");for(var a=0;a<b.length;++a){b[a].className=b[a].className.replace("suite hidden","suite")}}function text(a,b){if(a.textContent){a.textContent=b}else{a.innerText=b}}function on(b,c,a){if(b.addEventListener){b.addEventListener(c,a,false)}else{b.attachEvent("on"+c,a)}};