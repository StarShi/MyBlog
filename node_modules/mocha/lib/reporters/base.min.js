"use strict";var tty=require("tty");var diff=require("diff");var ms=require("../ms");var utils=require("../utils");var supportsColor=process.browser?null:require("supports-color");exports=module.exports=Base;var Date=global.Date;var setTimeout=global.setTimeout;var setInterval=global.setInterval;var clearTimeout=global.clearTimeout;var clearInterval=global.clearInterval;var isatty=tty.isatty(1)&&tty.isatty(2);exports.useColors=!process.browser&&(supportsColor||(process.env.MOCHA_COLORS!==undefined));exports.inlineDiffs=false;exports.colors={pass:90,fail:31,"bright pass":92,"bright fail":91,"bright yellow":93,pending:36,suite:0,"error title":0,"error message":31,"error stack":90,checkmark:32,fast:90,medium:33,slow:31,green:32,light:90,"diff gutter":90,"diff added":32,"diff removed":31};exports.symbols={ok:"✓",err:"✖",dot:"․",comma:",",bang:"!"};if(process.platform==="win32"){exports.symbols.ok="\u221A";exports.symbols.err="\u00D7";exports.symbols.dot="."}var color=exports.color=function(a,b){if(!exports.useColors){return String(b)}return"\u001b["+exports.colors[a]+"m"+b+"\u001b[0m"};exports.window={width:75};if(isatty){exports.window.width=process.stdout.getWindowSize?process.stdout.getWindowSize(1)[0]:tty.getWindowSize()[1]}exports.cursor={hide:function(){isatty&&process.stdout.write("\u001b[?25l")},show:function(){isatty&&process.stdout.write("\u001b[?25h")},deleteLine:function(){isatty&&process.stdout.write("\u001b[2K")},beginningOfLine:function(){isatty&&process.stdout.write("\u001b[0G")},CR:function(){if(isatty){exports.cursor.deleteLine();exports.cursor.beginningOfLine()}else{process.stdout.write("\r")}}};exports.list=function(a){console.log();a.forEach(function(j,e){var c=color("error title","  %s) %s:\n")+color("error message","     %s")+color("error stack","\n%s\n");var b;var d=j.err;var n;if(d.message&&typeof d.message.toString==="function"){n=d.message+""}else{if(typeof d.inspect==="function"){n=d.inspect()+""}else{n=""}}var k=d.stack||n;var h=n?k.indexOf(n):-1;var m=d.actual;var g=d.expected;var l=true;if(h===-1){b=n}else{h+=n.length;b=k.slice(0,h);k=k.slice(h+1)}if(d.uncaught){b="Uncaught "+b}if(d.showDiff!==false&&sameType(m,g)&&g!==undefined){l=false;if(!(utils.isString(m)&&utils.isString(g))){d.actual=m=utils.stringify(m);d.expected=g=utils.stringify(g)}c=color("error title","  %s) %s:\n%s")+color("error stack","\n%s\n");var f=n.match(/^([^:]+): expected/);b="\n      "+color("error message",f?f[1]:b);if(exports.inlineDiffs){b+=inlineDiff(d,l)}else{b+=unifiedDiff(d,l)}}k=k.replace(/^/gm,"  ");console.log(c,(e+1),j.fullTitle(),b,k)})};function Base(c){var a=this.stats={suites:0,tests:0,passes:0,pending:0,failures:0};var b=this.failures=[];if(!c){return}this.runner=c;c.stats=a;c.on("start",function(){a.start=new Date()});c.on("suite",function(d){a.suites=a.suites||0;d.root||a.suites++});c.on("test end",function(){a.tests=a.tests||0;a.tests++});c.on("pass",function(d){a.passes=a.passes||0;if(d.duration>d.slow()){d.speed="slow"}else{if(d.duration>d.slow()/2){d.speed="medium"}else{d.speed="fast"}}a.passes++});c.on("fail",function(e,d){a.failures=a.failures||0;a.failures++;e.err=d;b.push(e)});c.on("end",function(){a.end=new Date();a.duration=new Date()-a.start});c.on("pending",function(){a.pending++})}Base.prototype.epilogue=function(){var b=this.stats;var a;console.log();a=color("bright pass"," ")+color("green"," %d passing")+color("light"," (%s)");console.log(a,b.passes||0,ms(b.duration));if(b.pending){a=color("pending"," ")+color("pending"," %d pending");console.log(a,b.pending)}if(b.failures){a=color("fail","  %d failing");console.log(a,b.failures);Base.list(this.failures);console.log()}console.log()};function pad(b,a){b=String(b);return Array(a-b.length+1).join(" ")+b}function inlineDiff(d,c){var e=errorDiff(d,"WordsWithSpace",c);var a=e.split("\n");if(a.length>4){var b=String(a.length).length;e=a.map(function(g,f){return pad(++f,b)+" | "+g}).join("\n")}e="\n"+color("diff removed","actual")+" "+color("diff added","expected")+"\n\n"+e+"\n";e=e.replace(/^/gm,"      ");return e}function unifiedDiff(d,c){var a="      ";function e(h){if(c){h=escapeInvisibles(h)}if(h[0]==="+"){return a+colorLines("diff added",h)}if(h[0]==="-"){return a+colorLines("diff removed",h)}if(h.match(/@@/)){return null}if(h.match(/\\ No newline/)){return null}return a+h}function g(h){return typeof h!=="undefined"&&h!==null}var f=diff.createPatch("string",d.actual,d.expected);var b=f.split("\n").splice(4);return"\n      "+colorLines("diff added","+ expected")+" "+colorLines("diff removed","- actual")+"\n\n"+b.map(e).filter(g).join("\n")}function errorDiff(d,a,c){var e=c?escapeInvisibles(d.actual):d.actual;var b=c?escapeInvisibles(d.expected):d.expected;return diff["diff"+a](e,b).map(function(f){if(f.added){return colorLines("diff added",f.value)}if(f.removed){return colorLines("diff removed",f.value)}return f.value}).join("")}function escapeInvisibles(a){return a.replace(/\t/g,"<tab>").replace(/\r/g,"<CR>").replace(/\n/g,"<LF>\n")}function colorLines(a,b){return b.split("\n").map(function(c){return color(a,c)}).join("\n")}var objToString=Object.prototype.toString;function sameType(d,c){return objToString.call(d)===objToString.call(c)};