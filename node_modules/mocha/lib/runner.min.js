"use strict";var EventEmitter=require("events").EventEmitter;var Pending=require("./pending");var utils=require("./utils");var inherits=utils.inherits;var debug=require("debug")("mocha:runner");var Runnable=require("./runnable");var filter=utils.filter;var indexOf=utils.indexOf;var some=utils.some;var keys=utils.keys;var stackFilter=utils.stackTraceFilter();var stringify=utils.stringify;var type=utils.type;var undefinedError=utils.undefinedError;var isArray=utils.isArray;var globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date","setImmediate","clearImmediate"];module.exports=Runner;function Runner(c,b){var a=this;this._globals=[];this._abort=false;this._delay=b;this.suite=c;this.started=false;this.total=c.total();this.failures=0;this.on("test end",function(d){a.checkGlobals(d)});this.on("hook end",function(d){a.checkGlobals(d)});this._defaultGrep=/.*/;this.grep(this._defaultGrep);this.globals(this.globalProps().concat(extraGlobals()))}Runner.immediately=global.setImmediate||process.nextTick;inherits(Runner,EventEmitter);Runner.prototype.grep=function(a,b){debug("grep %s",a);this._grep=a;this._invert=b;this.total=this.grepTotal(this.suite);return this};Runner.prototype.grepTotal=function(b){var a=this;var c=0;b.eachTest(function(e){var d=a._grep.test(e.fullTitle());if(a._invert){d=!d}if(d){c++}});return c};Runner.prototype.globalProps=function(){var b=keys(global);for(var a=0;a<globals.length;++a){if(~indexOf(b,globals[a])){continue}b.push(globals[a])}return b};Runner.prototype.globals=function(a){if(!arguments.length){return this._globals}debug("globals %j",a);this._globals=this._globals.concat(a);return this};Runner.prototype.checkGlobals=function(d){if(this.ignoreLeaks){return}var b=this._globals;var c=this.globalProps();var a;if(d){b=b.concat(d._allowedGlobals||[])}if(this.prevGlobalsLength===c.length){return}this.prevGlobalsLength=c.length;a=filterLeaks(b,c);this._globals=this._globals.concat(a);if(a.length>1){this.fail(d,new Error("global leaks detected: "+a.join(", ")+""))}else{if(a.length){this.fail(d,new Error("global leak detected: "+a[0]))}}};Runner.prototype.fail=function(c,b){if(c.isPending()){return}++this.failures;c.state="failed";if(!(b instanceof Error||b&&typeof b.message==="string")){b=new Error("the "+type(b)+" "+stringify(b)+" was thrown, throw an Error :)")}try{b.stack=(this.fullStackTrace||!b.stack)?b.stack:stackFilter(b.stack)}catch(a){}this.emit("fail",c,b)};Runner.prototype.failHook=function(b,a){if(b.ctx&&b.ctx.currentTest){b.originalTitle=b.originalTitle||b.title;b.title=b.originalTitle+' for "'+b.ctx.currentTest.title+'"'}this.fail(b,a);if(this.suite.bail()){this.emit("end")}};Runner.prototype.hook=function(c,f){var e=this.suite;var a=e["_"+c];var b=this;function d(g){var h=a[g];if(!h){return f()}b.currentRunnable=h;h.ctx.currentTest=b.test;b.emit("hook",h);if(!h.listeners("error").length){h.on("error",function(i){b.failHook(h,i)})}h.run(function(j){var i=h.error();if(i){b.fail(b.test,i)}if(j){if(j instanceof Pending){if(c==="beforeEach"||c==="afterEach"){b.test.pending=true}else{utils.forEach(e.tests,function(k){k.pending=true});h.pending=true}}else{b.failHook(h,j);return f(j)}}b.emit("hook end",h);delete h.ctx.currentTest;d(++g)})}Runner.immediately(function(){d(0)})};Runner.prototype.hooks=function(b,e,d){var a=this;var f=this.suite;function c(g){a.suite=g;if(!g){a.suite=f;return d()}a.hook(b,function(h){if(h){var i=a.suite;a.suite=f;return d(h,i)}c(e.pop())})}c(e.pop())};Runner.prototype.hookUp=function(a,b){var c=[this.suite].concat(this.parents()).reverse();this.hooks(a,c,b)};Runner.prototype.hookDown=function(a,b){var c=[this.suite].concat(this.parents());this.hooks(a,c,b)};Runner.prototype.parents=function(){var a=this.suite;var b=[];while(a.parent){a=a.parent;b.push(a)}return b};Runner.prototype.runTest=function(b){var a=this;var d=this.test;if(!d){return}if(this.asyncOnly){d.asyncOnly=true}d.on("error",function(e){a.fail(d,e)});if(this.allowUncaught){d.allowUncaught=true;return d.run(b)}try{d.run(b)}catch(c){b(c)}};Runner.prototype.runTests=function(f,e){var a=this;var d=f.tests.slice();var g;function b(h,i,j){var k=a.suite;a.suite=j?i.parent:i;if(a.suite){a.hookUp("afterEach",function(l,m){a.suite=k;if(l){return b(l,m,true)}e(i)})}else{a.suite=k;e(i)}}function c(i,j){if(a.failures&&f._bail){return e()}if(a._abort){return e()}if(i){return b(i,j,true)}g=d.shift();if(!g){return e()}var h=a._grep.test(g.fullTitle());if(a._invert){h=!h}if(!h){if(a._grep!==a._defaultGrep){Runner.immediately(c)}else{c()}return}if(g.isPending()){a.emit("pending",g);a.emit("test end",g);return c()}a.emit("test",a.test=g);a.hookDown("beforeEach",function(k,l){if(g.isPending()){a.emit("pending",g);a.emit("test end",g);return c()}if(k){return b(k,l,false)}a.currentRunnable=a.test;a.runTest(function(o){g=a.test;if(o){var m=g.currentRetry();if(o instanceof Pending){g.pending=true;a.emit("pending",g)}else{if(m<g.retries()){var n=g.clone();n.currentRetry(m+1);d.unshift(n);return a.hookUp("afterEach",c)}else{a.fail(g,o)}}a.emit("test end",g);if(o instanceof Pending){return c()}return a.hookUp("afterEach",c)}g.state="passed";a.emit("pass",g);a.emit("test end",g);a.hookUp("afterEach",c)})})}this.next=c;this.hookErr=b;c()};Runner.prototype.runSuite=function(g,f){var d=0;var b=this;var h=this.grepTotal(g);var c=false;debug("run suite %s",g.fullTitle());if(!h||(b.failures&&g._bail)){return f()}this.emit("suite",this.suite=g);function e(i){if(i){if(i===g){return a()}return a(i)}if(b._abort){return a()}var j=g.suites[d++];if(!j){return a()}if(b._grep!==b._defaultGrep){Runner.immediately(function(){b.runSuite(j,e)})}else{b.runSuite(j,e)}}function a(i){b.suite=g;b.nextSuite=e;if(c){f(i)}else{c=true;delete b.test;b.hook("afterAll",function(){b.emit("suite end",g);f(i)})}}this.nextSuite=e;this.hook("beforeAll",function(i){if(i){return a()}b.runTests(g,e)})};Runner.prototype.uncaught=function(a){if(a){debug("uncaught exception %s",a===(function(){return this}.call(a))?(a.message||a):a)}else{debug("uncaught undefined exception");a=undefinedError()}a.uncaught=true;var c=this.currentRunnable;if(!c){c=new Runnable("Uncaught error outside test suite");c.parent=this.suite;if(this.started){this.fail(c,a)}else{this.emit("start");this.fail(c,a);this.emit("end")}return}c.clearTimeout();if(c.state||c.isPending()){return}this.fail(c,a);if(c.type==="test"){this.emit("test end",c);this.hookUp("afterEach",this.next);return}if(c.type==="hook"){var b=this.suite;if(c.fullTitle().indexOf("after each")>-1){return this.hookErr(a,b,true)}if(c.fullTitle().indexOf("before each")>-1){return this.hookErr(a,b,false)}return this.nextSuite(b)}this.emit("end")};function cleanSuiteReferences(b){function c(d){for(var e=0;e<d.length;e++){delete d[e].fn}}if(isArray(b._beforeAll)){c(b._beforeAll)}if(isArray(b._beforeEach)){c(b._beforeEach)}if(isArray(b._afterAll)){c(b._afterAll)}if(isArray(b._afterEach)){c(b._afterEach)}for(var a=0;a<b.tests.length;a++){delete b.tests[a].fn}}Runner.prototype.run=function(d){var b=this;var c=this.suite;if(this.hasOnly){filterOnly(c)}d=d||function(){};function a(f){b.uncaught(f)}function e(){b.started=true;b.emit("start");b.runSuite(c,function(){debug("finished running");b.emit("end")})}debug("start");this.on("suite end",cleanSuiteReferences);this.on("end",function(){if(b.forbidOnly&&b.hasOnly){b.failures+=b.stats.tests}if(b.forbidPending){b.failures+=b.stats.pending}debug("end");process.removeListener("uncaughtException",a);d(b.failures)});process.on("uncaughtException",a);if(this._delay){this.emit("waiting",c);c.once("run",e)}else{e()}return this};Runner.prototype.abort=function(){debug("aborting");this._abort=true;return this};function filterOnly(a){if(a._onlyTests.length){a.tests=a._onlyTests;a.suites=[]}else{a.tests=[];utils.forEach(a._onlySuites,function(b){if(hasOnly(b)){filterOnly(b)}});a.suites=filter(a.suites,function(b){return indexOf(a._onlySuites,b)!==-1||filterOnly(b)})}return a.tests.length||a.suites.length}function hasOnly(a){return a._onlyTests.length||a._onlySuites.length||some(a.suites,hasOnly)}function filterLeaks(a,b){return filter(b,function(d){if(/^\d+/.test(d)){return false}if(global.navigator&&(/^getInterface/).test(d)){return false}if(global.navigator&&(/^\d+/).test(d)){return false}if(/^mocha-/.test(d)){return false}var c=filter(a,function(e){if(~e.indexOf("*")){return d.indexOf(e.split("*")[0])===0}return d===e});return !c.length&&(!global.navigator||d!=="onerror")})}function extraGlobals(){if(typeof process==="object"&&typeof process.version==="string"){var b=process.version.split(".");var a=utils.reduce(b,function(c,d){return c<<8|d});if(a<2315){return["errno"]}}return[]};