"use strict";
/*!
 * mocha
 * Copyright(c) 2011 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */
;var escapeRe=require("escape-string-regexp");var path=require("path");var reporters=require("./reporters");var utils=require("./utils");exports=module.exports=Mocha;if(!process.browser){var cwd=process.cwd();module.paths.push(cwd,path.join(cwd,"node_modules"))}exports.utils=utils;exports.interfaces=require("./interfaces");exports.reporters=reporters;exports.Runnable=require("./runnable");exports.Context=require("./context");exports.Runner=require("./runner");exports.Suite=require("./suite");exports.Hook=require("./hook");exports.Test=require("./test");function image(a){return path.join(__dirname,"../images",a+".png")}function Mocha(a){a=a||{};this.files=[];this.options=a;if(a.grep){this.grep(new RegExp(a.grep))}if(a.fgrep){this.fgrep(a.fgrep)}this.suite=new exports.Suite("",new exports.Context());this.ui(a.ui);this.bail(a.bail);this.reporter(a.reporter,a.reporterOptions);if(typeof a.timeout!=="undefined"&&a.timeout!==null){this.timeout(a.timeout)}if(typeof a.retries!=="undefined"&&a.retries!==null){this.retries(a.retries)}this.useColors(a.useColors);if(a.enableTimeouts!==null){this.enableTimeouts(a.enableTimeouts)}if(a.slow){this.slow(a.slow)}}Mocha.prototype.bail=function(a){if(!arguments.length){a=true}this.suite.bail(a);return this};Mocha.prototype.addFile=function(a){this.files.push(a);return this};Mocha.prototype.reporter=function(a,c){if(typeof a==="function"){this._reporter=a}else{a=a||"spec";var b;if(reporters[a]){b=reporters[a]}if(!b){try{b=require(a)}catch(d){if(d.message.indexOf("Cannot find module")!==-1){try{b=require(path.resolve(process.cwd(),a))}catch(e){d.message.indexOf("Cannot find module")!==-1?console.warn('"'+a+'" reporter not found'):console.warn('"'+a+'" reporter blew up with error:\n'+d.stack)}}else{console.warn('"'+a+'" reporter blew up with error:\n'+d.stack)}}}if(!b&&a==="teamcity"){console.warn("The Teamcity reporter was moved to a package named mocha-teamcity-reporter (https://npmjs.org/package/mocha-teamcity-reporter).")}if(!b){throw new Error('invalid reporter "'+a+'"')}this._reporter=b}this.options.reporterOptions=c;return this};Mocha.prototype.ui=function(a){a=a||"bdd";this._ui=exports.interfaces[a];if(!this._ui){try{this._ui=require(a)}catch(b){throw new Error('invalid interface "'+a+'"')}}this._ui=this._ui(this.suite);this.suite.on("pre-require",function(c){exports.afterEach=c.afterEach||c.teardown;exports.after=c.after||c.suiteTeardown;exports.beforeEach=c.beforeEach||c.setup;exports.before=c.before||c.suiteSetup;exports.describe=c.describe||c.suite;exports.it=c.it||c.test;exports.xit=c.xit||c.test.skip;exports.setup=c.setup||c.beforeEach;exports.suiteSetup=c.suiteSetup||c.before;exports.suiteTeardown=c.suiteTeardown||c.after;exports.suite=c.suite||c.describe;exports.teardown=c.teardown||c.afterEach;exports.test=c.test||c.it;exports.run=c.run});return this};Mocha.prototype.loadFiles=function(c){var a=this;var b=this.suite;this.files.forEach(function(d){d=path.resolve(d);b.emit("pre-require",global,d,a);b.emit("require",require(d),d,a);b.emit("post-require",global,d,a)});c&&c()};Mocha.prototype._growl=function(c,a){var b=require("growl");c.on("end",function(){var d=a.stats;if(d.failures){var e=d.failures+" of "+c.total+" tests failed";b(e,{name:"mocha",title:"Failed",image:image("error")})}else{b(d.passes+" tests passed in "+d.duration+"ms",{name:"mocha",title:"Passed",image:image("ok")})}})};Mocha.prototype.fgrep=function(a){return this.grep(new RegExp(escapeRe(a)))};Mocha.prototype.grep=function(b){if(utils.isString(b)){var a=b.match(/^\/(.*)\/(g|i|)$|.*/);this.options.grep=new RegExp(a[1]||a[0],a[2])}else{this.options.grep=b}return this};Mocha.prototype.invert=function(){this.options.invert=true;return this};Mocha.prototype.ignoreLeaks=function(a){this.options.ignoreLeaks=Boolean(a);return this};Mocha.prototype.checkLeaks=function(){this.options.ignoreLeaks=false;return this};Mocha.prototype.fullTrace=function(){this.options.fullStackTrace=true;return this};Mocha.prototype.growl=function(){this.options.growl=true;return this};Mocha.prototype.globals=function(a){this.options.globals=(this.options.globals||[]).concat(a);return this};Mocha.prototype.useColors=function(a){if(a!==undefined){this.options.useColors=a}return this};Mocha.prototype.useInlineDiffs=function(a){this.options.useInlineDiffs=a!==undefined&&a;return this};Mocha.prototype.timeout=function(a){this.suite.timeout(a);return this};Mocha.prototype.retries=function(a){this.suite.retries(a);return this};Mocha.prototype.slow=function(a){this.suite.slow(a);return this};Mocha.prototype.enableTimeouts=function(a){this.suite.enableTimeouts(arguments.length&&a!==undefined?a:true);return this};Mocha.prototype.asyncOnly=function(){this.options.asyncOnly=true;return this};Mocha.prototype.noHighlighting=function(){this.options.noHighlighting=true;return this};Mocha.prototype.allowUncaught=function(){this.options.allowUncaught=true;return this};Mocha.prototype.delay=function delay(){this.options.delay=true;return this};Mocha.prototype.forbidOnly=function(){this.options.forbidOnly=true;return this};Mocha.prototype.forbidPending=function(){this.options.forbidPending=true;return this};Mocha.prototype.run=function(e){if(this.files.length){this.loadFiles()}var d=this.suite;var c=this.options;c.files=this.files;var f=new exports.Runner(d,c.delay);var b=new this._reporter(f,c);f.ignoreLeaks=c.ignoreLeaks!==false;f.fullStackTrace=c.fullStackTrace;f.hasOnly=c.hasOnly;f.asyncOnly=c.asyncOnly;f.allowUncaught=c.allowUncaught;f.forbidOnly=c.forbidOnly;f.forbidPending=c.forbidPending;if(c.grep){f.grep(c.grep,c.invert)}if(c.globals){f.globals(c.globals)}if(c.growl){this._growl(f,b)}if(c.useColors!==undefined){exports.reporters.Base.useColors=c.useColors}exports.reporters.Base.inlineDiffs=c.useInlineDiffs;function a(g){if(b.done){b.done(g,e)}else{e&&e(g)}}return f.run(a)};