/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var Route=require("./route");var Layer=require("./layer");var methods=require("methods");var mixin=require("utils-merge");var debug=require("debug")("express:router");var deprecate=require("depd")("express");var flatten=require("array-flatten");var parseUrl=require("parseurl");var setPrototypeOf=require("setprototypeof");var objectRegExp=/^\[object (\S+)\]$/;var slice=Array.prototype.slice;var toString=Object.prototype.toString;var proto=module.exports=function(b){var c=b||{};function a(f,d,e){a.handle(f,d,e)}setPrototypeOf(a,proto);a.params={};a._params=[];a.caseSensitive=c.caseSensitive;a.mergeParams=c.mergeParams;a.strict=c.strict;a.stack=[];return a};proto.param=function param(c,e){if(typeof c==="function"){deprecate("router.param(fn): Refactor to use path params");this._params.push(c);return}var f=this._params;var a=f.length;var b;if(c[0]===":"){deprecate("router.param("+JSON.stringify(c)+", fn): Use router.param("+JSON.stringify(c.substr(1))+", fn) instead");c=c.substr(1)}for(var d=0;d<a;++d){if(b=f[d](c,e)){e=b}}if("function"!==typeof e){throw new Error("invalid param() call for "+c+", got "+e)}(this.params[c]=this.params[c]||[]).push(e);return this};proto.handle=function handle(l,j,e){var n=this;debug("dispatching %s %s",l.method,l.url);var m=0;var b=getProtohost(l.url)||"";var i="";var g=false;var c={};var p=[];var k=n.stack;var o=l.params;var a=l.baseUrl||"";var d=restore(e,l,"baseUrl","next","params");l.next=h;if(l.method==="OPTIONS"){d=wrap(d,function(q,r){if(r||p.length===0){return q(r)}sendOptionsResponse(j,p,q)})}l.baseUrl=a;l.originalUrl=l.originalUrl||l.url;h();function h(r){var w=r==="route"?null:r;if(g){l.url=l.url.substr(1);g=false}if(i.length!==0){l.baseUrl=a;l.url=b+i+l.url.substr(b.length);i=""}if(w==="router"){setImmediate(d,null);return}if(m>=k.length){setImmediate(d,w);return}var y=getPathname(l);if(y==null){return d(w)}var u;var t;var x;while(t!==true&&m<k.length){u=k[m++];t=matchLayer(u,y);x=u.route;if(typeof t!=="boolean"){w=w||t}if(t!==true){continue}if(!x){continue}if(w){t=false;continue}var q=l.method;var v=x._handles_method(q);if(!v&&q==="OPTIONS"){appendMethods(p,x._options())}if(!v&&q!=="HEAD"){t=false;continue}}if(t!==true){return d(w)}if(x){l.route=x}l.params=n.mergeParams?mergeParams(u.params,o):u.params;var s=u.path;n.process_params(u,c,l,j,function(z){if(z){return h(w||z)}if(x){return u.handle_request(l,j,h)}f(u,w,s,y)})}function f(r,q,t,s){if(t.length!==0){var u=s[t.length];if(u&&u!=="/"&&u!=="."){return h(q)}debug("trim prefix (%s) from url %s",t,l.url);i=t;l.url=b+l.url.substr(b.length+i.length);if(!b&&l.url[0]!=="/"){l.url="/"+l.url;g=true}l.baseUrl=a+(i[i.length-1]==="/"?i.substring(0,i.length-1):i)}debug("%s %s : %s",r.name,t,l.originalUrl);if(q){r.handle_error(q,l,j,h)}else{r.handle_request(l,j,h)}}};proto.process_params=function process_params(g,m,k,j,e){var c=this.params;var p=g.keys;if(!p||p.length===0){return e()}var f=0;var a;var q=0;var o;var n;var l;var h;function b(i){if(i){return e(i)}if(f>=p.length){return e()}q=0;o=p[f++];a=o.name;n=k.params[a];l=c[a];h=m[a];if(n===undefined||!l){return b()}if(h&&(h.match===n||(h.error&&h.error!=="route"))){k.params[a]=h.value;return b(h.error)}m[a]=h={error:null,match:n,value:n};d()}function d(r){var i=l[q++];h.value=k.params[o.name];if(r){h.error=r;b(r);return}if(!i){return b()}try{i(k,j,d,n,o.name)}catch(s){d(s)}}b()};proto.use=function use(d){var g=0;var f="/";if(typeof d!=="function"){var a=d;while(Array.isArray(a)&&a.length!==0){a=a[0]}if(typeof a!=="function"){g=1;f=d}}var e=flatten(slice.call(arguments,g));if(e.length===0){throw new TypeError("Router.use() requires a middleware function")}for(var c=0;c<e.length;c++){var d=e[c];if(typeof d!=="function"){throw new TypeError("Router.use() requires a middleware function but got a "+gettype(d))}debug("use %o %s",f,d.name||"<anonymous>");var b=new Layer(f,{sensitive:this.caseSensitive,strict:false,end:false},d);b.route=undefined;this.stack.push(b)}return this};proto.route=function route(c){var a=new Route(c);var b=new Layer(c,{sensitive:this.caseSensitive,strict:this.strict,end:true},a.dispatch.bind(a));b.route=a;this.stack.push(b);return a};methods.concat("all").forEach(function(a){proto[a]=function(c){var b=this.route(c);b[a].apply(b,slice.call(arguments,1));return this}});function appendMethods(c,a){for(var b=0;b<a.length;b++){var d=a[b];if(c.indexOf(d)===-1){c.push(d)}}}function getPathname(b){try{return parseUrl(b).pathname}catch(a){return undefined}}function getProtohost(b){if(typeof b!=="string"||b.length===0||b[0]==="/"){return undefined}var a=b.indexOf("?");var d=a!==-1?a:b.length;var c=b.substr(0,d).indexOf("://");return c!==-1?b.substr(0,b.indexOf("/",3+c)):undefined}function gettype(b){var a=typeof b;if(a!=="object"){return a}return toString.call(b).replace(objectRegExp,"$1")}function matchLayer(a,c){try{return a.match(c)}catch(b){return b}}function mergeParams(e,b){if(typeof b!=="object"||!b){return e}var c=mixin({},b);if(!(0 in e)||!(0 in b)){return mixin(c,e)}var a=0;var d=0;while(a in e){a++}while(d in b){d++}for(a--;a>=0;a--){e[a+d]=e[a];if(a<d){delete e[a]}}return mixin(c,e)}function restore(c,e){var b=new Array(arguments.length-2);var d=new Array(arguments.length-2);for(var a=0;a<b.length;a++){b[a]=arguments[a+2];d[a]=e[b[a]]}return function(){for(var f=0;f<b.length;f++){e[b[f]]=d[f]}return c.apply(this,arguments)}}function sendOptionsResponse(c,b,d){try{var a=b.join(",");c.set("Allow",a);c.send(a)}catch(e){d(e)}}function wrap(a,c){return function b(){var e=new Array(arguments.length+1);e[0]=a;for(var f=0,d=arguments.length;f<d;f++){e[f+1]=arguments[f]}c.apply(this,e)}};