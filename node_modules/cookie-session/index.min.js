/*!
 * cookie-session
 * Copyright(c) 2013 Jonathan Ong
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var Buffer=require("safe-buffer").Buffer;var debug=require("debug")("cookie-session");var Cookies=require("cookies");var onHeaders=require("on-headers");module.exports=cookieSession;function cookieSession(c){var e=c||{};var b=e.name||"session";var d=e.keys;if(!d&&e.secret){d=[e.secret]}if(e.overwrite==null){e.overwrite=true}if(e.httpOnly==null){e.httpOnly=true}if(e.signed==null){e.signed=true}if(!d&&e.signed){throw new Error(".keys required.")}debug("session options %j",e);return function a(k,h,i){var j=new Cookies(k,h,{keys:d});var g;k.sessionCookies=j;k.sessionOptions=Object.create(e);k.sessionKey=b;Object.defineProperty(k,"session",{configurable:true,enumerable:true,get:f,set:m});function f(){if(g){return g}if(g===false){return null}return(g=tryGetSession(k)||createSession(k))}function m(n){if(n==null){g=false;return n}if(typeof n==="object"){g=Session.create(this,n);return g}throw new Error("req.session can only be set as null or an object.")}onHeaders(h,function l(){if(g===undefined){return}try{if(g===false){j.set(b,"",k.sessionOptions)}else{if((!g.isNew||g.isPopulated)&&g.isChanged){g.save()}}}catch(n){debug("error saving session %s",n.message)}});i()}}function Session(a,c){Object.defineProperty(this,"_ctx",{value:a});if(c){for(var b in c){this[b]=c[b]}}}Session.create=function create(b,c){var a=new SessionContext(b);return new Session(a,c)};Session.deserialize=function deserialize(b,d){var a=new SessionContext(b);var c=decode(d);a._new=false;a._val=d;return new Session(a,c)};Session.serialize=function serialize(a){return encode(a)};Object.defineProperty(Session.prototype,"isChanged",{get:function getIsChanged(){return this._ctx._new||this._ctx._val!==Session.serialize(this)}});Object.defineProperty(Session.prototype,"isNew",{get:function getIsNew(){return this._ctx._new}});Object.defineProperty(Session.prototype,"length",{get:function getLength(){return Object.keys(this).length}});Object.defineProperty(Session.prototype,"isPopulated",{get:function getIsPopulated(){return Boolean(this.length)}});Session.prototype.save=function save(){var a=this._ctx;var e=Session.serialize(this);var d=a.req.sessionCookies;var b=a.req.sessionKey;var c=a.req.sessionOptions;debug("save %s",e);d.set(b,e,c)};function SessionContext(a){this.req=a;this._new=true;this._val=undefined}function createSession(a){debug("new session");return Session.create(a)}function decode(b){var a=Buffer.from(b,"base64").toString("utf8");return JSON.parse(a)}function encode(a){var b=JSON.stringify(a);return Buffer.from(b).toString("base64")}function tryGetSession(e){var d=e.sessionCookies;var a=e.sessionKey;var c=e.sessionOptions;var f=d.get(a,c);if(!f){return undefined}debug("parse %s",f);try{return Session.deserialize(e,f)}catch(b){return undefined}};