"use strict";var fs=require("fs");var path=require("path");var utils=require("./utils");var scopeOptionWarned=false;var _VERSION_STRING=require("../package.json").version;var _DEFAULT_DELIMITER="%";var _DEFAULT_LOCALS_NAME="locals";var _NAME="ejs";var _REGEX_STRING="(<%%|%%>|<%=|<%-|<%_|<%#|<%|%>|-%>|_%>)";var _OPTS=["delimiter","scope","context","debug","compileDebug","client","_with","rmWhitespace","strict","filename"];var _OPTS_EXPRESS=_OPTS.concat("cache");var _BOM=/^\uFEFF/;exports.cache=utils.cache;exports.fileLoader=fs.readFileSync;exports.localsName=_DEFAULT_LOCALS_NAME;exports.resolveInclude=function(b,a,h){var e=path.dirname;var g=path.extname;var d=path.resolve;var f=d(h?a:e(a),b);var c=g(b);if(!c){f+=".ejs"}return f};function getIncludePath(d,b){var e;var c;var a=b.views;if(d.charAt(0)=="/"){e=exports.resolveInclude(d.replace(/^\/*/,""),b.root||"/",true)}else{if(b.filename){c=exports.resolveInclude(d,b.filename);if(fs.existsSync(c)){e=c}}if(!e){if(Array.isArray(a)&&a.some(function(f){c=exports.resolveInclude(d,f,true);return fs.existsSync(c)})){e=c}}if(!e){throw new Error("Could not find include include file.")}}return e}function handleCache(c,d){var e;var b=c.filename;var a=arguments.length>1;if(c.cache){if(!b){throw new Error("cache option requires a filename")}e=exports.cache.get(b);if(e){return e}if(!a){d=fileLoader(b).toString().replace(_BOM,"")}}else{if(!a){if(!b){throw new Error("Internal EJS error: no file name or template provided")}d=fileLoader(b).toString().replace(_BOM,"")}}e=exports.compile(d,c);if(c.cache){exports.cache.set(b,e)}return e}function tryHandleCache(c,e,b){var a;try{a=handleCache(c)(e)}catch(d){return b(d)}return b(null,a)}function fileLoader(a){return exports.fileLoader(a)}function includeFile(c,a){var b=utils.shallowCopy({},a);b.filename=getIncludePath(c,b);return handleCache(b)}function includeSource(e,a){var d=utils.shallowCopy({},a);var f;var b;f=getIncludePath(e,d);b=fileLoader(f).toString().replace(_BOM,"");d.filename=f;var c=new Template(b,d);c.generateSource();return{source:c.source,filename:f,template:b}}function rethrow(e,h,i,d,g){var j=h.split("\n");var c=Math.max(d-3,0);var f=Math.min(j.length,d+3);var a=g(i);var b=j.slice(c,f).map(function(k,l){var m=l+c+1;return(m==d?" >> ":"    ")+m+"| "+k}).join("\n");e.path=a;e.message=(a||"ejs")+":"+d+"\n"+b+"\n\n"+e.message;throw e}function stripSemi(a){return a.replace(/;(\s*$)/,"$1")}exports.compile=function compile(a,c){var b;if(c&&c.scope){if(!scopeOptionWarned){console.warn("`scope` option is deprecated and will be removed in EJS 3");scopeOptionWarned=true}if(!c.context){c.context=c.scope}delete c.scope}b=new Template(a,c);return b.compile()};exports.render=function(a,f,e){var c=f||{};var b=e||{};if(arguments.length==2){utils.shallowCopyFromList(b,c,_OPTS)}return handleCache(b,a)(c)};exports.renderFile=function(){var b=arguments[0];var a=arguments[arguments.length-1];var c={filename:b};var d;if(arguments.length>2){d=arguments[1];if(arguments.length===3){if(d.settings){if(d.settings["view options"]){utils.shallowCopyFromList(c,d.settings["view options"],_OPTS_EXPRESS)}if(d.settings.views){c.views=d.settings.views}}else{utils.shallowCopyFromList(c,d,_OPTS_EXPRESS)}}else{utils.shallowCopy(c,arguments[2])}c.filename=b}else{d={}}return tryHandleCache(c,d,a)};exports.clearCache=function(){exports.cache.reset()};function Template(c,b){b=b||{};var a={};this.templateText=c;this.mode=null;this.truncate=false;this.currentLine=1;this.source="";this.dependencies=[];a.client=b.client||false;a.escapeFunction=b.escape||utils.escapeXML;a.compileDebug=b.compileDebug!==false;a.debug=!!b.debug;a.filename=b.filename;a.delimiter=b.delimiter||exports.delimiter||_DEFAULT_DELIMITER;a.strict=b.strict||false;a.context=b.context;a.cache=b.cache||false;a.rmWhitespace=b.rmWhitespace;a.root=b.root;a.localsName=b.localsName||exports.localsName||_DEFAULT_LOCALS_NAME;a.views=b.views;if(a.strict){a._with=false}else{a._with=typeof b._with!="undefined"?b._with:true}this.opts=a;this.regex=this.createRegex()}Template.modes={EVAL:"eval",ESCAPED:"escaped",RAW:"raw",COMMENT:"comment",LITERAL:"literal"};Template.prototype={createRegex:function(){var b=_REGEX_STRING;var a=utils.escapeRegExpChars(this.opts.delimiter);b=b.replace(/%/g,a);return new RegExp(b)},compile:function(){var i;var d;var f=this.opts;var a="";var b="";var c=f.escapeFunction;if(!this.source){this.generateSource();a+="  var __output = [], __append = __output.push.bind(__output);\n";if(f._with!==false){a+="  with ("+f.localsName+" || {}) {\n";b+="  }\n"}b+='  return __output.join("");\n';this.source=a+this.source+b}if(f.compileDebug){i="var __line = 1\n  , __lines = "+JSON.stringify(this.templateText)+"\n  , __filename = "+(f.filename?JSON.stringify(f.filename):"undefined")+";\ntry {\n"+this.source+"} catch (e) {\n  rethrow(e, __lines, __filename, __line, escapeFn);\n}\n"}else{i=this.source}if(f.client){i="escapeFn = escapeFn || "+c.toString()+";\n"+i;if(f.compileDebug){i="rethrow = rethrow || "+rethrow.toString()+";\n"+i}}if(f.strict){i='"use strict";\n'+i}if(f.debug){console.log(i)}try{d=new Function(f.localsName+", escapeFn, include, rethrow",i)}catch(g){if(g instanceof SyntaxError){if(f.filename){g.message+=" in "+f.filename}g.message+=" while compiling ejs\n\n";g.message+="If the above error is not helpful, you may want to try EJS-Lint:\n";g.message+="https://github.com/RyanZim/EJS-Lint"}throw g}if(f.client){d.dependencies=this.dependencies;return d}var h=function(j){var e=function(l,k){var m=utils.shallowCopy({},j);if(k){m=utils.shallowCopy(m,k)}return includeFile(l,f)(m)};return d.apply(f.context,[j||{},c,e,rethrow])};h.dependencies=this.dependencies;return h},generateSource:function(){var b=this.opts;if(b.rmWhitespace){this.templateText=this.templateText.replace(/\r/g,"").replace(/^\s+|\s+$/gm,"")}this.templateText=this.templateText.replace(/[ \t]*<%_/gm,"<%_").replace(/_%>[ \t]*/gm,"_%>");var a=this;var c=this.parseTemplateText();var e=this.opts.delimiter;if(c&&c.length){c.forEach(function(g,i){var f;var k;var d;var l;var h;var j;if(g.indexOf("<"+e)===0&&g.indexOf("<"+e+e)!==0){k=c[i+2];if(!(k==e+">"||k=="-"+e+">"||k=="_"+e+">")){throw new Error('Could not find matching close tag for "'+g+'".')}}if((d=g.match(/^\s*include\s+(\S+)/))){f=c[i-1];if(f&&(f=="<"+e||f=="<"+e+"-"||f=="<"+e+"_")){l=utils.shallowCopy({},a.opts);h=includeSource(d[1],l);if(a.opts.compileDebug){j="    ; (function(){\n      var __line = 1\n      , __lines = "+JSON.stringify(h.template)+"\n      , __filename = "+JSON.stringify(h.filename)+";\n      try {\n"+h.source+"      } catch (e) {\n        rethrow(e, __lines, __filename, __line, escapeFn);\n      }\n    ; }).call(this)\n"}else{j="    ; (function(){\n"+h.source+"    ; }).call(this)\n"}a.source+=j;a.dependencies.push(exports.resolveInclude(d[1],l.filename));return}}a.scanLine(g)})}},parseTemplateText:function(){var d=this.templateText;var c=this.regex;var b=c.exec(d);var a=[];var e;while(b){e=b.index;if(e!==0){a.push(d.substring(0,e));d=d.slice(e)}a.push(b[0]);d=d.slice(b[0].length);b=c.exec(d)}if(d){a.push(d)}return a},_addOutput:function(a){if(this.truncate){a=a.replace(/^(?:\r\n|\r|\n)/,"");this.truncate=false}else{if(this.opts.rmWhitespace){a=a.replace(/^\n/,"")}}if(!a){return a}a=a.replace(/\\/g,"\\\\");a=a.replace(/\n/g,"\\n");a=a.replace(/\r/g,"\\r");a=a.replace(/"/g,'\\"');this.source+='    ; __append("'+a+'")\n'},scanLine:function(a){var b=this;var e=this.opts.delimiter;var c=0;c=(a.split("\n").length-1);switch(a){case"<"+e:case"<"+e+"_":this.mode=Template.modes.EVAL;break;case"<"+e+"=":this.mode=Template.modes.ESCAPED;break;case"<"+e+"-":this.mode=Template.modes.RAW;break;case"<"+e+"#":this.mode=Template.modes.COMMENT;break;case"<"+e+e:this.mode=Template.modes.LITERAL;this.source+='    ; __append("'+a.replace("<"+e+e,"<"+e)+'")\n';break;case e+e+">":this.mode=Template.modes.LITERAL;this.source+='    ; __append("'+a.replace(e+e+">",e+">")+'")\n';break;case e+">":case"-"+e+">":case"_"+e+">":if(this.mode==Template.modes.LITERAL){this._addOutput(a)}this.mode=null;this.truncate=a.indexOf("-")===0||a.indexOf("_")===0;break;default:if(this.mode){switch(this.mode){case Template.modes.EVAL:case Template.modes.ESCAPED:case Template.modes.RAW:if(a.lastIndexOf("//")>a.lastIndexOf("\n")){a+="\n"}}switch(this.mode){case Template.modes.EVAL:this.source+="    ; "+a+"\n";break;case Template.modes.ESCAPED:this.source+="    ; __append(escapeFn("+stripSemi(a)+"))\n";break;case Template.modes.RAW:this.source+="    ; __append("+stripSemi(a)+")\n";break;case Template.modes.COMMENT:break;case Template.modes.LITERAL:this._addOutput(a);break}}else{this._addOutput(a)}}if(b.opts.compileDebug&&c){this.currentLine+=c;this.source+="    ; __line = "+this.currentLine+"\n"}}};exports.escapeXML=utils.escapeXML;exports.__express=exports.renderFile;if(require.extensions){require.extensions[".ejs"]=function(c,f){var a=f||c.filename;var b={filename:a,client:true};var e=fileLoader(a).toString();var d=exports.compile(e,b);c._compile("module.exports = "+d.toString()+";",a)}}exports.VERSION=_VERSION_STRING;exports.name=_NAME;if(typeof window!="undefined"){window.ejs=exports};