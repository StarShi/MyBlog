"use strict";const dns=require("dns");const tcp=require("net");const Message=require("../mime");Message.CRLF="\r\n";function SMTP(a){return this}function connectMx(c,d){var b=[];function a(e){if(e>=b.length){return d(new Error("can not connect to any SMTP server"))}var f=tcp.connect(25,b[e],function(g){if(g){console.error("Error on connectMx for: ",b[e],g);return a(e++)}console.log("MX connection created: ",b[e]);d(null,f)})}dns.resolveMx(c,function(f,e){b=(e||[]).sort(function(h,g){return h.priority-g.priority}).map(function(g){return g.exchange}).concat([c]);a(0)})}SMTP.send=function(b){var a=new SMTP.Client();return a.send(b)};SMTP.prototype.post=function(e,h,c,b,g){var a=[],d=0;function f(j,i){return j+(i?(" "+i):"")}a.push(f("MAIL",Message.kv("FROM",Message.q(h.address))));a=a.concat(c.map(function(i){return f("RCPT",Message.kv("TO",Message.q(i)))}));a.push("DATA");a.push("QUIT");a.push("");connectMx(e,function(l,k){if(l){return g(l)}function i(q){console.log("<- %s",q);k.write(q+Message.CRLF)}function j(q,r){switch(q){case 220:if(/ESMTP/i.test(r)){i(f("EHLO",h.host))}else{i(f("HELO",h.host))}break;case 221:k.end();break;case 250:i(a[d++]);break;case 354:i(b);i("");i(".");i("");break;default:console.error("-x SMTP responds error code %s",q);k.end();break}}var p="";function o(q){console.log("-> %s",q);p+=(q+Message.CRLF);if(/^\d+\s/.test(q)){j(parseInt(q,10),p);p=""}}var m="",n=[];k.on("error",function(){console.error("-x fail to connect ")}).on("data",function(q){m+=q;n=m.split(Message.CRLF);m=n.pop();n.forEach(o)})})};SMTP.prototype.send=function(b,e){if(!(b instanceof Message)){b=new Message(b)}var d={},a=[];if(b.to){a.push(b.to)}if(b.cc){a.push(b.cc)}if(b.bcc){a.push(b.bcc)}a=a.map(function(g){var f=Message.parseAddress(g);(d[f.host]||(d[f.host]=[])).push(f.address);return f.address});var c=Message.parseAddress(b.from);Object.keys(d).map(function(f){this.post(f,c,d[f],b.toString(),e)}.bind(this));return this};SMTP.Client=SMTP;SMTP.Server=require("./server");SMTP.createServer=function(a){return new SMTP.Server(a)};module.exports=SMTP;