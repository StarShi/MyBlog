var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits;function jsmemcmp(f,d,e,c,a){for(var b=0;b<a;++b,++d,++c){if(f[d]!==e[c]){return false}}return true}function SBMH(d){if(typeof d==="string"){d=new Buffer(d)}var b,a,c=d.length;this.maxMatches=Infinity;this.matches=0;this._occ=new Array(256);this._lookbehind_size=0;this._needle=d;this._bufpos=0;this._lookbehind=new Buffer(c);for(a=0;a<256;++a){this._occ[a]=c}if(c>=1){for(b=0;b<c-1;++b){this._occ[d[b]]=c-1-b}}}inherits(SBMH,EventEmitter);SBMH.prototype.reset=function(){this._lookbehind_size=0;this.matches=0;this._bufpos=0};SBMH.prototype.push=function(a,d){var b,c;if(!Buffer.isBuffer(a)){a=new Buffer(a,"binary")}c=a.length;this._bufpos=d||0;while(b!==c&&this.matches<this.maxMatches){b=this._sbmh_feed(a)}return b};SBMH.prototype._sbmh_feed=function(f){var g=f.length,d=this._needle,b=d.length;var h=-this._lookbehind_size,c=d[b-1],e=this._occ,j=this._lookbehind;if(h<0){while(h<0&&h<=g-b){var a=this._sbmh_lookup_char(f,h+b-1);if(a===c&&this._sbmh_memcmp(f,h,b-1)){this._lookbehind_size=0;++this.matches;if(h>-this._lookbehind_size){this.emit("info",true,j,0,this._lookbehind_size+h)}else{this.emit("info",true)}this._bufpos=h+b;return h+b}else{h+=e[a]}}if(h<0){while(h<0&&!this._sbmh_memcmp(f,h,g-h)){h++}}if(h>=0){this.emit("info",false,j,0,this._lookbehind_size);this._lookbehind_size=0}else{var i=this._lookbehind_size+h;if(i>0){this.emit("info",false,j,0,i)}j.copy(j,0,i,this._lookbehind_size-i);this._lookbehind_size-=i;f.copy(j,this._lookbehind_size);this._lookbehind_size+=g;this._bufpos=g;return g}}if(h>=0){h+=this._bufpos}while(h<=g-b){var a=f[h+b-1];if(a===c&&f[h]===d[0]&&jsmemcmp(d,0,f,h,b-1)){++this.matches;if(h>0){this.emit("info",true,f,this._bufpos,h)}else{this.emit("info",true)}this._bufpos=h+b;return h+b}else{h+=e[a]}}if(h<g){while(h<g&&(f[h]!==d[0]||!jsmemcmp(f,h,d,0,g-h))){++h}if(h<g){f.copy(j,0,h,h+(g-h));this._lookbehind_size=g-h}}if(h>0){this.emit("info",false,f,this._bufpos,h<g?h:g)}this._bufpos=g;return g};SBMH.prototype._sbmh_lookup_char=function(a,b){if(b<0){return this._lookbehind[this._lookbehind_size+b]}else{return a[b]}};SBMH.prototype._sbmh_memcmp=function(c,d,a){var b=0;while(b<a){if(this._sbmh_lookup_char(c,d+b)===this._needle[b]){++b}else{return false}}return true};module.exports=SBMH;