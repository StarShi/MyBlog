/*!
 * on-finished
 * Copyright(c) 2013 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";module.exports=onFinished;module.exports.isFinished=isFinished;var first=require("ee-first");var defer=typeof setImmediate==="function"?setImmediate:function(a){process.nextTick(a.bind.apply(a,arguments))};function onFinished(b,a){if(isFinished(b)!==false){defer(a,null,b);return b}attachListener(b,a);return b}function isFinished(b){var a=b.socket;if(typeof b.finished==="boolean"){return Boolean(b.finished||(a&&!a.writable))}if(typeof b.complete==="boolean"){return Boolean(b.upgrade||!a||!a.readable||(b.complete&&!b.readable))}return undefined}function attachFinishedListener(e,g){var a;var c;var f=false;function d(h){a.cancel();c.cancel();f=true;g(h)}a=c=first([[e,"end","finish"]],d);function b(h){e.removeListener("socket",b);if(f){return}if(a!==c){return}c=first([[h,"error","close"]],d)}if(e.socket){b(e.socket);return}e.on("socket",b);if(e.socket===undefined){patchAssignSocket(e,b)}}function attachListener(c,b){var a=c.__onFinished;if(!a||!a.queue){a=c.__onFinished=createListener(c);attachFinishedListener(c,a)}a.queue.push(b)}function createListener(b){function a(e){if(b.__onFinished===a){b.__onFinished=null}if(!a.queue){return}var c=a.queue;a.queue=null;for(var d=0;d<c.length;d++){c[d](e,b)}}a.queue=[];return a}function patchAssignSocket(a,d){var b=a.assignSocket;if(typeof b!=="function"){return}a.assignSocket=function c(e){b.call(this,e);d(e)}};