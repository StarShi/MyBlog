/*!
 * raw-body
 * Copyright(c) 2013-2014 Jonathan Ong
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var bytes=require("bytes");var createError=require("http-errors");var iconv=require("iconv-lite");var unpipe=require("unpipe");module.exports=getRawBody;var ICONV_ENCODING_MESSAGE_REGEXP=/^Encoding not recognized: /;function getDecoder(a){if(!a){return null}try{return iconv.getDecoder(a)}catch(b){if(!ICONV_ENCODING_MESSAGE_REGEXP.test(b.message)){throw b}throw createError(415,"specified encoding unsupported",{encoding:a,type:"encoding.unsupported"})}}function getRawBody(h,i,g){var f=g;var a=i||{};if(i===true||typeof i==="string"){a={encoding:i}}if(typeof i==="function"){f=i;a={}}if(f!==undefined&&typeof f!=="function"){throw new TypeError("argument callback must be a function")}if(!f&&!global.Promise){throw new TypeError("argument callback is required")}var b=a.encoding!==true?a.encoding:"utf-8";var e=bytes.parse(a.limit);var c=a.length!=null&&!isNaN(a.length)?parseInt(a.length,10):null;if(f){return readStream(h,b,c,e,f)}return new Promise(function d(l,k){readStream(h,b,c,e,function j(n,m){if(n){return k(n)}l(m)})})}function halt(a){unpipe(a);if(typeof a.pause==="function"){a.pause()}}function readStream(q,f,g,k,p){var e=false;var o=true;if(k!==null&&g!==null&&g>k){return l(createError(413,"request entity too large",{expected:g,length:g,limit:k,type:"entity.too.large"}))}var c=q._readableState;if(q._decoder||(c&&(c.encoding||c.decoder))){return l(createError(500,"stream encoding should not be set",{type:"stream.encoding.set"}))}var n=0;var i;try{i=getDecoder(f)}catch(j){return l(j)}var m=i?"":[];q.on("aborted",b);q.on("close",d);q.on("data",h);q.on("end",a);q.on("error",a);o=false;function l(){var s=new Array(arguments.length);for(var t=0;t<s.length;t++){s[t]=arguments[t]}e=true;if(o){process.nextTick(r)}else{r()}function r(){d();if(s[0]){halt(q)}p.apply(null,s)}}function b(){if(e){return}l(createError(400,"request aborted",{code:"ECONNABORTED",expected:g,length:g,received:n,type:"request.aborted"}))}function h(r){if(e){return}n+=r.length;if(k!==null&&n>k){l(createError(413,"request entity too large",{limit:k,received:n,type:"entity.too.large"}))}else{if(i){m+=i.write(r)}else{m.push(r)}}}function a(s){if(e){return}if(s){return l(s)}if(g!==null&&n!==g){l(createError(400,"request size did not match content length",{expected:g,length:g,received:n,type:"request.size.invalid"}))}else{var r=i?m+(i.end()||""):Buffer.concat(m);l(null,r)}}function d(){m=null;q.removeListener("aborted",b);q.removeListener("data",h);q.removeListener("end",a);q.removeListener("error",a);q.removeListener("close",d)}};