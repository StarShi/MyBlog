/*!
 * proxy-addr
 * Copyright(c) 2014-2016 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";module.exports=proxyaddr;module.exports.all=alladdrs;module.exports.compile=compile;var forwarded=require("forwarded");var ipaddr=require("ipaddr.js");var DIGIT_REGEXP=/^[0-9]+$/;var isip=ipaddr.isValid;var parseip=ipaddr.parse;var IP_RANGES={linklocal:["169.254.0.0/16","fe80::/10"],loopback:["127.0.0.1/8","::1/128"],uniquelocal:["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","fc00::/7"]};function alladdrs(c,d){var b=forwarded(c);if(!d){return b}if(typeof d!=="function"){d=compile(d)}for(var a=0;a<b.length-1;a++){if(d(b[a],a)){continue}b.length=a+1}return b}function compile(b){if(!b){throw new TypeError("argument is required")}var c;if(typeof b==="string"){c=[b]}else{if(Array.isArray(b)){c=b.slice()}else{throw new TypeError("unsupported trust argument")}}for(var a=0;a<c.length;a++){b=c[a];if(!IP_RANGES.hasOwnProperty(b)){continue}b=IP_RANGES[b];c.splice.apply(c,[a,1].concat(b));a+=b.length-1}return compileTrust(compileRangeSubnets(c))}function compileRangeSubnets(a){var c=new Array(a.length);for(var b=0;b<a.length;b++){c[b]=parseipNotation(a[b])}return c}function compileTrust(b){var a=b.length;return a===0?trustNone:a===1?trustSingle(b[0]):trustMulti(b)}function parseipNotation(c){var f=c.lastIndexOf("/");var e=f!==-1?c.substring(0,f):c;if(!isip(e)){throw new TypeError("invalid IP address: "+e)}var d=parseip(e);if(f===-1&&d.kind()==="ipv6"&&d.isIPv4MappedAddress()){d=d.toIPv4Address()}var a=d.kind()==="ipv6"?128:32;var b=f!==-1?c.substring(f+1,c.length):null;if(b===null){b=a}else{if(DIGIT_REGEXP.test(b)){b=parseInt(b,10)}else{if(d.kind()==="ipv4"&&isip(b)){b=parseNetmask(b)}else{b=null}}}if(b<=0||b>a){throw new TypeError("invalid range on address: "+c)}return[d,b]}function parseNetmask(b){var c=parseip(b);var a=c.kind();return a==="ipv4"?c.prefixLengthFromSubnetMask():null}function proxyaddr(b,d){if(!b){throw new TypeError("req argument is required")}if(!d){throw new TypeError("trust argument is required")}var a=alladdrs(b,d);var c=a[a.length-1];return c}function trustNone(){return false}function trustMulti(a){return function b(l){if(!isip(l)){return false}var k=parseip(l);var f;var e=k.kind();for(var g=0;g<a.length;g++){var d=a[g];var m=d[0];var c=m.kind();var j=d[1];var h=k;if(e!==c){if(c==="ipv4"&&!k.isIPv4MappedAddress()){continue}if(!f){f=c==="ipv4"?k.toIPv4Address():k.toIPv4MappedAddress()}h=f}if(h.match(m,j)){return true}}return false}}function trustSingle(c){var b=c[0];var f=b.kind();var d=f==="ipv4";var a=c[1];return function e(i){if(!isip(i)){return false}var h=parseip(i);var g=h.kind();if(g!==f){if(d&&!h.isIPv4MappedAddress()){return false}h=d?h.toIPv4Address():h.toIPv4MappedAddress()}return h.match(b,a)}};