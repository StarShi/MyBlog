"use strict";var test=require("tape");var qs=require("../");var utils=require("../lib/utils");var iconv=require("iconv-lite");test("stringify()",function(a){a.test("stringifies a querystring object",function(b){b.equal(qs.stringify({a:"b"}),"a=b");b.equal(qs.stringify({a:1}),"a=1");b.equal(qs.stringify({a:1,b:2}),"a=1&b=2");b.equal(qs.stringify({a:"A_Z"}),"a=A_Z");b.equal(qs.stringify({a:"€"}),"a=%E2%82%AC");b.equal(qs.stringify({a:""}),"a=%EE%80%80");b.equal(qs.stringify({a:"א"}),"a=%D7%90");b.equal(qs.stringify({a:"𐐷"}),"a=%F0%90%90%B7");b.end()});a.test("adds query prefix",function(b){b.equal(qs.stringify({a:"b"},{addQueryPrefix:true}),"?a=b");b.end()});a.test("with query prefix, outputs blank string given an empty object",function(b){b.equal(qs.stringify({},{addQueryPrefix:true}),"");b.end()});a.test("stringifies a nested object",function(b){b.equal(qs.stringify({a:{b:"c"}}),"a%5Bb%5D=c");b.equal(qs.stringify({a:{b:{c:{d:"e"}}}}),"a%5Bb%5D%5Bc%5D%5Bd%5D=e");b.end()});a.test("stringifies a nested object with dots notation",function(b){b.equal(qs.stringify({a:{b:"c"}},{allowDots:true}),"a.b=c");b.equal(qs.stringify({a:{b:{c:{d:"e"}}}},{allowDots:true}),"a.b.c.d=e");b.end()});a.test("stringifies an array value",function(b){b.equal(qs.stringify({a:["b","c","d"]},{arrayFormat:"indices"}),"a%5B0%5D=b&a%5B1%5D=c&a%5B2%5D=d","indices => indices");b.equal(qs.stringify({a:["b","c","d"]},{arrayFormat:"brackets"}),"a%5B%5D=b&a%5B%5D=c&a%5B%5D=d","brackets => brackets");b.equal(qs.stringify({a:["b","c","d"]}),"a%5B0%5D=b&a%5B1%5D=c&a%5B2%5D=d","default => indices");b.end()});a.test("omits nulls when asked",function(b){b.equal(qs.stringify({a:"b",c:null},{skipNulls:true}),"a=b");b.end()});a.test("omits nested nulls when asked",function(b){b.equal(qs.stringify({a:{b:"c",d:null}},{skipNulls:true}),"a%5Bb%5D=c");b.end()});a.test("omits array indices when asked",function(b){b.equal(qs.stringify({a:["b","c","d"]},{indices:false}),"a=b&a=c&a=d");b.end()});a.test("stringifies a nested array value",function(b){b.equal(qs.stringify({a:{b:["c","d"]}},{arrayFormat:"indices"}),"a%5Bb%5D%5B0%5D=c&a%5Bb%5D%5B1%5D=d");b.equal(qs.stringify({a:{b:["c","d"]}},{arrayFormat:"brackets"}),"a%5Bb%5D%5B%5D=c&a%5Bb%5D%5B%5D=d");b.equal(qs.stringify({a:{b:["c","d"]}}),"a%5Bb%5D%5B0%5D=c&a%5Bb%5D%5B1%5D=d");b.end()});a.test("stringifies a nested array value with dots notation",function(b){b.equal(qs.stringify({a:{b:["c","d"]}},{allowDots:true,encode:false,arrayFormat:"indices"}),"a.b[0]=c&a.b[1]=d","indices: stringifies with dots + indices");b.equal(qs.stringify({a:{b:["c","d"]}},{allowDots:true,encode:false,arrayFormat:"brackets"}),"a.b[]=c&a.b[]=d","brackets: stringifies with dots + brackets");b.equal(qs.stringify({a:{b:["c","d"]}},{allowDots:true,encode:false}),"a.b[0]=c&a.b[1]=d","default: stringifies with dots + indices");b.end()});a.test("stringifies an object inside an array",function(b){b.equal(qs.stringify({a:[{b:"c"}]},{arrayFormat:"indices"}),"a%5B0%5D%5Bb%5D=c","indices => brackets");b.equal(qs.stringify({a:[{b:"c"}]},{arrayFormat:"brackets"}),"a%5B%5D%5Bb%5D=c","brackets => brackets");b.equal(qs.stringify({a:[{b:"c"}]}),"a%5B0%5D%5Bb%5D=c","default => indices");b.equal(qs.stringify({a:[{b:{c:[1]}}]},{arrayFormat:"indices"}),"a%5B0%5D%5Bb%5D%5Bc%5D%5B0%5D=1","indices => indices");b.equal(qs.stringify({a:[{b:{c:[1]}}]},{arrayFormat:"brackets"}),"a%5B%5D%5Bb%5D%5Bc%5D%5B%5D=1","brackets => brackets");b.equal(qs.stringify({a:[{b:{c:[1]}}]}),"a%5B0%5D%5Bb%5D%5Bc%5D%5B0%5D=1","default => indices");b.end()});a.test("stringifies an array with mixed objects and primitives",function(b){b.equal(qs.stringify({a:[{b:1},2,3]},{encode:false,arrayFormat:"indices"}),"a[0][b]=1&a[1]=2&a[2]=3","indices => indices");b.equal(qs.stringify({a:[{b:1},2,3]},{encode:false,arrayFormat:"brackets"}),"a[][b]=1&a[]=2&a[]=3","brackets => brackets");b.equal(qs.stringify({a:[{b:1},2,3]},{encode:false}),"a[0][b]=1&a[1]=2&a[2]=3","default => indices");b.end()});a.test("stringifies an object inside an array with dots notation",function(b){b.equal(qs.stringify({a:[{b:"c"}]},{allowDots:true,encode:false,arrayFormat:"indices"}),"a[0].b=c","indices => indices");b.equal(qs.stringify({a:[{b:"c"}]},{allowDots:true,encode:false,arrayFormat:"brackets"}),"a[].b=c","brackets => brackets");b.equal(qs.stringify({a:[{b:"c"}]},{allowDots:true,encode:false}),"a[0].b=c","default => indices");b.equal(qs.stringify({a:[{b:{c:[1]}}]},{allowDots:true,encode:false,arrayFormat:"indices"}),"a[0].b.c[0]=1","indices => indices");b.equal(qs.stringify({a:[{b:{c:[1]}}]},{allowDots:true,encode:false,arrayFormat:"brackets"}),"a[].b.c[]=1","brackets => brackets");b.equal(qs.stringify({a:[{b:{c:[1]}}]},{allowDots:true,encode:false}),"a[0].b.c[0]=1","default => indices");b.end()});a.test("does not omit object keys when indices = false",function(b){b.equal(qs.stringify({a:[{b:"c"}]},{indices:false}),"a%5Bb%5D=c");b.end()});a.test("uses indices notation for arrays when indices=true",function(b){b.equal(qs.stringify({a:["b","c"]},{indices:true}),"a%5B0%5D=b&a%5B1%5D=c");b.end()});a.test("uses indices notation for arrays when no arrayFormat is specified",function(b){b.equal(qs.stringify({a:["b","c"]}),"a%5B0%5D=b&a%5B1%5D=c");b.end()});a.test("uses indices notation for arrays when no arrayFormat=indices",function(b){b.equal(qs.stringify({a:["b","c"]},{arrayFormat:"indices"}),"a%5B0%5D=b&a%5B1%5D=c");b.end()});a.test("uses repeat notation for arrays when no arrayFormat=repeat",function(b){b.equal(qs.stringify({a:["b","c"]},{arrayFormat:"repeat"}),"a=b&a=c");b.end()});a.test("uses brackets notation for arrays when no arrayFormat=brackets",function(b){b.equal(qs.stringify({a:["b","c"]},{arrayFormat:"brackets"}),"a%5B%5D=b&a%5B%5D=c");b.end()});a.test("stringifies a complicated object",function(b){b.equal(qs.stringify({a:{b:"c",d:"e"}}),"a%5Bb%5D=c&a%5Bd%5D=e");b.end()});a.test("stringifies an empty value",function(b){b.equal(qs.stringify({a:""}),"a=");b.equal(qs.stringify({a:null},{strictNullHandling:true}),"a");b.equal(qs.stringify({a:"",b:""}),"a=&b=");b.equal(qs.stringify({a:null,b:""},{strictNullHandling:true}),"a&b=");b.equal(qs.stringify({a:{b:""}}),"a%5Bb%5D=");b.equal(qs.stringify({a:{b:null}},{strictNullHandling:true}),"a%5Bb%5D");b.equal(qs.stringify({a:{b:null}},{strictNullHandling:false}),"a%5Bb%5D=");b.end()});a.test("stringifies a null object",{skip:!Object.create},function(b){var c=Object.create(null);c.a="b";b.equal(qs.stringify(c),"a=b");b.end()});a.test("returns an empty string for invalid input",function(b){b.equal(qs.stringify(undefined),"");b.equal(qs.stringify(false),"");b.equal(qs.stringify(null),"");b.equal(qs.stringify(""),"");b.end()});a.test("stringifies an object with a null object as a child",{skip:!Object.create},function(b){var c={a:Object.create(null)};c.a.b="c";b.equal(qs.stringify(c),"a%5Bb%5D=c");b.end()});a.test("drops keys with a value of undefined",function(b){b.equal(qs.stringify({a:undefined}),"");b.equal(qs.stringify({a:{b:undefined,c:null}},{strictNullHandling:true}),"a%5Bc%5D");b.equal(qs.stringify({a:{b:undefined,c:null}},{strictNullHandling:false}),"a%5Bc%5D=");b.equal(qs.stringify({a:{b:undefined,c:""}}),"a%5Bc%5D=");b.end()});a.test("url encodes values",function(b){b.equal(qs.stringify({a:"b c"}),"a=b%20c");b.end()});a.test("stringifies a date",function(c){var b=new Date();var d="a="+encodeURIComponent(b.toISOString());c.equal(qs.stringify({a:b}),d);c.end()});a.test("stringifies the weird object from qs",function(b){b.equal(qs.stringify({"my weird field":"~q1!2\"'w$5&7/z8)?"}),"my%20weird%20field=~q1%212%22%27w%245%267%2Fz8%29%3F");b.end()});a.test("skips properties that are part of the object prototype",function(b){Object.prototype.crash="test";b.equal(qs.stringify({a:"b"}),"a=b");b.equal(qs.stringify({a:{b:"c"}}),"a%5Bb%5D=c");delete Object.prototype.crash;b.end()});a.test("stringifies boolean values",function(b){b.equal(qs.stringify({a:true}),"a=true");b.equal(qs.stringify({a:{b:true}}),"a%5Bb%5D=true");b.equal(qs.stringify({b:false}),"b=false");b.equal(qs.stringify({b:{c:false}}),"b%5Bc%5D=false");b.end()});a.test("stringifies buffer values",function(b){b.equal(qs.stringify({a:new Buffer("test")}),"a=test");b.equal(qs.stringify({a:{b:new Buffer("test")}}),"a%5Bb%5D=test");b.end()});a.test("stringifies an object using an alternative delimiter",function(b){b.equal(qs.stringify({a:"b",c:"d"},{delimiter:";"}),"a=b;c=d");b.end()});a.test("doesn't blow up when Buffer global is missing",function(c){var d=global.Buffer;delete global.Buffer;var b=qs.stringify({a:"b",c:"d"});global.Buffer=d;c.equal(b,"a=b&c=d");c.end()});a.test("selects properties when filter=array",function(b){b.equal(qs.stringify({a:"b"},{filter:["a"]}),"a=b");b.equal(qs.stringify({a:1},{filter:[]}),"");b.equal(qs.stringify({a:{b:[1,2,3,4],c:"d"},c:"f"},{filter:["a","b",0,2],arrayFormat:"indices"}),"a%5Bb%5D%5B0%5D=1&a%5Bb%5D%5B2%5D=3","indices => indices");b.equal(qs.stringify({a:{b:[1,2,3,4],c:"d"},c:"f"},{filter:["a","b",0,2],arrayFormat:"brackets"}),"a%5Bb%5D%5B%5D=1&a%5Bb%5D%5B%5D=3","brackets => brackets");b.equal(qs.stringify({a:{b:[1,2,3,4],c:"d"},c:"f"},{filter:["a","b",0,2]}),"a%5Bb%5D%5B0%5D=1&a%5Bb%5D%5B2%5D=3","default => indices");b.end()});a.test("supports custom representations when filter=function",function(b){var c=0;var e={a:"b",c:"d",e:{f:new Date(1257894000000)}};var d=function(g,f){c+=1;if(c===1){b.equal(g,"","prefix is empty");b.equal(f,e)}else{if(g==="c"){return void 0}else{if(f instanceof Date){b.equal(g,"e[f]");return f.getTime()}}}return f};b.equal(qs.stringify(e,{filter:d}),"a=b&e%5Bf%5D=1257894000000");b.equal(c,5);b.end()});a.test("can disable uri encoding",function(b){b.equal(qs.stringify({a:"b"},{encode:false}),"a=b");b.equal(qs.stringify({a:{b:"c"}},{encode:false}),"a[b]=c");b.equal(qs.stringify({a:"b",c:null},{strictNullHandling:true,encode:false}),"a=b&c");b.end()});a.test("can sort the keys",function(b){var c=function(e,d){return e.localeCompare(d)};b.equal(qs.stringify({a:"c",z:"y",b:"f"},{sort:c}),"a=c&b=f&z=y");b.equal(qs.stringify({a:"c",z:{j:"a",i:"b"},b:"f"},{sort:c}),"a=c&b=f&z%5Bi%5D=b&z%5Bj%5D=a");b.end()});a.test("can sort the keys at depth 3 or more too",function(b){var c=function(e,d){return e.localeCompare(d)};b.equal(qs.stringify({a:"a",z:{zj:{zjb:"zjb",zja:"zja"},zi:{zib:"zib",zia:"zia"}},b:"b"},{sort:c,encode:false}),"a=a&b=b&z[zi][zia]=zia&z[zi][zib]=zib&z[zj][zja]=zja&z[zj][zjb]=zjb");b.equal(qs.stringify({a:"a",z:{zj:{zjb:"zjb",zja:"zja"},zi:{zib:"zib",zia:"zia"}},b:"b"},{sort:null,encode:false}),"a=a&z[zj][zjb]=zjb&z[zj][zja]=zja&z[zi][zib]=zib&z[zi][zia]=zia&b=b");b.end()});a.test("can stringify with custom encoding",function(b){b.equal(qs.stringify({県:"大阪府","":""},{encoder:function(f){if(f.length===0){return""}var d=iconv.encode(f,"shiftjis");var c=[];for(var e=0;e<d.length;++e){c.push(d.readUInt8(e).toString(16))}return"%"+c.join("%")}}),"%8c%a7=%91%e5%8d%e3%95%7b&=");b.end()});a.test("receives the default encoder as a second argument",function(b){b.plan(2);qs.stringify({a:1},{encoder:function(d,c){b.equal(c,utils.encode)}});b.end()});a.test("throws error with wrong encoder",function(b){b["throws"](function(){qs.stringify({},{encoder:"string"})},new TypeError("Encoder has to be a function."));b.end()});a.test("can use custom encoder for a buffer object",{skip:typeof Buffer==="undefined"},function(b){b.equal(qs.stringify({a:new Buffer([1])},{encoder:function(c){if(typeof c==="string"){return c}return String.fromCharCode(c.readUInt8(0)+97)}}),"a=b");b.end()});a.test("serializeDate option",function(c){var b=new Date();c.equal(qs.stringify({a:b}),"a="+b.toISOString().replace(/:/g,"%3A"),"default is toISOString");var d=new Date();d.toISOString=function(){throw new SyntaxError()};c["throws"](function(){d.toISOString()},SyntaxError);c.equal(qs.stringify({a:d}),"a="+Date.prototype.toISOString.call(d).replace(/:/g,"%3A"),"toISOString works even when method is not locally present");var e=new Date(6);c.equal(qs.stringify({a:e},{serializeDate:function(f){return f.getTime()*7}}),"a=42","custom serializeDate function called");c.end()});a.test("RFC 1738 spaces serialization",function(b){b.equal(qs.stringify({a:"b c"},{format:qs.formats.RFC1738}),"a=b+c");b.equal(qs.stringify({"a b":"c d"},{format:qs.formats.RFC1738}),"a+b=c+d");b.end()});a.test("RFC 3986 spaces serialization",function(b){b.equal(qs.stringify({a:"b c"},{format:qs.formats.RFC3986}),"a=b%20c");b.equal(qs.stringify({"a b":"c d"},{format:qs.formats.RFC3986}),"a%20b=c%20d");b.end()});a.test("Backward compatibility to RFC 3986",function(b){b.equal(qs.stringify({a:"b c"}),"a=b%20c");b.end()});a.test("Edge cases and unknown formats",function(b){["UFO1234",false,1234,null,{},[]].forEach(function(c){b["throws"](function(){qs.stringify({a:"b c"},{format:c})},new TypeError("Unknown format option provided."))});b.end()});a.test("encodeValuesOnly",function(b){b.equal(qs.stringify({a:"b",c:["d","e=f"],f:[["g"],["h"]]},{encodeValuesOnly:true}),"a=b&c[0]=d&c[1]=e%3Df&f[0][0]=g&f[1][0]=h");b.equal(qs.stringify({a:"b",c:["d","e"],f:[["g"],["h"]]}),"a=b&c%5B0%5D=d&c%5B1%5D=e&f%5B0%5D%5B0%5D=g&f%5B1%5D%5B0%5D=h");b.end()});a.test("encodeValuesOnly - strictNullHandling",function(b){b.equal(qs.stringify({a:{b:null}},{encodeValuesOnly:true,strictNullHandling:true}),"a[b]");b.end()});a.test("does not mutate the options argument",function(c){var b={};qs.stringify({},b);c.deepEqual(b,{});c.end()});a.end()});