"use strict";var Buffer=require("buffer").Buffer;exports._dbcs=DBCSCodec;var UNASSIGNED=-1,GB18030_CODE=-2,SEQ_START=-10,NODE_START=-1000,UNASSIGNED_NODE=new Array(256),DEF_CHAR=-1;for(var i=0;i<256;i++){UNASSIGNED_NODE[i]=UNASSIGNED}function DBCSCodec(d,o){this.encodingName=d.encodingName;if(!d){throw new Error("DBCS codec is called without the data.")}if(!d.table){throw new Error("Encoding '"+this.encodingName+"' has no data.")}var n=d.table();this.decodeTables=[];this.decodeTables[0]=UNASSIGNED_NODE.slice(0);this.decodeTableSeq=[];for(var l=0;l<n.length;l++){this._addDecodeChunk(n[l])}this.defaultCharUnicode=o.defaultCharUnicode;this.encodeTable=[];this.encodeTableSeq=[];var m={};if(d.encodeSkipVals){for(var l=0;l<d.encodeSkipVals.length;l++){var c=d.encodeSkipVals[l];if(typeof c==="number"){m[c]=true}else{for(var k=c.from;k<=c.to;k++){m[k]=true}}}}this._fillEncodeTable(0,0,m);if(d.encodeAdd){for(var e in d.encodeAdd){if(Object.prototype.hasOwnProperty.call(d.encodeAdd,e)){this._setEncodeChar(e.charCodeAt(0),d.encodeAdd[e])}}}this.defCharSB=this.encodeTable[0][o.defaultCharSingleByte.charCodeAt(0)];if(this.defCharSB===UNASSIGNED){this.defCharSB=this.encodeTable[0]["?"]}if(this.defCharSB===UNASSIGNED){this.defCharSB="?".charCodeAt(0)}if(typeof d.gb18030==="function"){this.gb18030=d.gb18030();var h=this.decodeTables.length;var g=this.decodeTables[h]=UNASSIGNED_NODE.slice(0);var a=this.decodeTables.length;var f=this.decodeTables[a]=UNASSIGNED_NODE.slice(0);for(var l=129;l<=254;l++){var b=NODE_START-this.decodeTables[0][l];var p=this.decodeTables[b];for(var k=48;k<=57;k++){p[k]=NODE_START-h}}for(var l=129;l<=254;l++){g[l]=NODE_START-a}for(var l=48;l<=57;l++){f[l]=GB18030_CODE}}}DBCSCodec.prototype.encoder=DBCSEncoder;DBCSCodec.prototype.decoder=DBCSDecoder;DBCSCodec.prototype._getDecodeTrieNode=function(e){var a=[];for(;e>0;e>>=8){a.push(e&255)}if(a.length==0){a.push(0)}var c=this.decodeTables[0];for(var b=a.length-1;b>0;b--){var d=c[a[b]];if(d==UNASSIGNED){c[a[b]]=NODE_START-this.decodeTables.length;this.decodeTables.push(c=UNASSIGNED_NODE.slice(0))}else{if(d<=NODE_START){c=this.decodeTables[NODE_START-d]}else{throw new Error("Overwrite byte in "+this.encodingName+", addr: "+e.toString(16))}}}return c};DBCSCodec.prototype._addDecodeChunk=function(h){var g=parseInt(h[0],16);var p=this._getDecodeTrieNode(g);g=g&255;for(var e=1;e<h.length;e++){var b=h[e];if(typeof b==="string"){for(var d=0;d<b.length;){var a=b.charCodeAt(d++);if(55296<=a&&a<56320){var o=b.charCodeAt(d++);if(56320<=o&&o<57344){p[g++]=65536+(a-55296)*1024+(o-56320)}else{throw new Error("Incorrect surrogate pair in "+this.encodingName+" at chunk "+h[0])}}else{if(4080<a&&a<=4095){var f=4095-a+2;var n=[];for(var c=0;c<f;c++){n.push(b.charCodeAt(d++))}p[g++]=SEQ_START-this.decodeTableSeq.length;this.decodeTableSeq.push(n)}else{p[g++]=a}}}}else{if(typeof b==="number"){var j=p[g-1]+1;for(var d=0;d<b;d++){p[g++]=j++}}else{throw new Error("Incorrect type '"+typeof b+"' given in "+this.encodingName+" at chunk "+h[0])}}}if(g>255){throw new Error("Incorrect chunk in "+this.encodingName+" at addr "+h[0]+": too long"+g)}};DBCSCodec.prototype._getEncodeBucket=function(a){var b=a>>8;if(this.encodeTable[b]===undefined){this.encodeTable[b]=UNASSIGNED_NODE.slice(0)}return this.encodeTable[b]};DBCSCodec.prototype._setEncodeChar=function(c,b){var d=this._getEncodeBucket(c);var a=c&255;if(d[a]<=SEQ_START){this.encodeTableSeq[SEQ_START-d[a]][DEF_CHAR]=b}else{if(d[a]==UNASSIGNED){d[a]=b}}};DBCSCodec.prototype._setEncodeSequence=function(e,b){var c=e[0];var h=this._getEncodeBucket(c);var a=c&255;var g;if(h[a]<=SEQ_START){g=this.encodeTableSeq[SEQ_START-h[a]]}else{g={};if(h[a]!==UNASSIGNED){g[DEF_CHAR]=h[a]}h[a]=SEQ_START-this.encodeTableSeq.length;this.encodeTableSeq.push(g)}for(var f=1;f<e.length-1;f++){var d=g[c];if(typeof d==="object"){g=d}else{g=g[c]={};if(d!==undefined){g[DEF_CHAR]=d}}}c=e[e.length-1];g[c]=b};DBCSCodec.prototype._fillEncodeTable=function(g,e,f){var d=this.decodeTables[g];for(var c=0;c<256;c++){var b=d[c];var a=e+c;if(f[a]){continue}if(b>=0){this._setEncodeChar(b,a)}else{if(b<=NODE_START){this._fillEncodeTable(NODE_START-b,a<<8,f)}else{if(b<=SEQ_START){this._setEncodeSequence(this.decodeTableSeq[SEQ_START-b],a)}}}}};function DBCSEncoder(a,b){this.leadSurrogate=-1;this.seqObj=undefined;this.encodeTable=b.encodeTable;this.encodeTableSeq=b.encodeTableSeq;this.defaultCharSingleByte=b.defCharSB;this.gb18030=b.gb18030}DBCSEncoder.prototype.write=function(l){var a=new Buffer(l.length*(this.gb18030?4:3)),f=this.leadSurrogate,k=this.seqObj,c=-1,h=0,g=0;while(true){if(c===-1){if(h==l.length){break}var e=l.charCodeAt(h++)}else{var e=c;c=-1}if(55296<=e&&e<57344){if(e<56320){if(f===-1){f=e;continue}else{f=e;e=UNASSIGNED}}else{if(f!==-1){e=65536+(f-55296)*1024+(e-56320);f=-1}else{e=UNASSIGNED}}}else{if(f!==-1){c=e;e=UNASSIGNED;f=-1}}var b=UNASSIGNED;if(k!==undefined&&e!=UNASSIGNED){var d=k[e];if(typeof d==="object"){k=d;continue}else{if(typeof d=="number"){b=d}else{if(d==undefined){d=k[DEF_CHAR];if(d!==undefined){b=d;c=e}else{}}}}k=undefined}else{if(e>=0){var n=this.encodeTable[e>>8];if(n!==undefined){b=n[e&255]}if(b<=SEQ_START){k=this.encodeTableSeq[SEQ_START-b];continue}if(b==UNASSIGNED&&this.gb18030){var m=findIdx(this.gb18030.uChars,e);if(m!=-1){var b=this.gb18030.gbChars[m]+(e-this.gb18030.uChars[m]);a[g++]=129+Math.floor(b/12600);b=b%12600;a[g++]=48+Math.floor(b/1260);b=b%1260;a[g++]=129+Math.floor(b/10);b=b%10;a[g++]=48+b;continue}}}}if(b===UNASSIGNED){b=this.defaultCharSingleByte}if(b<256){a[g++]=b}else{if(b<65536){a[g++]=b>>8;a[g++]=b&255}else{a[g++]=b>>16;a[g++]=(b>>8)&255;a[g++]=b&255}}}this.seqObj=k;this.leadSurrogate=f;return a.slice(0,g)};DBCSEncoder.prototype.end=function(){if(this.leadSurrogate===-1&&this.seqObj===undefined){return}var c=new Buffer(10),b=0;if(this.seqObj){var a=this.seqObj[DEF_CHAR];if(a!==undefined){if(a<256){c[b++]=a}else{c[b++]=a>>8;c[b++]=a&255}}else{}this.seqObj=undefined}if(this.leadSurrogate!==-1){c[b++]=this.defaultCharSingleByte;this.leadSurrogate=-1}return c.slice(0,b)};DBCSEncoder.prototype.findIdx=findIdx;function DBCSDecoder(a,b){this.nodeIdx=0;this.prevBuf=new Buffer(0);this.decodeTables=b.decodeTables;this.decodeTableSeq=b.decodeTableSeq;this.defaultCharUnicode=b.defaultCharUnicode;this.gb18030=b.gb18030}DBCSDecoder.prototype.write=function(d){var c=new Buffer(d.length*2),l=this.nodeIdx,e=this.prevBuf,r=this.prevBuf.length,o=-this.prevBuf.length,f;if(r>0){e=Buffer.concat([e,d.slice(0,10)])}for(var m=0,h=0;m<d.length;m++){var b=(m>=0)?d[m]:e[m+r];var f=this.decodeTables[l][b];if(f>=0){}else{if(f===UNASSIGNED){m=o;f=this.defaultCharUnicode.charCodeAt(0)}else{if(f===GB18030_CODE){var n=(o>=0)?d.slice(o,m+1):e.slice(o+r,m+1+r);var a=(n[0]-129)*12600+(n[1]-48)*1260+(n[2]-129)*10+(n[3]-48);var q=findIdx(this.gb18030.gbChars,a);f=this.gb18030.uChars[q]+a-this.gb18030.gbChars[q]}else{if(f<=NODE_START){l=NODE_START-f;continue}else{if(f<=SEQ_START){var s=this.decodeTableSeq[SEQ_START-f];for(var g=0;g<s.length-1;g++){f=s[g];c[h++]=f&255;c[h++]=f>>8}f=s[s.length-1]}else{throw new Error("iconv-lite internal error: invalid decoding table value "+f+" at "+l+"/"+b)}}}}}if(f>65535){f-=65536;var p=55296+Math.floor(f/1024);c[h++]=p&255;c[h++]=p>>8;f=56320+f%1024}c[h++]=f&255;c[h++]=f>>8;l=0;o=m+1}this.nodeIdx=l;this.prevBuf=(o>=0)?d.slice(o):e.slice(o+r);return c.slice(0,h).toString("ucs2")};DBCSDecoder.prototype.end=function(){var b="";while(this.prevBuf.length>0){b+=this.defaultCharUnicode;var a=this.prevBuf.slice(1);this.prevBuf=new Buffer(0);this.nodeIdx=0;if(a.length>0){b+=this.write(a)}}this.nodeIdx=0;return b};function findIdx(d,e){if(d[0]>e){return -1}var a=0,c=d.length;while(a<c-1){var b=a+Math.floor((c-a+1)/2);if(d[b]<=e){a=b}else{c=b}}return a};