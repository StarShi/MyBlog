"use strict";exports.__esModule=true;exports.calcLineCount=calcLineCount;exports.merge=merge;var _create=require("./create");var _parse=require("./parse");var _array=require("../util/array");function _toConsumableArray(a){if(Array.isArray(a)){for(var c=0,b=Array(a.length);c<a.length;c++){b[c]=a[c]}return b}else{return Array.from(a)}}function calcLineCount(a){var b=false;a.oldLines=0;a.newLines=0;a.lines.forEach(function(c){if(typeof c!=="string"){b=true;return}if(c[0]==="+"||c[0]===" "){a.newLines++}if(c[0]==="-"||c[0]===" "){a.oldLines++}});if(b){delete a.oldLines;delete a.newLines}}function merge(f,c,a){f=loadPatch(f,a);c=loadPatch(c,a);var e={};if(f.index||c.index){e.index=f.index||c.index}if(f.newFileName||c.newFileName){if(!fileNameChanged(f)){e.oldFileName=c.oldFileName||f.oldFileName;e.newFileName=c.newFileName||f.newFileName;e.oldHeader=c.oldHeader||f.oldHeader;e.newHeader=c.newHeader||f.newHeader}else{if(!fileNameChanged(c)){e.oldFileName=f.oldFileName;e.newFileName=f.newFileName;e.oldHeader=f.oldHeader;e.newHeader=f.newHeader}else{e.oldFileName=selectField(e,f.oldFileName,c.oldFileName);e.newFileName=selectField(e,f.newFileName,c.newFileName);e.oldHeader=selectField(e,f.oldHeader,c.oldHeader);e.newHeader=selectField(e,f.newHeader,c.newHeader)}}}e.hunks=[];var d=0,g=0,h=0,i=0;while(d<f.hunks.length||g<c.hunks.length){var b=f.hunks[d]||{oldStart:Infinity},k=c.hunks[g]||{oldStart:Infinity};if(hunkBefore(b,k)){e.hunks.push(cloneHunk(b,h));d++;i+=b.newLines-b.oldLines}else{if(hunkBefore(k,b)){e.hunks.push(cloneHunk(k,i));g++;h+=k.newLines-k.oldLines}else{var j={oldStart:Math.min(b.oldStart,k.oldStart),oldLines:0,newStart:Math.min(b.newStart+h,k.oldStart+i),newLines:0,lines:[]};mergeLines(j,b.oldStart,b.lines,k.oldStart,k.lines);g++;d++;e.hunks.push(j)}}}return e}function loadPatch(b,a){if(typeof b==="string"){if(/^@@/m.test(b)||/^Index:/m.test(b)){return((0,_parse.parsePatch)(b)[0])}if(!a){throw new Error("Must provide a base reference or pass in a patch")}return((0,_create.structuredPatch)(undefined,undefined,a,b))}return b}function fileNameChanged(a){return a.newFileName&&a.newFileName!==a.oldFileName}function selectField(a,c,b){if(c===b){return c}else{a.conflict=true;return{mine:c,theirs:b}}}function hunkBefore(b,a){return b.oldStart<a.oldStart&&b.oldStart+b.oldLines<a.oldStart}function cloneHunk(a,b){return{oldStart:a.oldStart,oldLines:a.oldLines,newStart:a.newStart+b,newLines:a.newLines,lines:a.lines}}function mergeLines(e,i,j,f,a){var h={offset:i,lines:j,index:0},d={offset:f,lines:a,index:0};insertLeading(e,h,d);insertLeading(e,d,h);while(h.index<h.lines.length&&d.index<d.lines.length){var b=h.lines[h.index],c=d.lines[d.index];if((b[0]==="-"||b[0]==="+")&&(c[0]==="-"||c[0]==="+")){mutualChange(e,h,d)}else{if(b[0]==="+"&&c[0]===" "){var g;(g=e.lines).push.apply(g,_toConsumableArray(collectChange(h)))}else{if(c[0]==="+"&&b[0]===" "){var k;(k=e.lines).push.apply(k,_toConsumableArray(collectChange(d)))}else{if(b[0]==="-"&&c[0]===" "){removal(e,h,d)}else{if(c[0]==="-"&&b[0]===" "){removal(e,d,h,true)}else{if(b===c){e.lines.push(b);h.index++;d.index++}else{conflict(e,collectChange(h),collectChange(d))}}}}}}}insertTrailing(e,h);insertTrailing(e,d);calcLineCount(e)}function mutualChange(c,h,g){var b=collectChange(h),a=collectChange(g);if(allRemoves(b)&&allRemoves(a)){if((0,_array.arrayStartsWith)(b,a)&&skipRemoveSuperset(g,b,b.length-a.length)){var f;(f=c.lines).push.apply(f,_toConsumableArray(b));return}else{if((0,_array.arrayStartsWith)(a,b)&&skipRemoveSuperset(h,a,a.length-b.length)){var e;(e=c.lines).push.apply(e,_toConsumableArray(a));return}}}else{if((0,_array.arrayEqual)(b,a)){var d;(d=c.lines).push.apply(d,_toConsumableArray(b));return}}conflict(c,b,a)}function removal(d,g,f,e){var c=collectChange(g),a=collectContext(f,c);if(a.merged){var b;(b=d.lines).push.apply(b,_toConsumableArray(a.merged))}else{conflict(d,e?a:c,e?c:a)}}function conflict(a,c,b){a.conflict=true;a.lines.push({conflict:true,mine:c,theirs:b})}function insertLeading(b,c,d){while(c.offset<d.offset&&c.index<c.lines.length){var a=c.lines[c.index++];b.lines.push(a);c.offset++}}function insertTrailing(b,c){while(c.index<c.lines.length){var a=c.lines[c.index++];b.lines.push(a)}}function collectChange(d){var c=[],b=d.lines[d.index][0];while(d.index<d.lines.length){var a=d.lines[d.index];if(b==="-"&&a[0]==="+"){b="+"}if(b===a[0]){c.push(a);d.index++}else{break}}return c}function collectContext(a,b){var g=[],i=[],h=0,e=false,c=false;while(h<b.length&&a.index<a.lines.length){var f=a.lines[a.index],d=b[h];if(d[0]==="+"){break}e=e||f[0]!==" ";i.push(d);h++;if(f[0]==="+"){c=true;while(f[0]==="+"){g.push(f);f=a.lines[++a.index]}}if(d.substr(1)===f.substr(1)){g.push(f);a.index++}else{c=true}}if((b[h]||"")[0]==="+"&&e){c=true}if(c){return g}while(h<b.length){i.push(b[h++])}return{merged:i,changes:g}}function allRemoves(a){return a.reduce(function(b,c){return b&&c[0]==="-"},true)}function skipRemoveSuperset(d,a,e){for(var c=0;c<e;c++){var b=a[a.length-e+c].substr(1);if(d.lines[d.index+c]!==" "+b){return false}}d.index+=e;return true};