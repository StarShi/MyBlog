/*!
 * cookies
 * Copyright(c) 2014 Jed Schmidt, http://jed.is/
 * Copyright(c) 2015-2016 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var deprecate=require("depd")("cookies");var Keygrip=require("keygrip");var http=require("http");var cache={};var fieldContentRegExp=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;var sameSiteRegExp=/^(?:lax|strict)$/i;function Cookies(c,a,b){if(!(this instanceof Cookies)){return new Cookies(c,a,b)}this.secure=undefined;this.request=c;this.response=a;if(b){if(Array.isArray(b)){deprecate('"keys" argument; provide using options {"keys": [...]}');this.keys=new Keygrip(b)}else{if(b.constructor&&b.constructor.name==="Keygrip"){deprecate('"keys" argument; provide using options {"keys": keygrip}');this.keys=b}else{this.keys=Array.isArray(b.keys)?new Keygrip(b.keys):b.keys;this.secure=b.secure}}}}Cookies.prototype.get=function(b,a){var j=b+".sig",e,f,i,c,d,g,h=a&&a.signed!==undefined?a.signed:!!this.keys;e=this.request.headers.cookie;if(!e){return}f=e.match(getPattern(b));if(!f){return}i=f[1];if(!a||!h){return i}c=this.get(j);if(!c){return}d=b+"="+i;if(!this.keys){throw new Error(".keys required for signed cookies")}g=this.keys.index(d,c);if(g<0){this.set(j,null,{path:"/",signed:false})}else{g&&this.set(j,this.keys.sign(d),{signed:false});return i}};Cookies.prototype.set=function(c,j,b){var g=this.response,i=this.request,e=g.getHeader("Set-Cookie")||[],a=this.secure!==undefined?!!this.secure:i.protocol==="https"||i.connection.encrypted,d=new Cookie(c,j,b),h=b&&b.signed!==undefined?b.signed:!!this.keys;if(typeof e=="string"){e=[e]}if(!a&&b&&b.secure){throw new Error("Cannot send secure cookie over unencrypted connection")}d.secure=a;if(b&&"secure" in b){d.secure=b.secure}if(b&&"secureProxy" in b){deprecate('"secureProxy" option; use "secure" option, provide "secure" to constructor if needed');d.secure=b.secureProxy}e=pushCookie(e,d);if(b&&h){if(!this.keys){throw new Error(".keys required for signed cookies")}d.value=this.keys.sign(d.toString());d.name+=".sig";e=pushCookie(e,d)}var f=g.set?http.OutgoingMessage.prototype.setHeader:g.setHeader;f.call(g,"Set-Cookie",e);return this};function Cookie(b,c,a){if(!fieldContentRegExp.test(b)){throw new TypeError("argument name is invalid")}if(c&&!fieldContentRegExp.test(c)){throw new TypeError("argument value is invalid")}c||(this.expires=new Date(0));this.name=b;this.value=c||"";for(var b in a){this[b]=a[b]}if(this.path&&!fieldContentRegExp.test(this.path)){throw new TypeError("option path is invalid")}if(this.domain&&!fieldContentRegExp.test(this.domain)){throw new TypeError("option domain is invalid")}if(this.sameSite&&this.sameSite!==true&&!sameSiteRegExp.test(this.sameSite)){throw new TypeError("option sameSite is invalid")}}Cookie.prototype.path="/";Cookie.prototype.expires=undefined;Cookie.prototype.domain=undefined;Cookie.prototype.httpOnly=true;Cookie.prototype.sameSite=false;Cookie.prototype.secure=false;Cookie.prototype.overwrite=false;Cookie.prototype.toString=function(){return this.name+"="+this.value};Cookie.prototype.toHeader=function(){var a=this.toString();if(this.maxAge){this.expires=new Date(Date.now()+this.maxAge)}if(this.path){a+="; path="+this.path}if(this.expires){a+="; expires="+this.expires.toUTCString()}if(this.domain){a+="; domain="+this.domain}if(this.sameSite){a+="; samesite="+(this.sameSite===true?"strict":this.sameSite.toLowerCase())}if(this.secure){a+="; secure"}if(this.httpOnly){a+="; httponly"}return a};Object.defineProperty(Cookie.prototype,"maxage",{configurable:true,enumerable:true,get:function(){return this.maxAge},set:function(a){return this.maxAge=a}});deprecate.property(Cookie.prototype,"maxage",'"maxage"; use "maxAge" instead');function getPattern(a){if(cache[a]){return cache[a]}return cache[a]=new RegExp("(?:^|;) *"+a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")+"=([^;]*)")}function pushCookie(b,a){if(a.overwrite){b=b.filter(function(d){return d.indexOf(a.name+"=")!==0})}b.push(a.toHeader());return b}Cookies.connect=Cookies.express=function(a){return function(d,b,c){d.cookies=b.cookies=new Cookies(d,b,{keys:a});c()}};Cookies.Cookie=Cookie;module.exports=Cookies;