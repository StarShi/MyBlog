var WritableStream=require("stream").Writable||require("readable-stream").Writable,inherits=require("util").inherits;var StreamSearch=require("streamsearch");var PartStream=require("./PartStream"),HeaderParser=require("./HeaderParser");var DASH=45,B_ONEDASH=new Buffer("-"),B_CRLF=new Buffer("\r\n"),EMPTY_FN=function(){};function Dicer(a){if(!(this instanceof Dicer)){return new Dicer(a)}WritableStream.call(this,a);if(!a||(!a.headerFirst&&typeof a.boundary!=="string")){throw new TypeError("Boundary required")}if(typeof a.boundary==="string"){this.setBoundary(a.boundary)}else{this._bparser=undefined}this._headerFirst=a.headerFirst;var b=this;this._dashes=0;this._parts=0;this._finished=false;this._realFinish=false;this._isPreamble=true;this._justMatched=false;this._firstWrite=true;this._inHeader=true;this._part=undefined;this._cb=undefined;this._ignoreData=false;this._partOpts=(typeof a.partHwm==="number"?{highWaterMark:a.partHwm}:{});this._pause=false;this._hparser=new HeaderParser(a);this._hparser.on("header",function(c){b._inHeader=false;b._part.emit("header",c)})}inherits(Dicer,WritableStream);Dicer.prototype.emit=function(b){if(b==="finish"&&!this._realFinish){if(!this._finished){var a=this;process.nextTick(function(){a.emit("error",new Error("Unexpected end of multipart data"));if(a._part&&!a._ignoreData){var c=(a._isPreamble?"Preamble":"Part");a._part.emit("error",new Error(c+" terminated early due to unexpected end of multipart data"));a._part.push(null);process.nextTick(function(){a._realFinish=true;a.emit("finish");a._realFinish=false});return}a._realFinish=true;a.emit("finish");a._realFinish=false})}}else{WritableStream.prototype.emit.apply(this,arguments)}};Dicer.prototype._write=function(d,c,a){if(!this._hparser&&!this._bparser){return a()}if(this._headerFirst&&this._isPreamble){if(!this._part){this._part=new PartStream(this._partOpts);if(this._events.preamble){this.emit("preamble",this._part)}else{this._ignore()}}var b=this._hparser.push(d);if(!this._inHeader&&b!==undefined&&b<d.length){d=d.slice(b)}else{return a()}}if(this._firstWrite){this._bparser.push(B_CRLF);this._firstWrite=false}this._bparser.push(d);if(this._pause){this._cb=a}else{a()}};Dicer.prototype.reset=function(){this._part=undefined;this._bparser=undefined;this._hparser=undefined};Dicer.prototype.setBoundary=function(b){var a=this;this._bparser=new StreamSearch("\r\n--"+b);this._bparser.on("info",function(d,e,f,c){a._oninfo(d,e,f,c)})};Dicer.prototype._ignore=function(){if(this._part&&!this._ignoreData){this._ignoreData=true;this._part.on("error",EMPTY_FN);this._part.resume()}};Dicer.prototype._oninfo=function(e,g,b,d){var c,k=this,h=0,a,j,f=true;if(!this._part&&this._justMatched&&g){while(this._dashes<2&&(b+h)<d){if(g[b+h]===DASH){++h;++this._dashes}else{if(this._dashes){c=B_ONEDASH}this._dashes=0;break}}if(this._dashes===2){if((b+h)<d&&this._events.trailer){this.emit("trailer",g.slice(b+h,d))}this.reset();this._finished=true;if(k._parts===0){k._realFinish=true;k.emit("finish");k._realFinish=false}}if(this._dashes){return}}if(this._justMatched){this._justMatched=false}if(!this._part){this._part=new PartStream(this._partOpts);this._part._read=function(i){k._unpause()};j=this._isPreamble?"preamble":"part";if(this._events[j]){this.emit(j,this._part)}else{this._ignore()}if(!this._isPreamble){this._inHeader=true}}if(g&&b<d&&!this._ignoreData){if(this._isPreamble||!this._inHeader){if(c){f=this._part.push(c)}f=this._part.push(g.slice(b,d));if(!f){this._pause=true}}else{if(!this._isPreamble&&this._inHeader){if(c){this._hparser.push(c)}a=this._hparser.push(g.slice(b,d));if(!this._inHeader&&a!==undefined&&a<d){this._oninfo(false,g,b+a,d)}}}}if(e){this._hparser.reset();if(this._isPreamble){this._isPreamble=false}else{++this._parts;this._part.on("end",function(){if(--k._parts===0){if(k._finished){k._realFinish=true;k.emit("finish");k._realFinish=false}else{k._unpause()}}})}this._part.push(null);this._part=undefined;this._ignoreData=false;this._justMatched=true;this._dashes=0}};Dicer.prototype._unpause=function(){if(!this._pause){return}this._pause=false;if(this._cb){var a=this._cb;this._cb=undefined;a()}};module.exports=Dicer;