var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits;var StreamSearch=require("streamsearch");var B_DCRLF=new Buffer("\r\n\r\n"),RE_CRLF=/\r\n/g,RE_HDR=/^([^:]+):[ \t]?([\x00-\xFF]+)?$/,MAX_HEADER_PAIRS=2000,MAX_HEADER_SIZE=80*1024;function HeaderParser(a){EventEmitter.call(this);var b=this;this.nread=0;this.maxed=false;this.npairs=0;this.maxHeaderPairs=(a&&typeof a.maxHeaderPairs==="number"?a.maxHeaderPairs:MAX_HEADER_PAIRS);this.buffer="";this.header={};this.finished=false;this.ss=new StreamSearch(B_DCRLF);this.ss.on("info",function(d,e,f,c){if(e&&!b.maxed){if(b.nread+(c-f)>MAX_HEADER_SIZE){c=(MAX_HEADER_SIZE-b.nread);b.nread=MAX_HEADER_SIZE}else{b.nread+=(c-f)}if(b.nread===MAX_HEADER_SIZE){b.maxed=true}b.buffer+=e.toString("binary",f,c)}if(d){b._finish()}})}inherits(HeaderParser,EventEmitter);HeaderParser.prototype.push=function(b){var a=this.ss.push(b);if(this.finished){return a}};HeaderParser.prototype.reset=function(){this.finished=false;this.buffer="";this.header={};this.ss.reset()};HeaderParser.prototype._finish=function(){if(this.buffer){this._parseHeader()}this.ss.matches=this.ss.maxMatches;var a=this.header;this.header={};this.buffer="";this.finished=true;this.nread=this.npairs=0;this.maxed=false;this.emit("header",a)};HeaderParser.prototype._parseHeader=function(){if(this.npairs===this.maxHeaderPairs){return}var c=this.buffer.split(RE_CRLF),b=c.length,a,f,e=false;for(var d=0;d<b;++d){if(c[d].length===0){continue}if(c[d][0]==="\t"||c[d][0]===" "){this.header[f][this.header[f].length-1]+=c[d]}else{a=RE_HDR.exec(c[d]);if(a){f=a[1].toLowerCase();if(a[2]){if(this.header[f]===undefined){this.header[f]=[a[2]]}else{this.header[f].push(a[2])}}else{this.header[f]=[""]}if(++this.npairs===this.maxHeaderPairs){break}}else{this.buffer=c[d];e=true;break}}}if(!e){this.buffer=""}};module.exports=HeaderParser;