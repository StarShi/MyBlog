var fs=require("fs"),path=require("path"),EventEmitter=require("events").EventEmitter,StringDecoder=require("string_decoder").StringDecoder,set=require("qs").set,each=Array.prototype.forEach;var DASH="-".charCodeAt(0),CR="\r".charCodeAt(0),LF="\n".charCodeAt(0),COLON=":".charCodeAt(0),SPACE=" ".charCodeAt(0);var Parser=function(c,a){if(!(this instanceof Parser)){return new Parser(c,a)}EventEmitter.call(this);this.writable=true;this.readable=true;this.options=a||{};var b=grab(c,"boundary");if(!b){return this._error("No boundary key found.")}this.key=new Buffer("\r\n--"+b);this._key={};each.call(this.key,function(d){this._key[d]=true},this);this.state="start";this.pending=0;this.written=0;this.writtenDisk=0;this.buff=new Buffer(200);this.preamble=true;this.epilogue=false;this._reset()};Parser.prototype.__proto__=EventEmitter.prototype;Parser.prototype.write=function(a){if(!this.writable||this.epilogue){return}try{this._parse(a)}catch(b){this._error(b)}return true};Parser.prototype.end=function(a){if(!this.writable){return}if(a){this.write(a)}if(!this.epilogue){return this._error("Message underflow.")}return true};Parser.prototype._parse=function(f){var d=0,a=f.length,h=this.buff,c=this.key,e,g,b;for(;d<a;d++){if(this.pos>=200){return this._error("Potential buffer overflow.")}e=f[d];switch(this.state){case"start":switch(e){case DASH:this.pos=3;this.state="key";break;default:break}break;case"key":if(this.pos===c.length){this.state="key_end";d--}else{if(e!==c[this.pos]){if(this.preamble){this.state="start";d--}else{this.state="body";g=this.pos-d;if(g>0){this._write(c.slice(0,g))}d--}}else{this.pos++}}break;case"key_end":switch(e){case CR:this.state="key_line_end";break;case DASH:this.state="key_dash_end";break;default:return this._error("Expected CR or DASH.")}break;case"key_line_end":switch(e){case LF:if(this.preamble){this.preamble=false}else{this._finish()}this.state="header_name";this.pos=0;break;default:return this._error("Expected CR.")}break;case"key_dash_end":switch(e){case DASH:this.epilogue=true;this._finish();return;default:return this._error("Expected DASH.")}break;case"header_name":switch(e){case COLON:this.header=h.toString("ascii",0,this.pos);this.pos=0;this.state="header_val";break;default:h[this.pos++]=e|32;break}break;case"header_val":switch(e){case CR:this.state="header_val_end";break;case SPACE:if(this.pos===0){break}default:h[this.pos++]=e;break}break;case"header_val_end":switch(e){case LF:g=h.toString("ascii",0,this.pos);this._header(this.header,g);this.pos=0;this.state="header_end";break;default:return this._error("Expected LF.")}break;case"header_end":switch(e){case CR:this.state="head_end";break;default:this.state="header_name";d--;break}break;case"head_end":switch(e){case LF:this.state="body";d++;if(d>=a){return}f=f.slice(d);d=-1;a=f.length;break;default:return this._error("Expected LF.")}break;case"body":switch(e){case CR:if(d>0){this._write(f.slice(0,d))}this.pos=1;this.state="key";f=f.slice(d);d=0;a=f.length;break;default:while((b=d+c.length-1)<a){if(this._key[f[b]]){break}d=b}break}break}}if(this.state==="body"){this._write(f)}};Parser.prototype._header=function(a,b){return this.emit("header",a,b)};Parser.prototype._write=function(a){this.emit("data",a)};Parser.prototype._reset=function(){this.pos=0;this.decode=null;this.field=null;this.data=null;this.file=null;this.header=null};Parser.prototype._error=function(a){this.destroy();this.emit("error",typeof a==="string"?new Error(a):a)};Parser.prototype.destroy=function(a){this.writable=false;this.readable=false;this._reset()};Parser.prototype._finish=function(){var a=this,f=this.field,e=this.data,c=this.file,b;this.pending++;this._reset();if(e&&e.path){b=e.path;e.end(d)}else{b=e;d()}function d(){if(!a.readable){return}a.pending--;a.emit("part",f,b);if(e&&e.path){a.emit("file",f,b,c)}if(a.epilogue&&!a.pending){a.emit("end");a.destroy()}}};Parser.root=process.platform==="win32"?"C:/Temp":"/tmp";Parser.middleware=function(a){a=a||{};return function(e,b,d){if(a.ensureBody){e.body={}}if(e.method==="GET"||e.method==="HEAD"||e._multipart){return d()}e._multipart=true;var c=e.headers["content-type"];if(c){c=c.split(";")[0].trim().toLowerCase()}if(c==="multipart/form-data"){Parser.handle(e,b,d,a)}else{d()}}};Parser.handle=function(g,f,e,i){var b=new Parser(g.headers["content-type"],i),h=i.diskLimit,c=i.limit,d={},a={};b.on("error",function(j){g.destroy();e(j)});b.on("part",function(k,j){set(d,k,j)});b.on("file",function(l,k,j){set(a,l,{path:k,name:j,toString:function(){return k}})});b.on("data",function(){if(this.writtenDisk>h||this.written>c){this.emit("error",new Error("Overflow."));this.destroy()}});b.on("end",e);g.body=d;g.files=a;g.pipe(b)};var isWindows=process.platform==="win32";var stream=function(c,b){var d=path.extname(c)||"",c=path.basename(c,d)||"",b=b||Parser.root,a;a=Math.random().toString(36).substring(2);c=c.substring(0,200)+"."+a;c=path.join(b,c)+d.substring(0,6);c=c.replace(/\0/g,"");if(isWindows){c=c.replace(/[:*<>|"?]/g,"")}return fs.createWriteStream(c)};var grab=function(d,a){if(!d){return}var c=new RegExp("\\b"+a+"\\s*=\\s*(\"[^\"]+\"|'[^']+'|[^;,]+)","i"),b=c.exec(d);if(b){return b[1].trim().replace(/^['"]|['"]$/g,"")}};module.exports=Parser;