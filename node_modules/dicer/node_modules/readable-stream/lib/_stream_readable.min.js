module.exports=Readable;var isArray=require("isarray");var Buffer=require("buffer").Buffer;Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter;if(!EE.listenerCount){EE.listenerCount=function(b,a){return b.listeners(a).length}}var Stream=require("stream");var util=require("core-util-is");util.inherits=require("inherits");var StringDecoder;var debug=require("util");if(debug&&debug.debuglog){debug=debug.debuglog("stream")}else{debug=function(){}}util.inherits(Readable,Stream);function ReadableState(b,d){var a=require("./_stream_duplex");b=b||{};var c=b.highWaterMark;var e=b.objectMode?16:16*1024;this.highWaterMark=(c||c===0)?c:e;this.highWaterMark=~~this.highWaterMark;this.buffer=[];this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=null;this.ended=false;this.endEmitted=false;this.reading=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.objectMode=!!b.objectMode;if(d instanceof a){this.objectMode=this.objectMode||!!b.readableObjectMode}this.defaultEncoding=b.defaultEncoding||"utf8";this.ranOut=false;this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(b.encoding){if(!StringDecoder){StringDecoder=require("string_decoder/").StringDecoder}this.decoder=new StringDecoder(b.encoding);this.encoding=b.encoding}}function Readable(b){var a=require("./_stream_duplex");if(!(this instanceof Readable)){return new Readable(b)}this._readableState=new ReadableState(b,this);this.readable=true;Stream.call(this)}Readable.prototype.push=function(a,b){var c=this._readableState;if(util.isString(a)&&!c.objectMode){b=b||c.defaultEncoding;if(b!==c.encoding){a=new Buffer(a,b);b=""}}return readableAddChunk(this,c,a,b,false)};Readable.prototype.unshift=function(a){var b=this._readableState;return readableAddChunk(this,b,a,"",true)};function readableAddChunk(g,d,a,c,b){var h=chunkInvalid(d,a);if(h){g.emit("error",h)}else{if(util.isNullOrUndefined(a)){d.reading=false;if(!d.ended){onEofChunk(g,d)}}else{if(d.objectMode||a&&a.length>0){if(d.ended&&!b){var f=new Error("stream.push() after EOF");g.emit("error",f)}else{if(d.endEmitted&&b){var f=new Error("stream.unshift() after end event");g.emit("error",f)}else{if(d.decoder&&!b&&!c){a=d.decoder.write(a)}if(!b){d.reading=false}if(d.flowing&&d.length===0&&!d.sync){g.emit("data",a);g.read(0)}else{d.length+=d.objectMode?1:a.length;if(b){d.buffer.unshift(a)}else{d.buffer.push(a)}if(d.needReadable){emitReadable(g)}}maybeReadMore(g,d)}}}else{if(!b){d.reading=false}}}}return needMoreData(d)}function needMoreData(a){return !a.ended&&(a.needReadable||a.length<a.highWaterMark||a.length===0)}Readable.prototype.setEncoding=function(a){if(!StringDecoder){StringDecoder=require("string_decoder/").StringDecoder}this._readableState.decoder=new StringDecoder(a);this._readableState.encoding=a;return this};var MAX_HWM=8388608;function roundUpToNextPowerOf2(b){if(b>=MAX_HWM){b=MAX_HWM}else{b--;for(var a=1;a<32;a<<=1){b|=b>>a}b++}return b}function howMuchToRead(b,a){if(a.length===0&&a.ended){return 0}if(a.objectMode){return b===0?0:1}if(isNaN(b)||util.isNull(b)){if(a.flowing&&a.buffer.length){return a.buffer[0].length}else{return a.length}}if(b<=0){return 0}if(b>a.highWaterMark){a.highWaterMark=roundUpToNextPowerOf2(b)}if(b>a.length){if(!a.ended){a.needReadable=true;return 0}else{return a.length}}return b}Readable.prototype.read=function(e){debug("read",e);var d=this._readableState;var c=e;if(!util.isNumber(e)||e>0){d.emittedReadable=false}if(e===0&&d.needReadable&&(d.length>=d.highWaterMark||d.ended)){debug("read: emitReadable",d.length,d.ended);if(d.length===0&&d.ended){endReadable(this)}else{emitReadable(this)}return null}e=howMuchToRead(e,d);if(e===0&&d.ended){if(d.length===0){endReadable(this)}return null}var a=d.needReadable;debug("need readable",a);if(d.length===0||d.length-e<d.highWaterMark){a=true;debug("length less than watermark",a)}if(d.ended||d.reading){a=false;debug("reading or ended",a)}if(a){debug("do read");d.reading=true;d.sync=true;if(d.length===0){d.needReadable=true}this._read(d.highWaterMark);d.sync=false}if(a&&!d.reading){e=howMuchToRead(c,d)}var b;if(e>0){b=fromList(e,d)}else{b=null}if(util.isNull(b)){d.needReadable=true;e=0}d.length-=e;if(d.length===0&&!d.ended){d.needReadable=true}if(c!==e&&d.ended&&d.length===0){endReadable(this)}if(!util.isNull(b)){this.emit("data",b)}return b};function chunkInvalid(b,a){var c=null;if(!util.isBuffer(a)&&!util.isString(a)&&!util.isNullOrUndefined(a)&&!b.objectMode){c=new TypeError("Invalid non-string/buffer chunk")}return c}function onEofChunk(c,b){if(b.decoder&&!b.ended){var a=b.decoder.end();if(a&&a.length){b.buffer.push(a);b.length+=b.objectMode?1:a.length}}b.ended=true;emitReadable(c)}function emitReadable(b){var a=b._readableState;a.needReadable=false;if(!a.emittedReadable){debug("emitReadable",a.flowing);a.emittedReadable=true;if(a.sync){process.nextTick(function(){emitReadable_(b)})}else{emitReadable_(b)}}}function emitReadable_(a){debug("emit readable");a.emit("readable");flow(a)}function maybeReadMore(b,a){if(!a.readingMore){a.readingMore=true;process.nextTick(function(){maybeReadMore_(b,a)})}}function maybeReadMore_(c,b){var a=b.length;while(!b.reading&&!b.flowing&&!b.ended&&b.length<b.highWaterMark){debug("maybeReadMore read 0");c.read(0);if(a===b.length){break}else{a=b.length}}b.readingMore=false}Readable.prototype._read=function(a){this.emit("error",new Error("not implemented"))};Readable.prototype.pipe=function(l,j){var a=this;var b=this._readableState;switch(b.pipesCount){case 0:b.pipes=l;break;case 1:b.pipes=[b.pipes,l];break;default:b.pipes.push(l);break}b.pipesCount+=1;debug("pipe count=%d opts=%j",b.pipesCount,j);var k=(!j||j.end!==false)&&l!==process.stdout&&l!==process.stderr;var d=k?o:c;if(b.endEmitted){process.nextTick(d)}else{a.once("end",d)}l.on("unpipe",g);function g(p){debug("onunpipe");if(p===a){c()}}function o(){debug("onend");l.end()}var e=pipeOnDrain(a);l.on("drain",e);function c(){debug("cleanup");l.removeListener("close",n);l.removeListener("finish",f);l.removeListener("drain",e);l.removeListener("error",i);l.removeListener("unpipe",g);a.removeListener("end",o);a.removeListener("end",c);a.removeListener("data",m);if(b.awaitDrain&&(!l._writableState||l._writableState.needDrain)){e()}}a.on("data",m);function m(q){debug("ondata");var p=l.write(q);if(false===p){debug("false write response, pause",a._readableState.awaitDrain);a._readableState.awaitDrain++;a.pause()}}function i(p){debug("onerror",p);h();l.removeListener("error",i);if(EE.listenerCount(l,"error")===0){l.emit("error",p)}}if(!l._events||!l._events.error){l.on("error",i)}else{if(isArray(l._events.error)){l._events.error.unshift(i)}else{l._events.error=[i,l._events.error]}}function n(){l.removeListener("finish",f);h()}l.once("close",n);function f(){debug("onfinish");l.removeListener("close",n);h()}l.once("finish",f);function h(){debug("unpipe");a.unpipe(l)}l.emit("pipe",a);if(!b.flowing){debug("pipe resume");a.resume()}return l};function pipeOnDrain(a){return function(){var b=a._readableState;debug("pipeOnDrain",b.awaitDrain);if(b.awaitDrain){b.awaitDrain--}if(b.awaitDrain===0&&EE.listenerCount(a,"data")){b.flowing=true;flow(a)}}}Readable.prototype.unpipe=function(b){var d=this._readableState;if(d.pipesCount===0){return this}if(d.pipesCount===1){if(b&&b!==d.pipes){return this}if(!b){b=d.pipes}d.pipes=null;d.pipesCount=0;d.flowing=false;if(b){b.emit("unpipe",this)}return this}if(!b){var e=d.pipes;var a=d.pipesCount;d.pipes=null;d.pipesCount=0;d.flowing=false;for(var c=0;c<a;c++){e[c].emit("unpipe",this)}return this}var c=indexOf(d.pipes,b);if(c===-1){return this}d.pipes.splice(c,1);d.pipesCount-=1;if(d.pipesCount===1){d.pipes=d.pipes[0]}b.emit("unpipe",this);return this};Readable.prototype.on=function(d,c){var b=Stream.prototype.on.call(this,d,c);if(d==="data"&&false!==this._readableState.flowing){this.resume()}if(d==="readable"&&this.readable){var e=this._readableState;if(!e.readableListening){e.readableListening=true;e.emittedReadable=false;e.needReadable=true;if(!e.reading){var a=this;process.nextTick(function(){debug("readable nexttick read 0");a.read(0)})}else{if(e.length){emitReadable(this,e)}}}}return b};Readable.prototype.addListener=Readable.prototype.on;Readable.prototype.resume=function(){var a=this._readableState;if(!a.flowing){debug("resume");a.flowing=true;if(!a.reading){debug("resume read 0");this.read(0)}resume(this,a)}return this};function resume(b,a){if(!a.resumeScheduled){a.resumeScheduled=true;process.nextTick(function(){resume_(b,a)})}}function resume_(b,a){a.resumeScheduled=false;b.emit("resume");flow(b);if(a.flowing&&!a.reading){b.read(0)}}Readable.prototype.pause=function(){debug("call pause flowing=%j",this._readableState.flowing);if(false!==this._readableState.flowing){debug("pause");this._readableState.flowing=false;this.emit("pause")}return this};function flow(c){var b=c._readableState;debug("flow",b.flowing);if(b.flowing){do{var a=c.read()}while(null!==a&&b.flowing)}}Readable.prototype.wrap=function(f){var e=this._readableState;var d=false;var a=this;f.on("end",function(){debug("wrapped end");if(e.decoder&&!e.ended){var g=e.decoder.end();if(g&&g.length){a.push(g)}}a.push(null)});f.on("data",function(h){debug("wrapped data");if(e.decoder){h=e.decoder.write(h)}if(!h||!e.objectMode&&!h.length){return}var g=a.push(h);if(!g){d=true;f.pause()}});for(var c in f){if(util.isFunction(f[c])&&util.isUndefined(this[c])){this[c]=function(g){return function(){return f[g].apply(f,arguments)}}(c)}}var b=["error","close","destroy","pause","resume"];forEach(b,function(g){f.on(g,a.emit.bind(a,g))});a._read=function(g){debug("wrapped _read",g);if(d){d=false;f.resume()}};return a};Readable._fromList=fromList;function fromList(e,a){var j=a.buffer;var b=a.length;var m=!!a.decoder;var p=!!a.objectMode;var k;if(j.length===0){return null}if(b===0){k=null}else{if(p){k=j.shift()}else{if(!e||e>=b){if(m){k=j.join("")}else{k=Buffer.concat(j,b)}j.length=0}else{if(e<j[0].length){var d=j[0];k=d.slice(0,e);j[0]=d.slice(e)}else{if(e===j[0].length){k=j.shift()}else{if(m){k=""}else{k=new Buffer(e)}var o=0;for(var h=0,g=j.length;h<g&&o<e;h++){var d=j[0];var f=Math.min(e-o,d.length);if(m){k+=d.slice(0,f)}else{d.copy(k,o,0,f)}if(f<d.length){j[0]=d.slice(f)}else{j.shift()}o+=f}}}}}}return k}function endReadable(b){var a=b._readableState;if(a.length>0){throw new Error("endReadable called on non-empty stream")}if(!a.endEmitted){a.ended=true;process.nextTick(function(){if(!a.endEmitted&&a.length===0){a.endEmitted=true;b.readable=false;b.emit("end")}})}}function forEach(b,d){for(var c=0,a=b.length;c<a;c++){d(b[c],c)}}function indexOf(c,a){for(var d=0,b=c.length;d<b;d++){if(c[d]===a){return d}}return -1};