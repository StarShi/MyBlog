var Dicer=require("..");var assert=require("assert"),fs=require("fs"),path=require("path"),inspect=require("util").inspect;var FIXTURES_ROOT=__dirname+"/fixtures/";var t=0,group=path.basename(__filename,".js")+"/";var tests=[{source:"many",opts:{boundary:"----WebKitFormBoundaryWLHCs9qmcJJoyjKR"},chsize:16,nparts:7,what:"Extra trailer data pushed after finished"}];function next(){if(t===tests.length){return}var j=tests[t],i=FIXTURES_ROOT+j.source,b,c=0,f=new Buffer(j.chsize),a={parts:[]};b=fs.openSync(i+"/original","r");var d=new Dicer(j.opts),h,e=0,g=0;d.on("part",function(l){var k={body:undefined,bodylen:0,error:undefined,header:undefined};l.on("header",function(m){k.header=m}).on("data",function(m){var n=new Buffer(m.length);m.copy(n);m=n;if(!k.body){k.body=[m]}else{k.body.push(m)}k.bodylen+=m.length}).on("error",function(m){k.error=m;++e}).on("end",function(){if(k.body){k.body=Buffer.concat(k.body,k.bodylen)}a.parts.push(k)})}).on("error",function(k){h=k}).on("finish",function(){assert(g++===0,makeMsg(j.what,"finish emitted multiple times"));if(j.dicerError){assert(h!==undefined,makeMsg(j.what,"Expected error"))}else{assert(h===undefined,makeMsg(j.what,"Unexpected error"))}if(j.events&&j.events.indexOf("part")>-1){assert.equal(a.parts.length,j.nparts,makeMsg(j.what,"Part count mismatch:\nActual: "+a.parts.length+"\nExpected: "+j.nparts));if(!j.npartErrors){j.npartErrors=0}assert.equal(e,j.npartErrors,makeMsg(j.what,"Part errors mismatch:\nActual: "+e+"\nExpected: "+j.npartErrors));for(var l=0,m,k;l<j.nparts;++l){if(fs.existsSync(i+"/part"+(l+1))){k=fs.readFileSync(i+"/part"+(l+1));if(k.length===0){k=undefined}}else{k=undefined}assert.deepEqual(a.parts[l].body,k,makeMsg(j.what,"Part #"+(l+1)+" body mismatch"));if(fs.existsSync(i+"/part"+(l+1)+".header")){m=fs.readFileSync(i+"/part"+(l+1)+".header","binary");m=JSON.parse(m)}else{m=undefined}assert.deepEqual(a.parts[l].header,m,makeMsg(j.what,"Part #"+(l+1)+" parsed header mismatch:\nActual: "+inspect(a.parts[l].header)+"\nExpected: "+inspect(m)))}}++t;next()});while(true){c=fs.readSync(b,f,0,f.length,null);if(c===0){setTimeout(function(){d.write("\r\n\r\n\r\n");d.end()},50);break}d.write(c===f.length?f:f.slice(0,c))}fs.closeSync(b)}next();function makeMsg(a,b){return"["+group+a+"]: "+b}process.on("exit",function(){assert(t===tests.length,makeMsg("_exit","Only ran "+t+"/"+tests.length+" tests"))});