"use strict";module.exports=function(i,e,c){var f=require("./util");var a=i.CancellationError;var j=f.errorObj;var l=require("./catch_filter")(c);function h(p,o,n){this.promise=p;this.type=o;this.handler=n;this.called=false;this.cancelPromise=null}h.prototype.isFinallyHandler=function(){return this.type===0};function g(n){this.finallyHandler=n}g.prototype._resultCancelled=function(){m(this.finallyHandler)};function m(n,o){if(n.cancelPromise!=null){if(arguments.length>1){n.cancelPromise._reject(o)}else{n.cancelPromise._cancel()}n.cancelPromise=null;return true}return false}function d(){return k.call(this,this.promise._target()._settledValue())}function b(n){if(m(this,n)){return}j.e=n;return j}function k(n){var s=this.promise;var q=this.handler;if(!this.called){this.called=true;var p=this.isFinallyHandler()?q.call(s._boundValue()):q.call(s._boundValue(),n);if(p===c){return p}else{if(p!==undefined){s._setReturnedNonUndefined();var o=e(p,s);if(o instanceof i){if(this.cancelPromise!=null){if(o._isCancelled()){var r=new a("late cancellation observer");s._attachExtraTrace(r);j.e=r;return j}else{if(o.isPending()){o._attachCancellationCallback(new g(this))}}}return o._then(d,b,undefined,this,undefined)}}}}if(s.isRejected()){m(this);j.e=n;return j}else{m(this);return n}}i.prototype._passThrough=function(p,o,q,n){if(typeof p!=="function"){return this.then()}return this._then(q,n,undefined,new h(this,o,p),undefined)};i.prototype.lastly=i.prototype["finally"]=function(n){return this._passThrough(n,0,k,k)};i.prototype.tap=function(n){return this._passThrough(n,1,k)};i.prototype.tapCatch=function(s){var n=arguments.length;if(n===1){return this._passThrough(s,1,undefined,k)}else{var t=new Array(n-1),o=0,p;for(p=0;p<n-1;++p){var r=arguments[p];if(f.isObject(r)){t[o++]=r}else{return i.reject(new TypeError("tapCatch statement predicate: expecting an object but got "+f.classString(r)))}}t.length=o;var q=arguments[p];return this._passThrough(l(t,q,this),1,undefined,k)}};return h};