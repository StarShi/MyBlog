"use strict";var firstLineError;try{throw new Error()}catch(e){firstLineError=e}var schedule=require("./schedule");var Queue=require("./queue");var util=require("./util");function Async(){this._customScheduler=false;this._isTickUsed=false;this._lateQueue=new Queue(16);this._normalQueue=new Queue(16);this._haveDrainedQueues=false;this._trampolineEnabled=true;var a=this;this.drainQueues=function(){a._drainQueues()};this._schedule=schedule}Async.prototype.setScheduler=function(a){var b=this._schedule;this._schedule=a;this._customScheduler=true;return b};Async.prototype.hasCustomScheduler=function(){return this._customScheduler};Async.prototype.enableTrampoline=function(){this._trampolineEnabled=true};Async.prototype.disableTrampolineIfNecessary=function(){if(util.hasDevTools){this._trampolineEnabled=false}};Async.prototype.haveItemsQueued=function(){return this._isTickUsed||this._haveDrainedQueues};Async.prototype.fatalError=function(b,a){if(a){process.stderr.write("Fatal "+(b instanceof Error?b.stack:b)+"\n");process.exit(2)}else{this.throwLater(b)}};Async.prototype.throwLater=function(b,a){if(arguments.length===1){a=b;b=function(){throw a}}if(typeof setTimeout!=="undefined"){setTimeout(function(){b(a)},0)}else{try{this._schedule(function(){b(a)})}catch(c){throw new Error("No async scheduler available\u000a\u000a    See http://goo.gl/MqrFmX\u000a")}}};function AsyncInvokeLater(b,c,a){this._lateQueue.push(b,c,a);this._queueTick()}function AsyncInvoke(b,c,a){this._normalQueue.push(b,c,a);this._queueTick()}function AsyncSettlePromises(a){this._normalQueue._pushOne(a);this._queueTick()}if(!util.hasDevTools){Async.prototype.invokeLater=AsyncInvokeLater;Async.prototype.invoke=AsyncInvoke;Async.prototype.settlePromises=AsyncSettlePromises}else{Async.prototype.invokeLater=function(b,c,a){if(this._trampolineEnabled){AsyncInvokeLater.call(this,b,c,a)}else{this._schedule(function(){setTimeout(function(){b.call(c,a)},100)})}};Async.prototype.invoke=function(b,c,a){if(this._trampolineEnabled){AsyncInvoke.call(this,b,c,a)}else{this._schedule(function(){b.call(c,a)})}};Async.prototype.settlePromises=function(a){if(this._trampolineEnabled){AsyncSettlePromises.call(this,a)}else{this._schedule(function(){a._settlePromises()})}}}Async.prototype._drainQueue=function(b){while(b.length()>0){var c=b.shift();if(typeof c!=="function"){c._settlePromises();continue}var d=b.shift();var a=b.shift();c.call(d,a)}};Async.prototype._drainQueues=function(){this._drainQueue(this._normalQueue);this._reset();this._haveDrainedQueues=true;this._drainQueue(this._lateQueue)};Async.prototype._queueTick=function(){if(!this._isTickUsed){this._isTickUsed=true;this._schedule(this.drainQueues)}};Async.prototype._reset=function(){this._isTickUsed=false};module.exports=Async;module.exports.firstLineError=firstLineError;