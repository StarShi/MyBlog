"use strict";module.exports=function(c,q,e,m,b,j){var a=require("./util");var g=require("./errors").TypeError;var i=require("./util").inherits;var f=a.errorObj;var h=a.tryCatch;var p={};function o(t){setTimeout(function(){throw t},0)}function n(t){var u=e(t);if(u!==t&&typeof t._isDisposable==="function"&&typeof t._getDisposer==="function"&&t._isDisposable()){u._setDisposable(t._getDisposer())}return u}function r(y,u){var w=0;var t=y.length;var v=new c(b);function x(){if(w>=t){return v._fulfill()}var z=n(y[w++]);if(z instanceof c&&z._isDisposable()){try{z=e(z._getDisposer().tryDispose(u),y.promise)}catch(A){return o(A)}if(z instanceof c){return z._then(x,o,null,null,null)}}x()}x();return v}function s(u,v,t){this._data=u;this._promise=v;this._context=t}s.prototype.data=function(){return this._data};s.prototype.promise=function(){return this._promise};s.prototype.resource=function(){if(this.promise().isFulfilled()){return this.promise().value()}return p};s.prototype.tryDispose=function(t){var w=this.resource();var v=this._context;if(v!==undefined){v._pushContext()}var u=w!==p?this.doDispose(w,t):null;if(v!==undefined){v._popContext()}this._promise._unsetDisposable();this._data=null;return u};s.isDisposer=function(t){return(t!=null&&typeof t.resource==="function"&&typeof t.tryDispose==="function")};function d(u,v,t){this.constructor$(u,v,t)}i(d,s);d.prototype.doDispose=function(v,t){var u=this.data();return u.call(v,v,t)};function k(t){if(s.isDisposer(t)){this.resources[this.index]._setDisposable(t);return t.promise()}return t}function l(t){this.length=t;this.promise=null;this[t-1]=null}l.prototype._resultCancelled=function(){var t=this.length;for(var u=0;u<t;++u){var v=this[u];if(v instanceof c){v.cancel()}}};c.using=function(){var y=arguments.length;if(y<2){return q("you must pass at least 2 arguments to Promise.using")}var A=arguments[y-1];if(typeof A!=="function"){return q("expecting a function but got "+a.classString(A))}var B;var E=true;if(y===2&&Array.isArray(arguments[0])){B=arguments[0];y=B.length;E=false}else{B=arguments;y--}var t=new l(y);for(var w=0;w<y;++w){var u=B[w];if(s.isDisposer(u)){var z=u;u=u.promise();u._setDisposable(z)}else{var C=e(u);if(C instanceof c){u=C._then(k,null,null,{resources:t,index:w},undefined)}}t[w]=u}var v=new Array(t.length);for(var w=0;w<v.length;++w){v[w]=c.resolve(t[w]).reflect()}var x=c.all(v).then(function(J){for(var I=0;I<J.length;++I){var F=J[I];if(F.isRejected()){f.e=F.error();return f}else{if(!F.isFulfilled()){x.cancel();return}}J[I]=F.value()}D._pushContext();A=h(A);var G=E?A.apply(undefined,J):A(J);var H=D._popContext();j.checkForgottenReturns(G,H,"Promise.using",D);return G});var D=x.lastly(function(){var F=new c.PromiseInspection(x);return r(t,F)});t.promise=D;D._setOnCancel(t);return D};c.prototype._setDisposable=function(t){this._bitField=this._bitField|131072;this._disposer=t};c.prototype._isDisposable=function(){return(this._bitField&131072)>0};c.prototype._getDisposer=function(){return this._disposer};c.prototype._unsetDisposable=function(){this._bitField=this._bitField&(~131072);this._disposer=undefined};c.prototype.disposer=function(t){if(typeof t==="function"){return new d(t,this,m())}throw new g()}};