"use strict";module.exports=function(k,a,f,d,i,b){var m=require("./errors");var n=m.TypeError;var e=require("./util");var l=e.errorObj;var c=e.tryCatch;var h=[];function g(t,u,s){for(var r=0;r<u.length;++r){s._pushContext();var o=c(u[r])(t);s._popContext();if(o===l){s._pushContext();var q=k.reject(l.e);s._popContext();return q}var p=d(o,s);if(p instanceof k){return p}}return null}function j(r,t,s,o){if(b.cancellation()){var q=new k(f);var p=this._finallyPromise=new k(f);this._promise=q.lastly(function(){return p});q._captureStackTrace();q._setOnCancel(this)}else{var u=this._promise=new k(f);u._captureStackTrace()}this._stack=o;this._generatorFunction=r;this._receiver=t;this._generator=undefined;this._yieldHandlers=typeof s==="function"?[s].concat(h):h;this._yieldedPromise=null;this._cancellationPhase=false}e.inherits(j,i);j.prototype._isResolved=function(){return this._promise===null};j.prototype._cleanup=function(){this._promise=this._generator=null;if(b.cancellation()&&this._finallyPromise!==null){this._finallyPromise._fulfill();this._finallyPromise=null}};j.prototype._promiseCancelled=function(){if(this._isResolved()){return}var q=typeof this._generator["return"]!=="undefined";var o;if(!q){var p=new k.CancellationError("generator .return() sentinel");k.coroutine.returnSentinel=p;this._promise._attachExtraTrace(p);this._promise._pushContext();o=c(this._generator["throw"]).call(this._generator,p);this._promise._popContext()}else{this._promise._pushContext();o=c(this._generator["return"]).call(this._generator,undefined);this._promise._popContext()}this._cancellationPhase=true;this._yieldedPromise=null;this._continue(o)};j.prototype._promiseFulfilled=function(p){this._yieldedPromise=null;this._promise._pushContext();var o=c(this._generator.next).call(this._generator,p);this._promise._popContext();this._continue(o)};j.prototype._promiseRejected=function(p){this._yieldedPromise=null;this._promise._attachExtraTrace(p);this._promise._pushContext();var o=c(this._generator["throw"]).call(this._generator,p);this._promise._popContext();this._continue(o)};j.prototype._resultCancelled=function(){if(this._yieldedPromise instanceof k){var o=this._yieldedPromise;this._yieldedPromise=null;o.cancel()}};j.prototype.promise=function(){return this._promise};j.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver);this._receiver=this._generatorFunction=undefined;this._promiseFulfilled(undefined)};j.prototype._continue=function(o){var s=this._promise;if(o===l){this._cleanup();if(this._cancellationPhase){return s.cancel()}else{return s._rejectCallback(o.e,false)}}var r=o.value;if(o.done===true){this._cleanup();if(this._cancellationPhase){return s.cancel()}else{return s._resolveCallback(r)}}else{var p=d(r,this._promise);if(!(p instanceof k)){p=g(p,this._yieldHandlers,this._promise);if(p===null){this._promiseRejected(new n("A value %s was yielded that could not be treated as a promise\u000a\u000a    See http://goo.gl/MqrFmX\u000a\u000a".replace("%s",String(r))+"From coroutine:\u000a"+this._stack.split("\n").slice(1,-7).join("\n")));return}}p=p._target();var q=p._bitField;if(((q&50397184)===0)){this._yieldedPromise=p;p._proxy(this,null)}else{if(((q&33554432)!==0)){k._async.invoke(this._promiseFulfilled,this,p._value())}else{if(((q&16777216)!==0)){k._async.invoke(this._promiseRejected,this,p._reason())}else{this._promiseCancelled()}}}}};k.coroutine=function(r,q){if(typeof r!=="function"){throw new n("generatorFunction must be a function\u000a\u000a    See http://goo.gl/MqrFmX\u000a")}var s=Object(q).yieldHandler;var p=j;var o=new Error().stack;return function(){var v=r.apply(this,arguments);var u=new p(undefined,undefined,s,o);var t=u.promise();u._generator=v;u._promiseFulfilled(undefined);return t}};k.coroutine.addYieldHandler=function(o){if(typeof o!=="function"){throw new n("expecting a function but got "+e.classString(o))}h.push(o)};k.spawn=function(p){b.deprecated("Promise.spawn()","Promise.coroutine()");if(typeof p!=="function"){return a("generatorFunction must be a function\u000a\u000a    See http://goo.gl/MqrFmX\u000a")}var q=new j(p,this);var o=q.promise();q._run(k.spawn);return o}};