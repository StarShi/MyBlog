"use strict";module.exports=function(k,j,a,f,i,c){var m=k._getDomain;var g=require("./util");var d=g.tryCatch;var l=g.errorObj;var e=k._async;function h(o,p,n,r){this.constructor$(o);this._promise._captureStackTrace();var q=m();this._callback=q===null?p:g.domainBind(q,p);this._preservedValues=r===i?new Array(this.length()):null;this._limit=n;this._inFlight=0;this._queue=[];e.invoke(this._asyncInit,this,undefined)}g.inherits(h,j);h.prototype._asyncInit=function(){this._init$(undefined,-2)};h.prototype._init=function(){};h.prototype._promiseFulfilled=function(x,t){var y=this._values;var o=this.length();var r=this._preservedValues;var p=this._limit;if(t<0){t=(t*-1)-1;y[t]=x;if(p>=1){this._inFlight--;this._drainQueue();if(this._isResolved()){return true}}}else{if(p>=1&&this._inFlight>=p){y[t]=x;this._queue.push(t);return false}if(r!==null){r[t]=x}var A=this._promise;var z=this._callback;var n=A._boundValue();A._pushContext();var u=d(z).call(n,x,t,o);var v=A._popContext();c.checkForgottenReturns(u,v,r!==null?"Promise.filter":"Promise.map",A);if(u===l){this._reject(u.e);return true}var w=f(u,this._promise);if(w instanceof k){w=w._target();var s=w._bitField;if(((s&50397184)===0)){if(p>=1){this._inFlight++}y[t]=w;w._proxy(this,(t+1)*-1);return false}else{if(((s&33554432)!==0)){u=w._value()}else{if(((s&16777216)!==0)){this._reject(w._reason());return true}else{this._cancel();return true}}}}y[t]=u}var q=++this._totalResolved;if(q>=o){if(r!==null){this._filter(y,r)}else{this._resolve(y)}return true}return false};h.prototype._drainQueue=function(){var n=this._queue;var o=this._limit;var p=this._values;while(n.length>0&&this._inFlight<o){if(this._isResolved()){return}var q=n.pop();this._promiseFulfilled(p[q],q)}};h.prototype._filter=function(s,o){var n=o.length;var q=new Array(n);var p=0;for(var r=0;r<n;++r){if(s[r]){q[p++]=o[r]}}q.length=p;this._resolve(q)};h.prototype.preservedValues=function(){return this._preservedValues};function b(p,q,o,r){if(typeof q!=="function"){return a("expecting a function but got "+g.classString(q))}var n=0;if(o!==undefined){if(typeof o==="object"&&o!==null){if(typeof o.concurrency!=="number"){return k.reject(new TypeError("'concurrency' must be a number but it is "+g.classString(o.concurrency)))}n=o.concurrency}else{return k.reject(new TypeError("options argument must be an object but it is "+g.classString(o)))}}n=typeof n==="number"&&isFinite(n)&&n>=1?n:0;return new h(p,q,n,r).promise()}k.prototype.map=function(o,n){return b(this,o,n,null)};k.map=function(o,p,n,q){return b(o,p,n,q)}};