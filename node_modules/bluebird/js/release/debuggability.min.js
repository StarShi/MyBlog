"use strict";module.exports=function(L,Z){var Y=L._getDomain;var N=L._async;var k=require("./errors").Warning;var o=require("./util");var i=o.canAttachTrace;var b;var X;var ag=/[\\\/]bluebird[\\\/]js[\\\/](release|debug|instrumented)/;var z=/\((?:timers\.js):\d+:\d+\)/;var ad=/[\/<\(](.+?):(\d+):(\d+)\)?\s*$/;var P=null;var d=null;var D=false;var af;var j=!!(o.env("BLUEBIRD_DEBUG")!=0&&(false||o.env("BLUEBIRD_DEBUG")||o.env("NODE_ENV")==="development"));var U=!!(o.env("BLUEBIRD_WARNINGS")!=0&&(j||o.env("BLUEBIRD_WARNINGS")));var J=!!(o.env("BLUEBIRD_LONG_STACK_TRACES")!=0&&(j||o.env("BLUEBIRD_LONG_STACK_TRACES")));var g=o.env("BLUEBIRD_W_FORGOTTEN_RETURN")!=0&&(U||!!o.env("BLUEBIRD_W_FORGOTTEN_RETURN"));L.prototype.suppressUnhandledRejections=function(){var ai=this._target();ai._bitField=((ai._bitField&(~1048576))|524288)};L.prototype._ensurePossibleRejectionHandled=function(){if((this._bitField&524288)!==0){return}this._setRejectionIsUnhandled();var ai=this;setTimeout(function(){ai._notifyUnhandledRejection()},1)};L.prototype._notifyUnhandledRejectionIsHandled=function(){G("rejectionHandled",b,undefined,this)};L.prototype._setReturnedNonUndefined=function(){this._bitField=this._bitField|268435456};L.prototype._returnedNonUndefined=function(){return(this._bitField&268435456)!==0};L.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var ai=this._settledValue();this._setUnhandledRejectionIsNotified();G("unhandledRejection",X,ai,this)}};L.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=this._bitField|262144};L.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=this._bitField&(~262144)};L.prototype._isUnhandledRejectionNotified=function(){return(this._bitField&262144)>0};L.prototype._setRejectionIsUnhandled=function(){this._bitField=this._bitField|1048576};L.prototype._unsetRejectionIsUnhandled=function(){this._bitField=this._bitField&(~1048576);if(this._isUnhandledRejectionNotified()){this._unsetUnhandledRejectionIsNotified();this._notifyUnhandledRejectionIsHandled()}};L.prototype._isRejectionUnhandled=function(){return(this._bitField&1048576)>0};L.prototype._warn=function(aj,ai,ak){return t(aj,ai,ak||this)};L.onPossiblyUnhandledRejection=function(ai){var aj=Y();X=typeof ai==="function"?(aj===null?ai:o.domainBind(aj,ai)):undefined};L.onUnhandledRejectionHandled=function(ai){var aj=Y();b=typeof ai==="function"?(aj===null?ai:o.domainBind(aj,ai)):undefined};var K=function(){};L.longStackTraces=function(){if(N.haveItemsQueued()&&!M.longStackTraces){throw new Error("cannot enable long stack traces after promises have been created\u000a\u000a    See http://goo.gl/MqrFmX\u000a")}if(!M.longStackTraces&&p()){var aj=L.prototype._captureStackTrace;var ai=L.prototype._attachExtraTrace;M.longStackTraces=true;K=function(){if(N.haveItemsQueued()&&!M.longStackTraces){throw new Error("cannot enable long stack traces after promises have been created\u000a\u000a    See http://goo.gl/MqrFmX\u000a")}L.prototype._captureStackTrace=aj;L.prototype._attachExtraTrace=ai;Z.deactivateLongStackTraces();N.enableTrampoline();M.longStackTraces=false};L.prototype._captureStackTrace=h;L.prototype._attachExtraTrace=W;Z.activateLongStackTraces();N.disableTrampolineIfNecessary()}};L.hasLongStackTraces=function(){return M.longStackTraces&&p()};var l=(function(){try{if(typeof CustomEvent==="function"){var ai=new CustomEvent("CustomEvent");o.global.dispatchEvent(ai);return function(ak,am){var al=new CustomEvent(ak.toLowerCase(),{detail:am,cancelable:true});return !o.global.dispatchEvent(al)}}else{if(typeof Event==="function"){var ai=new Event("CustomEvent");o.global.dispatchEvent(ai);return function(ak,am){var al=new Event(ak.toLowerCase(),{cancelable:true});al.detail=am;return !o.global.dispatchEvent(al)}}else{var ai=document.createEvent("CustomEvent");ai.initCustomEvent("testingtheevent",false,true,{});o.global.dispatchEvent(ai);return function(ak,am){var al=document.createEvent("CustomEvent");al.initCustomEvent(ak.toLowerCase(),false,true,am);return !o.global.dispatchEvent(al)}}}}catch(aj){}return function(){return false}})();var y=(function(){if(o.isNode){return function(){return process.emit.apply(process,arguments)}}else{if(!o.global){return function(){return false}}return function(aj){var ai="on"+aj.toLowerCase();var ak=o.global[ai];if(!ak){return false}ak.apply(o.global,[].slice.call(arguments,1));return true}}})();function a(ai,aj){return{promise:aj}}var E={promiseCreated:a,promiseFulfilled:a,promiseRejected:a,promiseResolved:a,promiseCancelled:a,promiseChained:function(ai,aj,ak){return{promise:aj,child:ak}},warning:function(ai,aj){return{warning:aj}},unhandledRejection:function(ai,aj,ak){return{reason:aj,promise:ak}},rejectionHandled:a};var m=function(aj){var ak=false;try{ak=y.apply(null,arguments)}catch(al){N.throwLater(al);ak=true}var ai=false;try{ai=l(aj,E[aj].apply(null,arguments))}catch(al){N.throwLater(al);ai=true}return ai||ak};L.config=function(aj){aj=Object(aj);if("longStackTraces" in aj){if(aj.longStackTraces){L.longStackTraces()}else{if(!aj.longStackTraces&&L.hasLongStackTraces()){K()}}}if("warnings" in aj){var ai=aj.warnings;M.warnings=!!ai;g=M.warnings;if(o.isObject(ai)){if("wForgottenReturn" in ai){g=!!ai.wForgottenReturn}}}if("cancellation" in aj&&aj.cancellation&&!M.cancellation){if(N.haveItemsQueued()){throw new Error("cannot enable cancellation after promises are in use")}L.prototype._clearCancellationData=I;L.prototype._propagateFrom=S;L.prototype._onCancel=x;L.prototype._setOnCancel=V;L.prototype._attachCancellationCallback=ac;L.prototype._execute=ae;R=S;M.cancellation=true}if("monitoring" in aj){if(aj.monitoring&&!M.monitoring){M.monitoring=true;L.prototype._fireEvent=m}else{if(!aj.monitoring&&M.monitoring){M.monitoring=false;L.prototype._fireEvent=Q}}}return L};function Q(){return false}L.prototype._fireEvent=Q;L.prototype._execute=function(al,aj,ai){try{al(aj,ai)}catch(ak){return ak}};L.prototype._onCancel=function(){};L.prototype._setOnCancel=function(ai){};L.prototype._attachCancellationCallback=function(ai){};L.prototype._captureStackTrace=function(){};L.prototype._attachExtraTrace=function(){};L.prototype._clearCancellationData=function(){};L.prototype._propagateFrom=function(aj,ai){};function ae(am,aj,ai){var al=this;try{am(aj,ai,function(an){if(typeof an!=="function"){throw new TypeError("onCancel must be a function, got: "+o.toString(an))}al._attachCancellationCallback(an)})}catch(ak){return ak}}function ac(aj){if(!this._isCancellable()){return this}var ai=this._onCancel();if(ai!==undefined){if(o.isArray(ai)){ai.push(aj)}else{this._setOnCancel([ai,aj])}}else{this._setOnCancel(aj)}}function x(){return this._onCancelField}function V(ai){this._onCancelField=ai}function I(){this._cancellationParent=undefined;this._onCancelField=undefined}function S(ak,ai){if((ai&1)!==0){this._cancellationParent=ak;var aj=ak._branchesRemainingToCancel;if(aj===undefined){aj=0}ak._branchesRemainingToCancel=aj+1}if((ai&2)!==0&&ak._isBound()){this._setBoundTo(ak._boundTo)}}function s(aj,ai){if((ai&2)!==0&&aj._isBound()){this._setBoundTo(aj._boundTo)}}var R=s;function H(){var ai=this._boundTo;if(ai!==undefined){if(ai instanceof L){if(ai.isFulfilled()){return ai.value()}else{return undefined}}}return ai}function h(){this._trace=new e(this._peekContext())}function W(ak,ai){if(i(ak)){var al=this._trace;if(al!==undefined){if(ai){al=al._parent}}if(al!==undefined){al.attachExtraTrace(ak)}else{if(!ak.__stackCleaned__){var aj=ab(ak);o.notEnumerableProp(ak,"stack",aj.message+"\n"+aj.stack.join("\n"));o.notEnumerableProp(ak,"__stackCleaned__",true)}}}}function aa(aj,at,ak,aw,au){if(aj===undefined&&at!==null&&g){if(au!==undefined&&au._returnedNonUndefined()){return}if((aw._bitField&65535)===0){return}if(ak){ak=ak+" "}var an="";var aq="";if(at._trace){var ai=at._trace.stack.split("\n");var ar=O(ai);for(var ap=ar.length-1;ap>=0;--ap){var av=ar[ap];if(!z.test(av)){var ao=av.match(ad);if(ao){an="at "+ao[1]+":"+ao[2]+":"+ao[3]+" "}break}}if(ar.length>0){var al=ar[0];for(var ap=0;ap<ai.length;++ap){if(ai[ap]===al){if(ap>0){aq="\n"+ai[ap-1]}break}}}}var am="a promise was created in a "+ak+"handler "+an+"but was not returned from it, see http://goo.gl/rRqMUw"+aq;aw._warn(am,true,at)}}function u(ai,aj){var ak=ai+" is deprecated and will be removed in a future version.";if(aj){ak+=" Use "+aj+" instead."}return t(ak)}function t(am,ak,an){if(!M.warnings){return}var al=new k(am);var ai;if(ak){an._attachExtraTrace(al)}else{if(M.longStackTraces&&(ai=L._peekContext())){ai.attachExtraTrace(al)}else{var aj=ab(al);al.stack=aj.message+"\n"+aj.stack.join("\n")}}if(!m("warning",al)){v(al,"",true)}}function ah(ak,aj){for(var ai=0;ai<aj.length-1;++ai){aj[ai].push("From previous event:");aj[ai]=aj[ai].join("\n")}if(ai<aj.length){aj[ai]=aj[ai].join("\n")}return ak+"\n"+aj.join("\n")}function C(aj){for(var ai=0;ai<aj.length;++ai){if(aj[ai].length===0||((ai+1<aj.length)&&aj[ai][0]===aj[ai+1][0])){aj.splice(ai,1);ai--}}}function r(ai){var an=ai[0];for(var am=1;am<ai.length;++am){var aj=ai[am];var ak=an.length-1;var ao=an[ak];var ap=-1;for(var al=aj.length-1;al>=0;--al){if(aj[al]===ao){ap=al;break}}for(var al=ap;al>=0;--al){var aq=aj[al];if(an[ak]===aq){an.pop();ak--}else{break}}an=aj}}function O(ai){var al=[];for(var am=0;am<ai.length;++am){var ak=ai[am];var aj="    (No stack trace)"===ak||P.test(ak);var an=aj&&A(ak);if(aj&&!an){if(D&&ak.charAt(0)!==" "){ak="    "+ak}al.push(ak)}}return al}function B(ak){var ai=ak.stack.replace(/\s+$/g,"").split("\n");for(var al=0;al<ai.length;++al){var aj=ai[al];if("    (No stack trace)"===aj||P.test(aj)){break}}if(al>0&&ak.name!="SyntaxError"){ai=ai.slice(al)}return ai}function ab(aj){var ai=aj.stack;var ak=aj.toString();ai=typeof ai==="string"&&ai.length>0?B(aj):["    (No stack trace)"];return{message:ak,stack:aj.name=="SyntaxError"?ai:O(ai)}}function v(ak,am,aj){if(typeof console!=="undefined"){var al;if(o.isObject(ak)){var ai=ak.stack;al=am+d(ai,ak)}else{al=am+String(ak)}if(typeof af==="function"){af(al,aj)}else{if(typeof console.log==="function"||typeof console.log==="object"){console.log(al)}}}}function G(ai,am,ak,al){var an=false;try{if(typeof am==="function"){an=true;if(ai==="rejectionHandled"){am(al)}else{am(ak,al)}}}catch(aj){N.throwLater(aj)}if(ai==="unhandledRejection"){if(!m(ai,ak,al)&&!an){v(ak,"Unhandled rejection ")}}else{m(ai,al)}}function q(al){var am;if(typeof al==="function"){am="[function "+(al.name||"anonymous")+"]"}else{am=al&&typeof al.toString==="function"?al.toString():o.toString(al);var aj=/\[object [a-zA-Z0-9$_]+\]/;if(aj.test(am)){try{var ai=JSON.stringify(al);am=ai}catch(ak){}}if(am.length===0){am="(empty array)"}}return("(<"+c(am)+">, no stack trace)")}function c(aj){var ai=41;if(aj.length<ai){return aj}return aj.substr(0,ai-3)+"..."}function p(){return typeof T==="function"}var A=function(){return false};var f=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;function F(ai){var aj=ai.match(f);if(aj){return{fileName:aj[1],line:parseInt(aj[2],10)}}}function w(ao,al){if(!p()){return}var aj=ao.stack.split("\n");var an=al.stack.split("\n");var ai=-1;var am=-1;var aq;var ap;for(var ak=0;ak<aj.length;++ak){var ar=F(aj[ak]);if(ar){aq=ar.fileName;ai=ar.line;break}}for(var ak=0;ak<an.length;++ak){var ar=F(an[ak]);if(ar){ap=ar.fileName;am=ar.line;break}}if(ai<0||am<0||!aq||!ap||aq!==ap||ai>=am){return}A=function(at){if(ag.test(at)){return true}var au=F(at);if(au){if(au.fileName===aq&&(ai<=au.line&&au.line<=am)){return true}}return false}}function e(ai){this._parent=ai;this._promisesCreated=0;var aj=this._length=1+(ai===undefined?0:ai._length);T(this,e);if(aj>32){this.uncycle()}}o.inherits(e,Error);Z.CapturedTrace=e;e.prototype.uncycle=function(){var aj=this._length;if(aj<2){return}var ai=[];var at={};for(var an=0,ak=this;ak!==undefined;++an){ai.push(ak);ak=ak._parent}aj=this._length=an;for(var an=aj-1;an>=0;--an){var aq=ai[an].stack;if(at[aq]===undefined){at[aq]=an}}for(var an=0;an<aj;++an){var ar=ai[an].stack;var ao=at[ar];if(ao!==undefined&&ao!==an){if(ao>0){ai[ao-1]._parent=undefined;ai[ao-1]._length=1}ai[an]._parent=undefined;ai[an]._length=1;var al=an>0?ai[an-1]:this;if(ao<aj-1){al._parent=ai[ao+1];al._parent.uncycle();al._length=al._parent._length+1}else{al._parent=undefined;al._length=1}var ap=al._length+1;for(var am=an-2;am>=0;--am){ai[am]._length=ap;ap++}return}}};e.prototype.attachExtraTrace=function(aj){if(aj.__stackCleaned__){return}this.uncycle();var ai=ab(aj);var al=ai.message;var ak=[ai.stack];var am=this;while(am!==undefined){ak.push(O(am.stack.split("\n")));am=am._parent}r(ak);C(ak);o.notEnumerableProp(aj,"stack",ah(al,ak));o.notEnumerableProp(aj,"__stackCleaned__",true)};var T=(function n(){var am=/^\s*at\s*/;var ak=function(ao,ap){if(typeof ao==="string"){return ao}if(ap.name!==undefined&&ap.message!==undefined){return ap.toString()}return q(ap)};if(typeof Error.stackTraceLimit==="number"&&typeof Error.captureStackTrace==="function"){Error.stackTraceLimit+=6;P=am;d=ak;var ai=Error.captureStackTrace;A=function(ao){return ag.test(ao)};return function(ap,ao){Error.stackTraceLimit+=6;ai(ap,ao);Error.stackTraceLimit-=6}}var aj=new Error();if(typeof aj.stack==="string"&&aj.stack.split("\n")[0].indexOf("stackDetection@")>=0){P=/@/;d=ak;D=true;return function ai(ao){ao.stack=new Error().stack}}var al;try{throw new Error()}catch(an){al=("stack" in an)}if(!("stack" in aj)&&al&&typeof Error.stackTraceLimit==="number"){P=am;d=ak;return function ai(ap){Error.stackTraceLimit+=6;try{throw new Error()}catch(ao){ap.stack=ao.stack}Error.stackTraceLimit-=6}}d=function(ao,ap){if(typeof ao==="string"){return ao}if((typeof ap==="object"||typeof ap==="function")&&ap.name!==undefined&&ap.message!==undefined){return ap.toString()}return q(ap)};return null})([]);if(typeof console!=="undefined"&&typeof console.warn!=="undefined"){af=function(ai){console.warn(ai)};if(o.isNode&&process.stderr.isTTY){af=function(ak,aj){var ai=aj?"\u001b[33m":"\u001b[31m";console.warn(ai+ak+"\u001b[0m\n")}}else{if(!o.isNode&&typeof(new Error().stack)==="string"){af=function(aj,ai){console.warn("%c"+aj,ai?"color: darkorange":"color: red")}}}}var M={warnings:U,longStackTraces:false,cancellation:false,monitoring:false};if(J){L.longStackTraces()}return{longStackTraces:function(){return M.longStackTraces},warnings:function(){return M.warnings},cancellation:function(){return M.cancellation},monitoring:function(){return M.monitoring},propagateFromFunction:function(){return R},boundValueFunction:function(){return H},checkForgottenReturns:aa,setBounds:w,warn:t,deprecated:u,CapturedTrace:e,fireDomEvent:l,fireGlobalEvent:y}};