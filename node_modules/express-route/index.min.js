"use strict";var fs=require("fs"),path=require("path"),util=require("util"),EventEmitter=require("events").EventEmitter;function returnTrue(){return true}function assertExt(b,a){return path.extname(b)===a}function Router(b,c,a){if(!b){throw new Error("The first parameter must be an express application.")}a||(a={});if(typeof a.ensureRestriction!=="function"){a.ensureRestriction=returnTrue}if(!Array.isArray(a.ext)){if(a.ext){a.ext=[a.ext]}else{a.ext=[".js"]}}if(typeof a.sync!=="boolean"){a.sync=true}this.app=b;this.dirPath=c;this.settings=a;this.reads=0;EventEmitter.call(this)}util.inherits(Router,EventEmitter);var proto=Router.prototype;function statSync(c,b){var a=fs.statSync(c);b(null,a)}function readdirSync(c,a){var b=fs.readdirSync(c);a(null,b)}proto.readdirWithRoutes=function readdirWithRoutes(e){var a=this,d=a.settings.sync,c=d?statSync:fs.stat,b=d?readdirSync:fs.readdir;a.reads+=1;c(e,function(g,f){if(g){throw g}a.reads-=1;if(f.isDirectory()){a.reads+=1;b(e,function(i,h){if(i){throw i}a.reads+=h.length-1;h.forEach(function(j){c(path.join(e,j),function(l,k){if(l){throw l}a.reads-=1;if(k.isDirectory()){a.readdirWithRoutes(path.resolve(e,j))}else{if(a.settings.ext.some(function(m){return assertExt(j,m)})){a.applyRoutes(require(path.resolve("./",e,j)))}}})})})}else{a.applyRoutes(require(path.resolve("./",e)))}})};proto.applyRoutes=function applyRoutes(c){var a=this,d,b;for(b in c){if(!c.hasOwnProperty(b)){continue}d=c[b];if(Array.isArray(d)){d.forEach(function(e){a.applyRoute(b,e)})}else{a.applyRoute(b,d)}}if(a.reads===0){this.emit("loaded")}};proto.applyRoute=function applyRoute(b,d){var a=this,c;if(typeof d==="function"){a.app.get(b,d)}else{if(typeof d.fn==="function"){c=d.methods&&Array.isArray(d.methods)?d.methods:["get"];c.forEach(function(e){if(d.restricted){a.app[e](b,a.settings.ensureRestriction,d.fn)}else{if(d){a.app[e](b,d.fn)}}})}else{throw new Error("Wrong definition of the route. It must be a function or a object with `fn` property.")}}};function route(d,b,c){var a=new Router(d,b,c);a.readdirWithRoutes(b);return a}route.Router=Router;module.exports=route;