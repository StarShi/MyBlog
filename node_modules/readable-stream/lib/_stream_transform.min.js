"use strict";module.exports=Transform;var Duplex=require("./_stream_duplex");var util=require("core-util-is");util.inherits=require("inherits");util.inherits(Transform,Duplex);function TransformState(a){this.afterTransform=function(c,b){return afterTransform(a,c,b)};this.needTransform=false;this.transforming=false;this.writecb=null;this.writechunk=null;this.writeencoding=null}function afterTransform(e,f,d){var c=e._transformState;c.transforming=false;var a=c.writecb;if(!a){return e.emit("error",new Error("write callback called multiple times"))}c.writechunk=null;c.writecb=null;if(d!==null&&d!==undefined){e.push(d)}a(f);var b=e._readableState;b.reading=false;if(b.needReadable||b.length<b.highWaterMark){e._read(b.highWaterMark)}}function Transform(a){if(!(this instanceof Transform)){return new Transform(a)}Duplex.call(this,a);this._transformState=new TransformState(this);var b=this;this._readableState.needReadable=true;this._readableState.sync=false;if(a){if(typeof a.transform==="function"){this._transform=a.transform}if(typeof a.flush==="function"){this._flush=a.flush}}this.once("prefinish",function(){if(typeof this._flush==="function"){this._flush(function(d,c){done(b,d,c)})}else{done(b)}})}Transform.prototype.push=function(a,b){this._transformState.needTransform=false;return Duplex.prototype.push.call(this,a,b)};Transform.prototype._transform=function(b,c,a){throw new Error("_transform() is not implemented")};Transform.prototype._write=function(c,e,a){var d=this._transformState;d.writecb=a;d.writechunk=c;d.writeencoding=e;if(!d.transforming){var b=this._readableState;if(d.needTransform||b.needReadable||b.length<b.highWaterMark){this._read(b.highWaterMark)}}};Transform.prototype._read=function(b){var a=this._transformState;if(a.writechunk!==null&&a.writecb&&!a.transforming){a.transforming=true;this._transform(a.writechunk,a.writeencoding,a.afterTransform)}else{a.needTransform=true}};Transform.prototype._destroy=function(b,a){var c=this;Duplex.prototype._destroy.call(this,b,function(d){a(d);c.emit("close")})};function done(d,e,c){if(e){return d.emit("error",e)}if(c!==null&&c!==undefined){d.push(c)}var a=d._writableState;var b=d._transformState;if(a.length){throw new Error("Calling transform done when ws.length != 0")}if(b.transforming){throw new Error("Calling transform done when still transforming")}return d.push(null)};