/*!
 * finalhandler
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var debug=require("debug")("finalhandler");var encodeUrl=require("encodeurl");var escapeHtml=require("escape-html");var onFinished=require("on-finished");var parseUrl=require("parseurl");var statuses=require("statuses");var unpipe=require("unpipe");var DOUBLE_SPACE_REGEXP=/\x20{2}/g;var NEWLINE_REGEXP=/\n/g;var defer=typeof setImmediate==="function"?setImmediate:function(a){process.nextTick(a.bind.apply(a,arguments))};var isFinished=onFinished.isFinished;function createHtmlDocument(b){var a=escapeHtml(b).replace(NEWLINE_REGEXP,"<br>").replace(DOUBLE_SPACE_REGEXP," &nbsp;");return'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>Error</title>\n</head>\n<body>\n<pre>'+a+"</pre>\n</body>\n</html>\n"}module.exports=finalhandler;function finalhandler(f,c,b){var e=b||{};var d=e.env||process.env.NODE_ENV||"development";var a=e.onerror;return function(h){var j;var i;var g;if(!h&&headersSent(c)){debug("cannot 404 after headers sent");return}if(h){g=getErrorStatusCode(h);if(g!==undefined){j=getErrorHeaders(h)}if(g===undefined){g=getResponseStatusCode(c)}i=getErrorMessage(h,g,d)}else{g=404;i="Cannot "+f.method+" "+encodeUrl(parseUrl.original(f).pathname)}debug("default %s",g);if(h&&a){defer(a,h,f,c)}if(headersSent(c)){debug("cannot %d after headers sent",g);f.socket.destroy();return}send(f,c,g,j,i)}}function getErrorHeaders(d){if(!d.headers||typeof d.headers!=="object"){return undefined}var e=Object.create(null);var c=Object.keys(d.headers);for(var b=0;b<c.length;b++){var a=c[b];e[a]=d.headers[a]}return e}function getErrorMessage(c,a,b){var d;if(b!=="production"){d=c.stack;if(!d&&typeof c.toString==="function"){d=c.toString()}}return d||statuses[a]}function getErrorStatusCode(a){if(typeof a.status==="number"&&a.status>=400&&a.status<600){return a.status}if(typeof a.statusCode==="number"&&a.statusCode>=400&&a.statusCode<600){return a.statusCode}return undefined}function getResponseStatusCode(b){var a=b.statusCode;if(typeof a!=="number"||a<400||a>599){a=500}return a}function headersSent(a){return typeof a.headersSent!=="boolean"?Boolean(a._header):a.headersSent}function send(e,b,a,f,d){function c(){var g=createHtmlDocument(d);b.statusCode=a;b.statusMessage=statuses[a];setHeaders(b,f);b.setHeader("Content-Security-Policy","default-src 'self'");b.setHeader("X-Content-Type-Options","nosniff");b.setHeader("Content-Type","text/html; charset=utf-8");b.setHeader("Content-Length",Buffer.byteLength(g,"utf8"));if(e.method==="HEAD"){b.end();return}b.end(g,"utf8")}if(isFinished(e)){c();return}unpipe(e);onFinished(e,c);e.resume()}function setHeaders(c,e){if(!e){return}var d=Object.keys(e);for(var b=0;b<d.length;b++){var a=d[b];c.setHeader(a,e[a])}};